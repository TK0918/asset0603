<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>全账户收款明细</title>
  <style>
    :root { --primary:#2563eb; --bg:#f8fafc; --card:#ffffff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; }
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Helvetica Neue",sans-serif; background:var(--bg); color:var(--text); }
    header { background: white; box-shadow: 0 2px 10px rgba(0,0,0,.1); position: sticky; top:0; z-index:1000; }
    .header-content { display:flex; justify-content:space-between; align-items:center; padding:15px 30px; }
    .logo { font-size:24px; font-weight:700; color:#2563eb; text-decoration:none; }
    .nav-menu { display:flex; list-style:none; gap:30px; }
    .nav-menu li a { text-decoration:none; color:#64748b; font-weight:500; padding:10px 15px; border-radius:8px; }
    .nav-menu li a:hover, .nav-menu li a.active { color:#2563eb; background:rgba(37,99,235,.1); }
    .container { max-width:1400px; margin:24px auto; padding:0 16px; }
    .nav { display:flex; gap:12px; margin-bottom:16px; }
    .nav a { text-decoration:none; color:var(--primary); font-weight:600; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.04); }
    .card-header { padding:16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    .title { font-size:18px; font-weight:700; }
    .actions { display:flex; gap:8px; }
    .btn { padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:#fff; cursor:pointer; }
    .btn.primary { background:var(--primary); color:#fff; border-color:var(--primary); }

    /* 统一为交易明细页的搜索面板风格 */
    .filters { background:#fff; padding:25px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); margin-bottom:16px; display:grid; grid-template-columns:repeat(6,1fr); gap:12px; border:1px solid var(--border); }
    .field { display:flex; flex-direction:column; gap:6px; }
    .label { font-size:12px; color:var(--muted); }
    .input, .select { height:36px; padding:0 10px; border:1px solid var(--border); border-radius:8px; background:#fff; }

    /* 统一为交易明细页的表格容器风格 */
    .table-wrap { position:relative; overflow:auto; background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); border:1px solid var(--border); }
    table { width:100%; border-collapse:separate; border-spacing:0; min-width:1600px; }
    thead th { position:sticky; top:0; background:#f8fafc; z-index:2; text-align:left; font-size:12px; color:#374151; padding:12px 10px; border-bottom:1px solid var(--border); font-weight:600; }
    tbody td { padding:12px 10px; border-bottom:1px solid var(--border); font-size:12px; color:#374151; white-space:nowrap; }
    tr:hover { background:#f8fafc; }

    .tag { font-size:12px; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; }
    .state { font-size:12px; padding:2px 8px; border-radius:999px; }
    .state.unclaimed { background:#fff7ed; color:#c2410c; }
    .state.claimed { background:#ecfdf5; color:#065f46; }
    .state.excluded { background:#fee2e2; color:#991b1b; }

    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.4); z-index:2000; }
    .modal-inner { width:860px; max-width:95vw; background:#fff; border-radius:12px; overflow:auto; border:1px solid var(--border); max-height:90vh; z-index:2001; }
    .modal-header { padding:14px 16px; border-bottom:1px solid var(--border); font-weight:700; }
    .modal-body { padding:16px; display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .kv { display:flex; gap:8px; }
    .k { width:120px; color:#6b7280; font-size:12px; text-align:right; }
    .v { flex:1; font-size:13px; }
    .json { grid-column:1 / -1; background:#f8fafc; border:1px dashed var(--border); padding:10px; border-radius:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px; white-space:pre-wrap; }

    @media (max-width: 1100px){ .filters{ grid-template-columns:repeat(3,1fr);} .modal-body{ grid-template-columns:1fr; } }

    /* 预览弹窗样式 */
    .modal-actions { padding:12px 16px; border-top:1px solid var(--border); display:flex; gap:8px; justify-content:flex-end; }
    .preview-grid { padding:16px; }
    .stat { display:flex; gap:16px; margin-bottom:12px; color:#374151; font-size:13px; }
    .stat span { background:#f3f4f6; border:1px solid var(--border); padding:6px 10px; border-radius:8px; }
    .tbl-preview { width:100%; border-collapse:separate; border-spacing:0; min-width:900px; }
    .tbl-preview thead th { position:sticky; top:0; background:#f9fafb; z-index:2; text-align:left; font-size:12px; color:var(--muted); padding:10px; border-bottom:1px solid var(--border); }
    .tbl-preview tbody td { padding:8px 10px; border-bottom:1px solid var(--border); font-size:12px; }
    .status-ok { color:#065f46; background:#ecfdf5; padding:2px 8px; border-radius:999px; font-size:12px; }
    .status-err { color:#991b1b; background:#fee2e2; padding:2px 8px; border-radius:999px; font-size:12px; }
    .status-dup { color:#b45309; background:#fffbeb; padding:2px 8px; border-radius:999px; font-size:12px; }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <a href="index.html" class="logo">资金中台</a>
      <nav>
        <ul class="nav-menu">
          <li><a href="index.html">首页</a></li>
          <li><a href="customer-management.html">账户管理</a></li>
          <li><a href="transfer-audit.html">转账审核</a></li>
          <li><a href="account-config.html">收款账户</a></li>
          <li><a href="receiving-ledger.html" class="active">收款明细</a></li>
          <li><a href="transaction-details.html">交易明细</a></li>
          <li><a href="online-recharge.html">在线充值</a></li>
          <li><a href="credit-audit.html">信用额度</a></li>
          <li><a href="credit-bill.html">额度账单</a></li>
        </ul>
      </nav>
    </div>
  </header>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <div class="title">全账户收款明细</div>
        <div class="actions">
          <button class="btn" id="btnDownloadTpl">下载Excel模板</button>
          <button class="btn" id="btnUpload">手动上传Excel</button>
          <button class="btn primary" id="btnExport">导出当前结果</button>
        </div>
      </div>

      <div class="filters">
        <div class="field">
          <label class="label">支付平台（多选）</label>
          <select class="select" id="fPlatform" multiple>
            <option>PayPal</option>
            <option>Wise</option>
            <option>Airwallex</option>
            <option>Worldfirst</option>
            <option>Payoneer</option>
            <option>PingPong</option>
          </select>
        </div>
        <div class="field">
          <label class="label">账户别名</label>
          <input class="input" id="fAlias" placeholder="输入账户别名关键词" />
        </div>
        <div class="field">
          <label class="label">交易时间（起）</label>
          <input type="date" class="input" id="fStart" />
        </div>
        <div class="field">
          <label class="label">交易时间（止）</label>
          <input type="date" class="input" id="fEnd" />
        </div>
        <div class="field">
          <label class="label">交易ID</label>
          <input class="input" id="fTxId" placeholder="模糊搜索交易ID" />
        </div>
        <div class="field">
          <label class="label">交易金额(最小)</label>
          <input class="input" id="fAmtMin" placeholder="如 100" />
        </div>
        <div class="field">
          <label class="label">交易金额(最大)</label>
          <input class="input" id="fAmtMax" placeholder="如 50000" />
        </div>
        <div class="field">
          <label class="label">交易币种（多选）</label>
          <select class="select" id="fCcy" multiple>
            <option>USD</option>
            <option>EUR</option>
            <option>GBP</option>
            <option>CHF</option>
          </select>
        </div>
        <div class="field">
          <label class="label">认领状态</label>
          <select class="select" id="fClaim">
            <option value="">全部</option>
            <option value="unclaimed">待认领</option>
            <option value="claimed">已认领</option>
            <option value="locked">认领锁定</option>
          </select>
        </div>
        <div class="field">
          <label class="label">付款方信息</label>
          <input class="input" id="fPayer" placeholder="付款方名称/账号模糊" />
        </div>
      </div>

      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>支付平台</th>
              <th>账户别名</th>
              <th>交易ID</th>
              <th>交易时间（UTC +8）</th>
              <th>收款币种</th>
              <th>收款金额</th>
              <th>手续费</th>
              <th>付款方信息</th>
              <th>数据来源</th>
              <th>上传人员</th>
              <th>认领状态</th>
              <th>认领商户</th>
              <th>认领业务</th>
              <th>认领资金账户</th>
              <th>备注</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modal" id="modalDetail">
    <div class="modal-inner">
      <div class="modal-header">交易明细</div>
      <div class="modal-body">
        <div class="kv"><div class="k">平台</div><div class="v" id="dPlatform"></div></div>
        <div class="kv"><div class="k">账户</div><div class="v" id="dAccount"></div></div>
        <div class="kv"><div class="k">交易时间</div><div class="v" id="dTime"></div></div>
        <div class="kv"><div class="k">交易ID</div><div class="v" id="dTxId"></div></div>
        <div class="kv"><div class="k">对方</div><div class="v" id="dCounter"></div></div>
        <div class="kv"><div class="k">币种/金额</div><div class="v" id="dCcyAmt"></div></div>
        <div class="kv"><div class="k">手续费</div><div class="v" id="dFee"></div></div>
        <div class="kv"><div class="k">备注/附言</div><div class="v" id="dRef"></div></div>
        <div class="json" id="dRaw">{}</div>
      </div>
    </div>
  </div>

  <!-- 上传预览弹窗 -->
  <div class="modal" id="modalPreview">
    <div class="modal-inner" style="width:1000px;">
      <div class="modal-header">导入预览与校验结果</div>
      <div class="preview-grid">
        <div class="stat">
          <span id="statTotal">总计: 0</span>
          <span id="statOk">正常: 0</span>
          <span id="statErr">格式错误: 0</span>
          <span id="statDup">同平台同交易ID: 0</span>
        </div>
        <div class="table-wrap" style="max-height:50vh; overflow:auto; border:1px solid var(--border); border-radius:8px;">
          <table class="tbl-preview" id="tblPreview">
            <thead>
              <tr>
                <th>#</th>
                <th>支付平台代码</th>
                <th>账户别名</th>
                <th>交易ID</th>
                <th>交易时间</th>
                <th>收款币种</th>
                <th>收款金额</th>
                <th>手续费</th>
                <th>付款方信息</th>
                <th>状态</th>
                <th>说明</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" id="btnCancelImport">取消</button>
        <button class="btn primary" id="btnConfirmImport">确认导入（仅正常数据）</button>
      </div>
    </div>
  </div>

  <input type="file" id="fileInput" accept=".xls,.xlsx,.csv" style="display:none" />

  <script>
    // 示例数据结构按新表头设计
    let rows = [
      { id:1, platform:'PayPal', alias:'PayPal-NA#1', txId:'PP-987654', time:'2025-08-30 12:10', ccy:'USD', amount:1200.50, fee:23.1, payer:'john@example.com', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'INV-20250830' },
      { id:2, platform:'Wise', alias:'Wise-EU#1', txId:'UTR00921', time:'2025-08-28 20:00', ccy:'EUR', amount:3000.00, fee:0, payer:'IBAN **** 1234', source:'手动', uploader:'bob', claim:'已认领', claimMerchant:'US003', claimBusiness:'Advertising', claimAccount:'US003-ADV', remark:'Supplier payout' },
      { id:3, platform:'Airwallex', alias:'AWX-HK#1', txId:'AWX-7788', time:'2025-08-29 16:30', ccy:'USD', amount:520.00, fee:7.2, payer:'HSBC **** 9988', source:'API', uploader:'', claim:'认领锁定', claimMerchant:'US002', claimBusiness:'Fulfillment', claimAccount:'US002-FUL', remark:'订单#8891' },
      { id:4, platform:'Stripe', alias:'Stripe-US#2', txId:'ch_1ABCD', time:'2025-08-29 08:20', ccy:'USD', amount:520.00, fee:15.7, payer:'visa **** 4242', source:'API', uploader:'alice', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'Order#8891' },
      { id:5, platform:'Payoneer', alias:'Payo-EU#1', txId:'PNR-665544', time:'2025-08-27 10:05', ccy:'USD', amount:980.00, fee:3.5, payer:'jack@acme.com', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'INV-1001' },
      { id:6, platform:'PingPong', alias:'PPG-CN#1', txId:'PPG-998877', time:'2025-08-26 14:33', ccy:'USD', amount:1500.00, fee:5.0, payer:'ppg **** 3322', source:'手动', uploader:'carol', claim:'已认领', claimMerchant:'US001', claimBusiness:'Advertising', claimAccount:'US001-ADV', remark:'Settlement' },
      { id:7, platform:'Wise', alias:'Wise-UK#2', txId:'UTR00999', time:'2025-08-25 09:10', ccy:'GBP', amount:700.00, fee:0, payer:'IBAN **** 5678', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'REF-700' },
      { id:8, platform:'Worldfirst', alias:'WF-HK#1', txId:'WF-332211', time:'2025-08-24 19:45', ccy:'USD', amount:250.00, fee:1.2, payer:'HSBC **** 7788', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'-' },
      { id:9, platform:'Airwallex', alias:'AWX-AU#2', txId:'AWX-5522', time:'2025-08-24 07:30', ccy:'USD', amount:2100.00, fee:8.4, payer:'CBA **** 6677', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'PO-20250824' },
      { id:10, platform:'Stripe', alias:'Stripe-UK#1', txId:'ch_1ZZZZ', time:'2025-08-23 18:20', ccy:'GBP', amount:320.00, fee:9.6, payer:'visa **** 1111', source:'API', uploader:'', claim:'认领锁定', claimMerchant:'US004', claimBusiness:'Fulfillment', claimAccount:'US004-FUL', remark:'Hold for review' },
      { id:11, platform:'PayPal', alias:'PayPal-SG#2', txId:'PP-123123', time:'2025-08-22 11:11', ccy:'USD', amount:88.00, fee:0.9, payer:'buyer@shop.com', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'Gift' },
      { id:12, platform:'Payoneer', alias:'Payo-US#2', txId:'PNR-111222', time:'2025-08-21 09:00', ccy:'USD', amount:600.00, fee:2.5, payer:'john.doe', source:'手动', uploader:'dave', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'Invoice AUG' },
      { id:13, platform:'Wise', alias:'Wise-EU#3', txId:'UTR00111', time:'2025-08-20 10:10', ccy:'EUR', amount:120.00, fee:0, payer:'IBAN **** 0001', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'-' },
      { id:14, platform:'Airwallex', alias:'AWX-US#2', txId:'AWX-0099', time:'2025-08-19 15:00', ccy:'USD', amount:950.00, fee:4.2, payer:'CHASE **** 9988', source:'API', uploader:'', claim:'已认领', claimMerchant:'US005', claimBusiness:'Advertising', claimAccount:'US005-ADV', remark:'Campaign' },
      { id:15, platform:'PayPal', alias:'PayPal-NA#2', txId:'PP-888777', time:'2025-08-18 08:08', ccy:'USD', amount:45.60, fee:0.3, payer:'foo@bar.com', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'-' },
      { id:16, platform:'Worldfirst', alias:'WF-UK#2', txId:'WF-778899', time:'2025-08-17 20:20', ccy:'GBP', amount:1500.00, fee:6.0, payer:'Barclays **** 2323', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'PO-778899' },
      { id:17, platform:'PingPong', alias:'PPG-US#2', txId:'PPG-556677', time:'2025-08-16 12:12', ccy:'USD', amount:2300.00, fee:7.0, payer:'ppg **** 5566', source:'手动', uploader:'mike', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'refund adj' },
      { id:18, platform:'Stripe', alias:'Stripe-EU#3', txId:'ch_1TEST', time:'2025-08-15 14:30', ccy:'EUR', amount:75.00, fee:2.2, payer:'mc **** 5555', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'test charge' },
      { id:19, platform:'Payoneer', alias:'Payo-UK#3', txId:'PNR-333444', time:'2025-08-14 09:45', ccy:'USD', amount:420.00, fee:1.9, payer:'acme ltd', source:'API', uploader:'', claim:'认领锁定', claimMerchant:'US006', claimBusiness:'Fulfillment', claimAccount:'US006-FUL', remark:'Locking' },
      { id:20, platform:'Wise', alias:'Wise-SG#4', txId:'UTR00444', time:'2025-08-13 22:20', ccy:'CHF', amount:1300.00, fee:0, payer:'IBAN **** 2222', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'Swiss pay' }
    ];

    // 从 localStorage 加载，如无则初始化并保存
    (function initStorage(){
      try{
        const cached = localStorage.getItem('receivingLedgerRows');
        if(cached){ rows = JSON.parse(cached); }
        else { localStorage.setItem('receivingLedgerRows', JSON.stringify(rows)); }
      }catch(err){ /* ignore storage errors */ }
    })();

    // 页面滚动锁定工具
    const pageScroll = {
      lock(){ document.documentElement.style.overflow='hidden'; document.body.style.overflow='hidden'; },
      unlock(){ document.documentElement.style.overflow=''; document.body.style.overflow=''; }
    };

    const tbody = document.querySelector('#tbl tbody');
    function fmt(n){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
    function render(){
      tbody.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.platform}</td>
          <td>${r.alias}</td>
          <td>${r.txId}</td>
          <td>${r.time}</td>
          <td>${r.ccy}</td>
          <td>${fmt(r.amount)}</td>
          <td>${r.fee?fmt(r.fee):'-'}</td>
          <td>${r.payer||'-'}</td>
          <td><span class="tag">${r.source}</span></td>
          <td>${r.uploader||'-'}</td>
          <td>${r.claim}</td>
          <td>${r.claimMerchant||'-'}</td>
          <td>${r.claimBusiness||'-'}</td>
          <td>${r.claimAccount||'-'}</td>
          <td>${r.remark||'-'}</td>`;
        tbody.appendChild(tr);
      });
      try{ localStorage.setItem('receivingLedgerRows', JSON.stringify(rows)); }catch(err){}
    }

    // 点击行查看明细（示例：点击第三列交易ID）
    tbody.addEventListener('click', (e)=>{
      const cell = e.target.closest('td'); if(!cell) return;
      const tr = e.target.closest('tr');
      const idx = Array.from(tr.parentNode.children).indexOf(tr);
      const row = rows[idx];
      if(cell.cellIndex===2){ openDetail(row); }
    });

    function openDetail(row){
      document.getElementById('dPlatform').textContent = row.platform;
      document.getElementById('dAccount').textContent = row.alias;
      document.getElementById('dTime').textContent = row.time;
      document.getElementById('dTxId').textContent = row.txId||'-';
      document.getElementById('dCounter').textContent = row.payer||'-';
      document.getElementById('dCcyAmt').textContent = `${row.ccy} ${fmt(row.amount)}`;
      document.getElementById('dFee').textContent = row.fee?fmt(row.fee):'-';
      document.getElementById('dRef').textContent = row.remark||'-';
      document.getElementById('dRaw').textContent = JSON.stringify(row.raw,null,2);
      modal.style.display='flex';
      pageScroll.lock();
    }

    const modal = document.getElementById('modalDetail');
    modal.addEventListener('click', (e)=>{ if(e.target===modal){ modal.style.display='none'; pageScroll.unlock(); } });

    document.getElementById('btnUpload').addEventListener('click', ()=>document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change', onFileSelected);
    document.getElementById('btnDownloadTpl').addEventListener('click', ()=>{ window.location.href = 'shangchuanmuban.xlsx'; });
    document.getElementById('btnExport').addEventListener('click', ()=>{ alert('导出当前筛选结果（示例）'); });

    // 平台代码映射：将上传文档中的数字代码翻译为平台名称
    // 示例：2 → Stripe
    const platformCodes = { '1':'PayPal', '2':'Stripe', '3':'Wise', '4':'Airwallex', '5':'Payoneer', '6':'PingPong', '7':'Worldfirst' };
    const validCurrencies = ['USD','EUR','GBP','CHF'];

    const modalPreview = document.getElementById('modalPreview');
    const tblPreviewBody = document.querySelector('#tblPreview tbody');
    const statTotal = document.getElementById('statTotal');
    const statOk = document.getElementById('statOk');
    const statErr = document.getElementById('statErr');
    const statDup = document.getElementById('statDup');
    document.getElementById('btnCancelImport').addEventListener('click', ()=>{ modalPreview.style.display='none'; tblPreviewBody.innerHTML=''; pageScroll.unlock(); });
    document.getElementById('btnConfirmImport').addEventListener('click', confirmImport);
    modalPreview.addEventListener('click', (e)=>{ if(e.target===modalPreview){ modalPreview.style.display='none'; tblPreviewBody.innerHTML=''; pageScroll.unlock(); } });

    let previewData = [];

    async function onFileSelected(e){
      const file = e.target.files[0]; if(!file) return;
      // 大小校验 10MB
      const maxSize = 10 * 1024 * 1024;
      if(file.size > maxSize){ alert('文件大小超过10MB限制'); e.target.value=''; return; }
      const name = file.name.toLowerCase();
      const isCSV = name.endsWith('.csv');
      const isXLS = name.endsWith('.xls') || name.endsWith('.xlsx');
      if(!isCSV && !isXLS){ alert('仅支持 .xlsx、.csv、.xls'); e.target.value=''; return; }
      if(isCSV){
        const reader = new FileReader();
        reader.onload = () => {
          const text = reader.result;
          const rows = parseCSV(text);
          if(rows.length <= 1){ alert('文件内容为空或无有效数据'); return; }
          const dataRows = rows.slice(1); // 从第二行开始识别
          buildPreview(dataRows);
        };
        reader.readAsText(file, 'utf-8');
        return;
      }
      // Excel解析：动态加载xlsx库
      try{
        await ensureXLSX();
      }catch(err){ alert('加载Excel解析库失败'); return; }
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = new Uint8Array(reader.result);
          const wb = window.XLSX.read(data, { type: 'array' });
          const firstSheetName = wb.SheetNames[0];
          const ws = wb.Sheets[firstSheetName];
          const arr = window.XLSX.utils.sheet_to_json(ws, { header:1, raw:false });
          if(arr.length <= 1){ alert('文件内容为空或无有效数据'); return; }
          const dataRows = arr.slice(1); // 从第二行开始识别
          buildPreview(dataRows);
        }catch(err){
          alert('Excel解析失败，请检查文件格式');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // 动态加载xlsx库（SheetJS）
    function ensureXLSX(){
      return new Promise((resolve,reject)=>{
        if(window.XLSX){ resolve(); return; }
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
        s.onload = ()=>resolve();
        s.onerror = ()=>reject(new Error('load xlsx failed'));
        document.head.appendChild(s);
      });
    }

    function parseCSV(text){
      // 简易CSV解析（不处理复杂嵌套引号场景）
      return text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.trim().length>0).map(line=>{
        const parts = [];
        let cur = '', inQuotes = false;
        for(let i=0;i<line.length;i++){
          const ch = line[i];
          if(ch==='"'){
            if(inQuotes && line[i+1]==='"'){ cur += '"'; i++; }
            else { inQuotes = !inQuotes; }
          } else if(ch===',' && !inQuotes){
            parts.push(cur); cur='';
          } else { cur += ch; }
        }
        parts.push(cur);
        return parts;
      });
    }

    function trimSafe(v){ return (v||'').trim(); }

    // 期望列（模板）：platformCode, alias, txId, time, ccy, amount, fee, payer
    function buildPreview(dataRows){
      tblPreviewBody.innerHTML='';
      previewData = [];
      let ok=0, err=0, dup=0;
      // 现有去重基线：平台名称+交易ID
      const existingKey = new Set(rows.map(r=>`${r.platform}||${(r.txId||'').toUpperCase()}`));
      const batchKey = new Set();
      dataRows.forEach((cols, idx)=>{
        const [platformCodeRaw, aliasRaw, txIdRaw, timeRaw, ccyRaw, amountRaw, feeRaw, payerRaw] = cols;
        const platformCode = trimSafe(platformCodeRaw);
        const alias = trimSafe(aliasRaw);
        const txId = trimSafe(txIdRaw);
        const time = trimSafe(timeRaw);
        const ccy = trimSafe(ccyRaw);
        const amount = Number(trimSafe(amountRaw).replace(/,/g,''));
        const fee = amountRaw!==undefined && feeRaw!==undefined && trimSafe(feeRaw) !== '' ? Number(trimSafe(feeRaw).replace(/,/g,'')) : 0;
        const payer = trimSafe(payerRaw);

        let status = 'ok';
        let reason = '';

        // 基础校验
        if(!platformCode || !(platformCode in platformCodes)){
          status = 'err'; reason = '支付平台代码无效（示例：2→Stripe）';
        }
        if(!txId){ status='err'; reason = joinReason(reason,'交易ID为空'); }
        // 去空格已处理
        if(ccy && !validCurrencies.includes(ccy.toUpperCase())){
          status='err'; reason = joinReason(reason,'收款币种无效（USD/EUR/GBP/CHF）');
        }
        if(isNaN(amount)){ status='err'; reason = joinReason(reason,'收款金额无效'); }
        if(fee!==0 && isNaN(fee)){ status='err'; reason = joinReason(reason,'手续费无效'); }

        // 同平台同交易ID重复（与现有/本次）
        const platformName = platformCodes[platformCode] || platformCode;
        const key = `${platformName}||${txId.toUpperCase()}`;
        if(status==='ok'){
          if(existingKey.has(key) || batchKey.has(key)){
            status='dup'; reason='同平台同交易ID重复';
          }
        }

        if(status==='ok'){ ok++; batchKey.add(key); }
        else if(status==='dup'){ dup++; }
        else { err++; }

        previewData.push({ platformCode, platformName, alias, txId, time, ccy: ccy.toUpperCase(), amount, fee, payer, status, reason });

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+2}</td>
          <td>${platformCode}</td>
          <td>${alias||'-'}</td>
          <td>${txId||'-'}</td>
          <td>${time||'-'}</td>
          <td>${ccy||'-'}</td>
          <td>${isNaN(amount)?'-':fmt(amount)}</td>
          <td>${isNaN(fee)?'-':fmt(fee)}</td>
          <td>${payer||'-'}</td>
          <td>${statusLabel(status)}</td>
          <td>${reason||'-'}</td>`;
        tblPreviewBody.appendChild(tr);
      });

      statTotal.textContent = `总计: ${previewData.length}`;
      statOk.textContent = `正常: ${ok}`;
      statErr.textContent = `格式错误: ${err}`;
      statDup.textContent = `同平台同交易ID: ${dup}`;
      modalPreview.style.display='flex';
      pageScroll.lock();
    }

    function statusLabel(status){
      if(status==='ok') return `<span class="status-ok">正常</span>`;
      if(status==='dup') return `<span class="status-dup">同平台同交易ID</span>`;
      return `<span class="status-err">格式错误</span>`;
    }

    function joinReason(a,b){ return a? (a+'；'+b) : b; }

    function confirmImport(){
      const okList = previewData.filter(x=>x.status==='ok');
      if(okList.length===0){ alert('没有可导入的数据'); return; }
      const nextId = rows.length ? Math.max(...rows.map(r=>r.id))+1 : 1;
      let idCounter = nextId;
      okList.forEach(item=>{
        rows.push({
          id: idCounter++,
          platform: item.platformName,
          alias: item.alias || '-',
          txId: item.txId,
          time: item.time || '-',
          ccy: (item.ccy||'').toUpperCase(),
          amount: Number(item.amount)||0,
          fee: Number(item.fee)||0,
          payer: item.payer || '-',
          source: '手动',
          uploader: '-',
          claim: '待认领',
          claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'-'
        });
      });
      render();
      modalPreview.style.display='none';
      tblPreviewBody.innerHTML='';
      alert(`导入完成：成功 ${okList.length} 条`);
      pageScroll.unlock();
    }

    render();
  </script>
</body>
</html>
