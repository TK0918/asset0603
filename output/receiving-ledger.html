<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>全账户收款明细</title>
  <style>
    :root { --primary:#2563eb; --bg:#f8fafc; --card:#ffffff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; }
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Helvetica Neue",sans-serif; background:var(--bg); color:var(--text); }
    header { background: white; box-shadow: 0 2px 10px rgba(0,0,0,.1); position: sticky; top:0; z-index:1000; }
    .header-content { display:flex; justify-content:space-between; align-items:center; padding:15px 30px; }
    .logo { font-size:24px; font-weight:700; color:#2563eb; text-decoration:none; }
    .nav-menu { display:flex; list-style:none; gap:30px; }
    .nav-menu li { position:relative; }
    .nav-menu li a { text-decoration:none; color:#64748b; font-weight:500; padding:10px 15px; border-radius:8px; display:block; }
    .nav-menu li a:hover, .nav-menu li a.active { color:#2563eb; background:rgba(37,99,235,.1); }
    /* 下拉菜单样式 */
    .dropdown { position:relative; }
    .dropdown-content { display:none; position:absolute; top:100%; left:0; background:white; min-width:200px; box-shadow:0 4px 12px rgba(0,0,0,.15); border-radius:8px; z-index:1000; padding:8px 0; border:1px solid #e2e8f0; }
    .dropdown:hover .dropdown-content { display:block; }
    .dropdown-content a { padding:12px 20px; display:block; border-radius:0; font-size:14px; }
    .dropdown-content a:hover { background:rgba(37,99,235,.1); color:#2563eb; }

    /* Page Header */
    .page-header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
      border-left: 4px solid #2563eb;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 10px;
    }

    .page-description {
      color: #64748b;
      font-size: 16px;
    }

    .container { max-width:1400px; margin:24px auto; padding:0 16px; }
    .nav { display:flex; gap:12px; margin-bottom:16px; }
    .nav a { text-decoration:none; color:var(--primary); font-weight:600; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.04); }
    .card-header { padding:16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    .title { font-size:18px; font-weight:700; }
    .actions { display:flex; gap:8px; }
    .btn { 
      padding: 12px 24px; 
      border: none; 
      border-radius: 8px; 
      font-weight: 500; 
      cursor: pointer; 
      transition: all 0.3s ease; 
      font-size: 14px; 
      text-decoration: none; 
      display: inline-block; 
      text-align: center; 
    }
    .btn-primary { background: #2563eb; color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: #6b7280; color: white; }
    .btn-secondary:hover { background: #4b5563; }
    .btn-danger { background: #dc2626; color: white; }
    .btn-danger:hover { background: #b91c1c; }
    .btn-small { padding: 4px 8px; font-size: 11px; border-radius: 4px; }

    /* 搜索区域样式 - 参考转账审核页面 */
    .search-section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 25px;
    }

    .search-row {
      display: flex;
      gap: 20px;
      align-items: end;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .search-group {
      flex: 1;
      min-width: 150px;
      max-width: 200px;
    }

    .search-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: #2563eb;
    }

    /* 表格容器样式 - 参考转账审核页面 */
    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 25px;
      border-bottom: 1px solid #e2e8f0;
    }

    .table-title {
      font-size: 20px;
      font-weight: 600;
      color: #1e293b;
    }

    .table-actions {
      display: flex;
      gap: 10px;
    }

    .table-wrapper {
      overflow-x: auto;
      position: relative;
    }

    /* 分页样式 */
    .pagination-controls { display:flex; align-items:center; gap:8px; }
    .page-size-select { padding:6px 12px; border:1px solid var(--border); border-radius:6px; font-size:14px; }
    .pagination-container { display:flex; justify-content:space-between; align-items:center; padding:20px 25px; border-top:1px solid var(--border); background:#f8fafc; }
    .pagination-left { display:flex; align-items:center; gap:20px; }
    .pagination-info { color:#64748b; font-size:14px; }
    .pagination { display:flex; align-items:center; gap:8px; }
    .pagination-btn { padding:8px 12px; border:1px solid var(--border); background:white; border-radius:6px; cursor:pointer; font-size:14px; transition:all 0.2s; }
    .pagination-btn:hover:not(:disabled) { background:#f1f5f9; border-color:#cbd5e1; }
    .pagination-btn:disabled { opacity:0.5; cursor:not-allowed; }
    .pagination-btn.active { background:var(--primary); color:white; border-color:var(--primary); }
    .page-numbers { display:flex; gap:4px; }
    .page-jump { display:flex; align-items:center; gap:8px; margin-left:20px; }
    .jump-input { width:60px; padding:6px 8px; border:1px solid var(--border); border-radius:4px; text-align:center; font-size:14px; }
    .jump-btn { padding:6px 12px; border:1px solid var(--primary); background:var(--primary); color:white; border-radius:4px; cursor:pointer; font-size:14px; }
    .jump-btn:hover { background:#1d4ed8; }

    .receiving-table {
      width: 100%;
      min-width: 2200px;
      border-collapse: collapse;
      position: relative;
    }

    .receiving-table th,
    .receiving-table td {
      padding: 12px 8px;
      text-align: left;
      border-bottom: 1px solid #f1f5f9;
      font-size: 12px;
      white-space: nowrap;
    }

    .receiving-table th {
      background: #f8fafc;
      font-weight: 600;
      color: #374151;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* 固定列样式 */
    .receiving-table th:nth-child(1),
    .receiving-table th:nth-child(2),
    .receiving-table th:nth-child(3),
    .receiving-table th:nth-child(4),
    .receiving-table td:nth-child(1),
    .receiving-table td:nth-child(2),
    .receiving-table td:nth-child(3),
    .receiving-table td:nth-child(4) {
      position: sticky;
      left: 0;
      background: white;
      z-index: 15;
    }

    .receiving-table th:nth-child(2),
    .receiving-table td:nth-child(2) { left: 40px; }
    .receiving-table th:nth-child(3),
    .receiving-table td:nth-child(3) { left: 160px; }
    .receiving-table th:nth-child(4),
    .receiving-table td:nth-child(4) { left: 310px; }

    /* 固定操作列 */
    .receiving-table th:last-child,
    .receiving-table td:last-child {
      position: sticky;
      right: 0;
      background: white;
      z-index: 15;
    }

    .receiving-table tr:hover {
      background: #f8fafc;
    }

    .receiving-table tr:hover td:nth-child(1),
    .receiving-table tr:hover td:nth-child(2),
    .receiving-table tr:hover td:nth-child(3),
    .receiving-table tr:hover td:nth-child(4),
    .receiving-table tr:hover td:last-child {
      background: #f8fafc;
    }

    .tag { 
      font-size: 12px; 
      padding: 2px 8px; 
      border-radius: 999px; 
      background: #eef2ff; 
      color: #3730a3; 
    }
    .state { 
      font-size: 12px; 
      padding: 2px 8px; 
      border-radius: 999px; 
    }
    .state.unclaimed { background: #fff7ed; color: #c2410c; }
    .state.claimed { background: #ecfdf5; color: #065f46; }
    .state.excluded { background: #fee2e2; color: #991b1b; }

    /* 支付平台选择弹窗样式 */
    .platform-selection {
      padding: 20px 0;
    }

    .platform-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .platform-option {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #fff;
    }

    .platform-option:hover {
      border-color: #3b82f6;
      background: #f8fafc;
    }

    .platform-option input[type="radio"] {
      margin-right: 12px;
      width: 16px;
      height: 16px;
    }

    .platform-option input[type="radio"]:checked + .platform-name {
      color: #3b82f6;
      font-weight: 600;
    }

    .platform-option:has(input[type="radio"]:checked) {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .platform-name {
      font-size: 14px;
      color: #374151;
      transition: all 0.3s ease;
    }


    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.4); z-index:2000; }
    .modal-inner { width:860px; max-width:95vw; background:#fff; border-radius:12px; overflow:auto; border:1px solid var(--border); max-height:90vh; z-index:2001; }
    .modal-header { padding:14px 16px; border-bottom:1px solid var(--border); font-weight:700; }
    .modal-body { padding:16px; display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .kv { display:flex; gap:8px; }
    .k { width:120px; color:#6b7280; font-size:12px; text-align:right; }
    .v { flex:1; font-size:13px; }
    .json { grid-column:1 / -1; background:#f8fafc; border:1px dashed var(--border); padding:10px; border-radius:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px; white-space:pre-wrap; }

    /* 响应式设计 */
    @media (max-width: 768px) {
      .search-row {
        flex-direction: column;
      }

      .search-group {
        min-width: 100%;
      }

      .table-actions {
        flex-direction: column;
      }

      .platform-options {
        grid-template-columns: 1fr;
      }
    }

    /* 预览弹窗样式 */
    .modal-actions { padding:12px 16px; border-top:1px solid var(--border); display:flex; gap:8px; justify-content:flex-end; }
    .preview-grid { padding:16px; }
    .stat { display:flex; gap:16px; margin-bottom:12px; color:#374151; font-size:13px; }
    .stat span { background:#f3f4f6; border:1px solid var(--border); padding:6px 10px; border-radius:8px; }
    .tbl-preview { width:100%; border-collapse:separate; border-spacing:0; min-width:900px; }
    .tbl-preview thead th { position:sticky; top:0; background:#f9fafb; z-index:2; text-align:left; font-size:12px; color:var(--muted); padding:10px; border-bottom:1px solid var(--border); }
    .tbl-preview tbody td { padding:8px 10px; border-bottom:1px solid var(--border); font-size:12px; }
    .status-ok { color:#065f46; background:#ecfdf5; padding:2px 8px; border-radius:999px; font-size:12px; }
    .status-err { color:#991b1b; background:#fee2e2; padding:2px 8px; border-radius:999px; font-size:12px; }
    .status-dup { color:#b45309; background:#fffbeb; padding:2px 8px; border-radius:999px; font-size:12px; }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <a href="index.html" class="logo">资金中台</a>
      <nav>
        <ul class="nav-menu">
          <li><a href="index.html">首页</a></li>
          <li class="dropdown">
            <a href="customer-management.html">账户管理</a>
            <div class="dropdown-content">
              <a href="customer-management.html">账户管理</a>
            </div>
          </li>
          <li class="dropdown">
            <a href="online-recharge.html">转账和收款</a>
            <div class="dropdown-content">
              <a href="online-recharge.html">在线充值</a>
              <a href="transfer-audit.html">转账审核</a>
              <a href="account-config.html">收款账户</a>
              <a href="receiving-ledger.html" class="active">收款明细</a>
            </div>
          </li>
          <li class="dropdown">
            <a href="transaction-details.html">交易管理</a>
            <div class="dropdown-content">
              <a href="transaction-details.html">交易明细</a>
            </div>
          </li>
          <li class="dropdown">
            <a href="credit-audit.html">额度管理</a>
            <div class="dropdown-content">
              <a href="credit-audit.html">信用额度</a>
              <a href="credit-bill.html">额度账单</a>
            </div>
          </li>
          <li class="dropdown">
            <a href="../Public component/button.html" target="_blank">公共组件</a>
            <div class="dropdown-content">
              <a href="../Public component/button.html" target="_blank">充值转账组件</a>
              <a href="../Public component/payment.html" target="_blank">支付组件</a>
              <a href="../Public component/payment2.html" target="_blank">支付组件(三列)</a>
              <a href="../Public component/view.html" target="_blank">钱包余额组件</a>
            </div>
          </li>
          <li class="dropdown">
            <a href="exchange-rate-detail.html">汇率管理</a>
            <div class="dropdown-content">
              <a href="exchange-rate-detail.html">中国人民银行汇率</a>
              <a href="exchange-rate-config.html">汇率浮动配置</a>
              <a href="hqy-business-exchange.html">灏仟亿业务汇率</a>
            </div>
          </li>
        </ul>
      </nav>
    </div>
  </header>
  <div class="container">
    <!-- 页面标题和描述 -->
    <div class="page-header">
      <h1 class="page-title">收款明细</h1>
      <p class="page-description">查看和管理全账户收款明细，包括各支付平台的收款记录、认领状态和资金流向</p>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="title">全账户收款明细</div>
      </div>

      <div class="search-section">
        <div class="search-row">
          <div class="search-group">
            <label>支付平台</label>
            <select class="search-input" id="fPlatform">
              <option value="">全部</option>
              <option value="PayPal">PayPal</option>
              <option value="Wise">Wise</option>
              <option value="Airwallex">Airwallex</option>
              <option value="Worldfirst">Worldfirst</option>
              <option value="Payoneer">Payoneer</option>
              <option value="PingPong">PingPong</option>
          </select>
        </div>
          <div class="search-group">
            <label>账户别名</label>
            <input class="search-input" id="fAlias" placeholder="输入账户别名关键词" />
        </div>
          <div class="search-group">
            <label>交易时间</label>
            <input type="date" class="search-input" id="fTime" />
        </div>
          <div class="search-group">
            <label>交易ID</label>
            <input class="search-input" id="fTxId" placeholder="模糊搜索交易ID" />
        </div>
          <div class="search-group">
            <label>交易金额</label>
            <input class="search-input" id="fAmount" placeholder="如 1000" />
        </div>
          <div class="search-group">
            <label>交易币种</label>
            <select class="search-input" id="fCcy">
              <option value="">全部</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
              <option value="CHF">CHF</option>
          </select>
        </div>
          <div class="search-group">
            <label>认领状态</label>
            <select class="search-input" id="fClaim">
            <option value="">全部</option>
            <option value="unclaimed">待认领</option>
            <option value="claimed">已认领</option>
            <option value="locked">认领锁定</option>
          </select>
        </div>
          <div class="search-group">
            <label>付款方信息</label>
            <input class="search-input" id="fPayer" placeholder="付款方名称/账号模糊" />
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary">搜索</button>
            <button class="btn btn-secondary">重置</button>
          </div>
        </div>
      </div>

      <div class="table-container">
        <div class="table-header">
          <h3 class="table-title">收款明细列表</h3>
          <div class="table-actions">
            <button class="btn" id="btnDownloadTpl">下载Excel模板</button>
            <button class="btn" id="btnUpload">手动上传Excel</button>
            <button class="btn btn-primary" id="btnExport">导出当前结果</button>
          </div>
        </div>
        
        <div class="table-wrapper">
          <table class="receiving-table" id="tbl">
          <thead>
            <tr>
                <th width="120px">支付平台</th>
                <th width="150px">账户别名</th>
                <th width="150px">交易ID</th>
                <th width="150px">交易时间（UTC +8）</th>
                <th width="100px">收款币种</th>
                <th width="120px">收款金额</th>
                <th width="100px">手续费</th>
                <th width="150px">付款方信息</th>
                <th width="100px">数据来源</th>
                <th width="100px">上传人员</th>
                <th width="100px">认领状态</th>
                <th width="120px">认领商户</th>
                <th width="120px">认领业务</th>
                <th width="150px">认领资金账户</th>
                <th width="150px">备注</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pagination-container">
        <div class="pagination-left">
          <div class="pagination-controls">
            <span>每页显示：</span>
            <select id="pageSize" class="page-size-select">
              <option value="10">10条</option>
              <option value="20">20条</option>
              <option value="50">50条</option>
              <option value="100">100条</option>
            </select>
          </div>
          <div class="pagination-info">
            <span id="paginationInfo">显示第 1-10 条，共 60 条记录</span>
          </div>
        </div>
        <div class="pagination">
          <button id="firstPage" class="pagination-btn">首页</button>
          <button id="prevPage" class="pagination-btn">上一页</button>
          <div id="pageNumbers" class="page-numbers"></div>
          <button id="nextPage" class="pagination-btn">下一页</button>
          <button id="lastPage" class="pagination-btn">末页</button>
          <div class="page-jump">
            <span>跳转到</span>
            <input type="number" id="jumpToPage" class="jump-input" min="1" placeholder="页码">
            <button id="jumpBtn" class="jump-btn">跳转</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- 支付平台选择弹窗 -->
  <div id="platformModal" class="modal">
    <div class="modal-inner">
      <div class="modal-header">选择支付平台</div>
      <div class="modal-body">
        <div class="platform-selection">
          <div class="platform-options">
            <label class="platform-option">
              <input type="radio" name="platform" value="PayPal">
              <span class="platform-name">PayPal</span>
            </label>
            <label class="platform-option">
              <input type="radio" name="platform" value="Wise">
              <span class="platform-name">Wise</span>
            </label>
            <label class="platform-option">
              <input type="radio" name="platform" value="Airwallex">
              <span class="platform-name">Airwallex</span>
            </label>
            <label class="platform-option">
              <input type="radio" name="platform" value="Worldfirst">
              <span class="platform-name">Worldfirst</span>
            </label>
            <label class="platform-option">
              <input type="radio" name="platform" value="Payoneer">
              <span class="platform-name">Payoneer</span>
            </label>
            <label class="platform-option">
              <input type="radio" name="platform" value="PingPong">
              <span class="platform-name">PingPong</span>
            </label>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closePlatformModal()">取消</button>
        <button class="btn btn-primary" id="confirmPlatformBtn" onclick="confirmPlatform()">确认</button>
      </div>
    </div>
  </div>

  <!-- 文件上传隐藏input -->
  <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">

  <div class="modal" id="modalDetail">
    <div class="modal-inner">
      <div class="modal-header">交易明细</div>
      <div class="modal-body">
        <div class="kv"><div class="k">平台</div><div class="v" id="dPlatform"></div></div>
        <div class="kv"><div class="k">账户</div><div class="v" id="dAccount"></div></div>
        <div class="kv"><div class="k">交易时间</div><div class="v" id="dTime"></div></div>
        <div class="kv"><div class="k">交易ID</div><div class="v" id="dTxId"></div></div>
        <div class="kv"><div class="k">对方</div><div class="v" id="dCounter"></div></div>
        <div class="kv"><div class="k">币种/金额</div><div class="v" id="dCcyAmt"></div></div>
        <div class="kv"><div class="k">手续费</div><div class="v" id="dFee"></div></div>
        <div class="kv"><div class="k">备注/附言</div><div class="v" id="dRef"></div></div>
        <div class="json" id="dRaw">{}</div>
      </div>
    </div>
  </div>

  <!-- 上传预览弹窗 -->
  <div class="modal" id="modalPreview">
    <div class="modal-inner" style="width:1000px;">
      <div class="modal-header">导入预览与校验结果</div>
      <div class="preview-grid">
        <div class="stat">
          <span id="statTotal">总计: 0</span>
          <span id="statOk">正常: 0</span>
          <span id="statErr">格式错误: 0</span>
          <span id="statDup">同平台同交易ID: 0</span>
        </div>
        <div class="table-wrap" style="max-height:50vh; overflow:auto; border:1px solid var(--border); border-radius:8px;">
          <table class="tbl-preview" id="tblPreview">
            <thead>
              <tr>
                <th>#</th>
                <th>支付平台代码</th>
                <th>账户别名</th>
                <th>交易ID</th>
                <th>交易时间</th>
                <th>收款币种</th>
                <th>收款金额</th>
                <th>手续费</th>
                <th>付款方信息</th>
                <th>状态</th>
                <th>说明</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" id="btnCancelImport">取消</button>
        <button class="btn primary" id="btnConfirmImport">确认导入（仅正常数据）</button>
      </div>
    </div>
  </div>

  <input type="file" id="fileInput" accept=".xls,.xlsx,.csv" style="display:none" />

  <script>
    // 收款明细测试数据 - 60条不同支付渠道和认领状态的数据
    const receivingLedgerData = [
      // PayPal 数据 (10条)
      { id:1, platform:'PayPal', alias:'PayPal-NA#1', txId:'PP-987654', time:'2025-08-30 12:10', ccy:'USD', amount:1200.50, fee:23.1, payer:'john@example.com', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'INV-20250830' },
      { id:2, platform:'PayPal', alias:'PayPal-SG#2', txId:'PP-123123', time:'2025-08-22 11:11', ccy:'USD', amount:88.00, fee:0.9, payer:'buyer@shop.com', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'Gift' },
      { id:3, platform:'PayPal', alias:'PayPal-NA#2', txId:'PP-888777', time:'2025-08-18 08:08', ccy:'USD', amount:45.60, fee:0.3, payer:'foo@bar.com', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'-' },
      { id:4, platform:'PayPal', alias:'PayPal-EU#1', txId:'PP-555666', time:'2025-08-15 14:25', ccy:'EUR', amount:850.00, fee:12.5, payer:'europe@client.com', source:'手动', uploader:'alice', claim:'已认领', claimMerchant:'US007', claimBusiness:'Advertising', claimAccount:'US007-ADV', remark:'EU Campaign' },
      { id:5, platform:'PayPal', alias:'PayPal-UK#1', txId:'PP-777888', time:'2025-08-12 16:40', ccy:'GBP', amount:320.00, fee:8.2, payer:'uk@merchant.co.uk', source:'API', uploader:'', claim:'认领锁定', claimMerchant:'US008', claimBusiness:'Fulfillment', claimAccount:'US008-FUL', remark:'UK Order' },
      { id:6, platform:'PayPal', alias:'PayPal-AU#1', txId:'PP-999000', time:'2025-08-10 09:15', ccy:'USD', amount:1500.00, fee:18.5, payer:'australia@supplier.com', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'AU Payment' },
      { id:7, platform:'PayPal', alias:'PayPal-CA#1', txId:'PP-111222', time:'2025-08-08 13:30', ccy:'USD', amount:750.00, fee:9.8, payer:'canada@partner.ca', source:'手动', uploader:'bob', claim:'已认领', claimMerchant:'US009', claimBusiness:'Advertising', claimAccount:'US009-ADV', remark:'CA Partnership' },
      { id:8, platform:'PayPal', alias:'PayPal-JP#1', txId:'PP-333444', time:'2025-08-06 11:20', ccy:'USD', amount:2200.00, fee:28.5, payer:'japan@client.jp', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'JP Market' },
      { id:9, platform:'PayPal', alias:'PayPal-MX#1', txId:'PP-555777', time:'2025-08-04 15:45', ccy:'USD', amount:450.00, fee:6.2, payer:'mexico@vendor.mx', source:'API', uploader:'', claim:'认领锁定', claimMerchant:'US010', claimBusiness:'Fulfillment', claimAccount:'US010-FUL', remark:'MX Fulfillment' },
      { id:10, platform:'PayPal', alias:'PayPal-IN#1', txId:'PP-888999', time:'2025-08-02 08:10', ccy:'USD', amount:1800.00, fee:22.5, payer:'india@service.in', source:'手动', uploader:'carol', claim:'已认领', claimMerchant:'US011', claimBusiness:'Advertising', claimAccount:'US011-ADV', remark:'IN Development' },

      // Stripe 数据 (10条)
      { id:11, platform:'Stripe', alias:'Stripe-US#2', txId:'ch_1ABCD', time:'2025-08-29 08:20', ccy:'USD', amount:520.00, fee:15.7, payer:'visa **** 4242', source:'API', uploader:'alice', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'Order#8891' },
      { id:12, platform:'Stripe', alias:'Stripe-UK#1', txId:'ch_1ZZZZ', time:'2025-08-23 18:20', ccy:'GBP', amount:320.00, fee:9.6, payer:'visa **** 1111', source:'API', uploader:'', claim:'认领锁定', claimMerchant:'US004', claimBusiness:'Fulfillment', claimAccount:'US004-FUL', remark:'Hold for review' },
      { id:13, platform:'Stripe', alias:'Stripe-EU#3', txId:'ch_1TEST', time:'2025-08-15 14:30', ccy:'EUR', amount:75.00, fee:2.2, payer:'mc **** 5555', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'test charge' },
      { id:14, platform:'Stripe', alias:'Stripe-CA#1', txId:'ch_1CANADA', time:'2025-08-13 10:15', ccy:'USD', amount:950.00, fee:28.5, payer:'visa **** 9999', source:'API', uploader:'', claim:'已认领', claimMerchant:'US012', claimBusiness:'Advertising', claimAccount:'US012-ADV', remark:'CA Campaign' },
      { id:15, platform:'Stripe', alias:'Stripe-AU#1', txId:'ch_1AUSTRALIA', time:'2025-08-11 16:30', ccy:'USD', amount:680.00, fee:20.4, payer:'mastercard **** 8888', source:'手动', uploader:'dave', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'AU Subscription' },
      { id:16, platform:'Stripe', alias:'Stripe-SG#1', txId:'ch_1SINGAPORE', time:'2025-08-09 12:45', ccy:'USD', amount:1200.00, fee:36.0, payer:'amex **** 7777', source:'API', uploader:'', claim:'认领锁定', claimMerchant:'US013', claimBusiness:'Fulfillment', claimAccount:'US013-FUL', remark:'SG Warehouse' },
      { id:17, platform:'Stripe', alias:'Stripe-DE#1', txId:'ch_1GERMANY', time:'2025-08-07 14:20', ccy:'EUR', amount:450.00, fee:13.5, payer:'visa **** 6666', source:'API', uploader:'', claim:'已认领', claimMerchant:'US014', claimBusiness:'Advertising', claimAccount:'US14-ADV', remark:'DE Market' },
      { id:18, platform:'Stripe', alias:'Stripe-FR#1', txId:'ch_1FRANCE', time:'2025-08-05 11:10', ccy:'EUR', amount:780.00, fee:23.4, payer:'mastercard **** 5555', source:'手动', uploader:'eve', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'FR Expansion' },
      { id:19, platform:'Stripe', alias:'Stripe-NL#1', txId:'ch_1NETHERLANDS', time:'2025-08-03 09:30', ccy:'EUR', amount:320.00, fee:9.6, payer:'visa **** 4444', source:'API', uploader:'', claim:'认领锁定', claimMerchant:'US015', claimBusiness:'Fulfillment', claimAccount:'US015-FUL', remark:'NL Hub' },
      { id:20, platform:'Stripe', alias:'Stripe-IT#1', txId:'ch_1ITALY', time:'2025-08-01 15:50', ccy:'EUR', amount:650.00, fee:19.5, payer:'mastercard **** 3333', source:'API', uploader:'', claim:'已认领', claimMerchant:'US016', claimBusiness:'Advertising', claimAccount:'US016-ADV', remark:'IT Launch' },

      // Wise 数据 (10条)
      { id:21, platform:'Wise', alias:'Wise-EU#1', txId:'UTR00921', time:'2025-08-28 20:00', ccy:'EUR', amount:3000.00, fee:0, payer:'IBAN **** 1234', source:'手动', uploader:'bob', claim:'已认领', claimMerchant:'US003', claimBusiness:'Advertising', claimAccount:'US003-ADV', remark:'Supplier payout' },
      { id:22, platform:'Wise', alias:'Wise-UK#2', txId:'UTR00999', time:'2025-08-25 09:10', ccy:'GBP', amount:700.00, fee:0, payer:'IBAN **** 5678', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'REF-700' },
      { id:23, platform:'Wise', alias:'Wise-EU#3', txId:'UTR00111', time:'2025-08-20 10:10', ccy:'EUR', amount:120.00, fee:0, payer:'IBAN **** 0001', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'-' },
      { id:24, platform:'Wise', alias:'Wise-SG#4', txId:'UTR00444', time:'2025-08-13 22:20', ccy:'CHF', amount:1300.00, fee:0, payer:'IBAN **** 2222', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'Swiss pay' },
      { id:25, platform:'Wise', alias:'Wise-US#1', txId:'UTR00555', time:'2025-08-11 14:35', ccy:'USD', amount:2500.00, fee:0, payer:'ACH **** 9876', source:'API', uploader:'', claim:'已认领', claimMerchant:'US017', claimBusiness:'Fulfillment', claimAccount:'US017-FUL', remark:'US Operations' },
      { id:26, platform:'Wise', alias:'Wise-CA#1', txId:'UTR00666', time:'2025-08-09 16:20', ccy:'USD', amount:1800.00, fee:0, payer:'CAD **** 5432', source:'手动', uploader:'frank', claim:'认领锁定', claimMerchant:'US018', claimBusiness:'Advertising', claimAccount:'US018-ADV', remark:'CA Partnership' },
      { id:27, platform:'Wise', alias:'Wise-AU#1', txId:'UTR00777', time:'2025-08-07 08:45', ccy:'USD', amount:3200.00, fee:0, payer:'AUD **** 1098', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'AU Expansion' },
      { id:28, platform:'Wise', alias:'Wise-JP#1', txId:'UTR00888', time:'2025-08-05 12:15', ccy:'USD', amount:950.00, fee:0, payer:'JPY **** 7654', source:'API', uploader:'', claim:'已认领', claimMerchant:'US019', claimBusiness:'Fulfillment', claimAccount:'US019-FUL', remark:'JP Market Entry' },
      { id:29, platform:'Wise', alias:'Wise-MX#1', txId:'UTR00999', time:'2025-08-03 18:30', ccy:'USD', amount:750.00, fee:0, payer:'MXN **** 3210', source:'手动', uploader:'grace', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'MX Operations' },
      { id:30, platform:'Wise', alias:'Wise-IN#1', txId:'UTR01000', time:'2025-08-01 10:00', ccy:'USD', amount:1200.00, fee:0, payer:'INR **** 9876', source:'API', uploader:'', claim:'认领锁定', claimMerchant:'US020', claimBusiness:'Advertising', claimAccount:'US020-ADV', remark:'IN Development' },

      // Airwallex 数据 (10条)
      { id:31, platform:'Airwallex', alias:'AWX-HK#1', txId:'AWX-7788', time:'2025-08-29 16:30', ccy:'USD', amount:520.00, fee:7.2, payer:'HSBC **** 9988', source:'API', uploader:'', claim:'认领锁定', claimMerchant:'US002', claimBusiness:'Fulfillment', claimAccount:'US002-FUL', remark:'订单#8891' },
      { id:32, platform:'Airwallex', alias:'AWX-AU#2', txId:'AWX-5522', time:'2025-08-24 07:30', ccy:'USD', amount:2100.00, fee:8.4, payer:'CBA **** 6677', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'PO-20250824' },
      { id:33, platform:'Airwallex', alias:'AWX-US#2', txId:'AWX-0099', time:'2025-08-19 15:00', ccy:'USD', amount:950.00, fee:4.2, payer:'CHASE **** 9988', source:'API', uploader:'', claim:'已认领', claimMerchant:'US005', claimBusiness:'Advertising', claimAccount:'US005-ADV', remark:'Campaign' },
      { id:34, platform:'Airwallex', alias:'AWX-SG#1', txId:'AWX-1111', time:'2025-08-17 13:20', ccy:'USD', amount:1800.00, fee:12.6, payer:'DBS **** 1234', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'SG Hub' },
      { id:35, platform:'Airwallex', alias:'AWX-UK#1', txId:'AWX-2222', time:'2025-08-15 11:45', ccy:'GBP', amount:650.00, fee:4.5, payer:'Barclays **** 5678', source:'手动', uploader:'henry', claim:'已认领', claimMerchant:'US021', claimBusiness:'Fulfillment', claimAccount:'US021-FUL', remark:'UK Warehouse' },
      { id:36, platform:'Airwallex', alias:'AWX-EU#1', txId:'AWX-3333', time:'2025-08-13 09:30', ccy:'EUR', amount:1200.00, fee:8.4, payer:'Deutsche **** 9012', source:'API', uploader:'', claim:'认领锁定', claimMerchant:'US022', claimBusiness:'Advertising', claimAccount:'US022-ADV', remark:'EU Campaign' },
      { id:37, platform:'Airwallex', alias:'AWX-CA#1', txId:'AWX-4444', time:'2025-08-11 16:15', ccy:'USD', amount:850.00, fee:5.9, payer:'RBC **** 3456', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'CA Market' },
      { id:38, platform:'Airwallex', alias:'AWX-JP#1', txId:'AWX-5555', time:'2025-08-09 14:00', ccy:'USD', amount:2200.00, fee:15.4, payer:'MUFG **** 7890', source:'手动', uploader:'ivy', claim:'已认领', claimMerchant:'US023', claimBusiness:'Fulfillment', claimAccount:'US023-FUL', remark:'JP Launch' },
      { id:39, platform:'Airwallex', alias:'AWX-MX#1', txId:'AWX-6666', time:'2025-08-07 12:30', ccy:'USD', amount:450.00, fee:3.1, payer:'BBVA **** 2345', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'MX Expansion' },
      { id:40, platform:'Airwallex', alias:'AWX-IN#1', txId:'AWX-7777', time:'2025-08-05 10:45', ccy:'USD', amount:1500.00, fee:10.5, payer:'HDFC **** 6789', source:'API', uploader:'', claim:'认领锁定', claimMerchant:'US024', claimBusiness:'Advertising', claimAccount:'US024-ADV', remark:'IN Development' },

      // Payoneer 数据 (10条)
      { id:41, platform:'Payoneer', alias:'Payo-EU#1', txId:'PNR-665544', time:'2025-08-27 10:05', ccy:'USD', amount:980.00, fee:3.5, payer:'jack@acme.com', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'INV-1001' },
      { id:42, platform:'Payoneer', alias:'Payo-US#2', txId:'PNR-111222', time:'2025-08-21 09:00', ccy:'USD', amount:600.00, fee:2.5, payer:'john.doe', source:'手动', uploader:'dave', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'Invoice AUG' },
      { id:43, platform:'Payoneer', alias:'Payo-UK#3', txId:'PNR-333444', time:'2025-08-14 09:45', ccy:'USD', amount:420.00, fee:1.9, payer:'acme ltd', source:'API', uploader:'', claim:'认领锁定', claimMerchant:'US006', claimBusiness:'Fulfillment', claimAccount:'US006-FUL', remark:'Locking' },
      { id:44, platform:'Payoneer', alias:'Payo-CA#1', txId:'PNR-555666', time:'2025-08-12 14:20', ccy:'USD', amount:750.00, fee:2.6, payer:'canada@freelancer.ca', source:'API', uploader:'', claim:'已认领', claimMerchant:'US025', claimBusiness:'Advertising', claimAccount:'US025-ADV', remark:'CA Freelancer' },
      { id:45, platform:'Payoneer', alias:'Payo-AU#1', txId:'PNR-777888', time:'2025-08-10 11:30', ccy:'USD', amount:1200.00, fee:4.2, payer:'australia@contractor.au', source:'手动', uploader:'jack', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'AU Contractor' },
      { id:46, platform:'Payoneer', alias:'Payo-SG#1', txId:'PNR-999000', time:'2025-08-08 16:45', ccy:'USD', amount:850.00, fee:3.0, payer:'singapore@agency.sg', source:'API', uploader:'', claim:'认领锁定', claimMerchant:'US026', claimBusiness:'Fulfillment', claimAccount:'US026-FUL', remark:'SG Agency' },
      { id:47, platform:'Payoneer', alias:'Payo-DE#1', txId:'PNR-111333', time:'2025-08-06 13:15', ccy:'USD', amount:650.00, fee:2.3, payer:'germany@designer.de', source:'API', uploader:'', claim:'已认领', claimMerchant:'US027', claimBusiness:'Advertising', claimAccount:'US027-ADV', remark:'DE Designer' },
      { id:48, platform:'Payoneer', alias:'Payo-FR#1', txId:'PNR-222444', time:'2025-08-04 15:30', ccy:'USD', amount:500.00, fee:1.8, payer:'france@writer.fr', source:'手动', uploader:'kate', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'FR Writer' },
      { id:49, platform:'Payoneer', alias:'Payo-NL#1', txId:'PNR-333555', time:'2025-08-02 12:00', ccy:'USD', amount:900.00, fee:3.2, payer:'netherlands@developer.nl', source:'API', uploader:'', claim:'认领锁定', claimMerchant:'US028', claimBusiness:'Fulfillment', claimAccount:'US028-FUL', remark:'NL Developer' },
      { id:50, platform:'Payoneer', alias:'Payo-IT#1', txId:'PNR-444666', time:'2025-07-31 10:20', ccy:'USD', amount:1100.00, fee:3.9, payer:'italy@consultant.it', source:'API', uploader:'', claim:'已认领', claimMerchant:'US029', claimBusiness:'Advertising', claimAccount:'US029-ADV', remark:'IT Consultant' },

      // PingPong 数据 (10条)
      { id:51, platform:'PingPong', alias:'PPG-CN#1', txId:'PPG-998877', time:'2025-08-26 14:33', ccy:'USD', amount:1500.00, fee:5.0, payer:'ppg **** 3322', source:'手动', uploader:'carol', claim:'已认领', claimMerchant:'US001', claimBusiness:'Advertising', claimAccount:'US001-ADV', remark:'Settlement' },
      { id:52, platform:'PingPong', alias:'PPG-US#2', txId:'PPG-556677', time:'2025-08-16 12:12', ccy:'USD', amount:2300.00, fee:7.0, payer:'ppg **** 5566', source:'手动', uploader:'mike', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'refund adj' },
      { id:53, platform:'PingPong', alias:'PPG-EU#1', txId:'PPG-112233', time:'2025-08-14 16:20', ccy:'USD', amount:1800.00, fee:5.4, payer:'ppg **** 7788', source:'API', uploader:'', claim:'已认领', claimMerchant:'US030', claimBusiness:'Fulfillment', claimAccount:'US030-FUL', remark:'EU Settlement' },
      { id:54, platform:'PingPong', alias:'PPG-UK#1', txId:'PPG-445566', time:'2025-08-12 11:40', ccy:'USD', amount:950.00, fee:2.9, payer:'ppg **** 9900', source:'手动', uploader:'nancy', claim:'认领锁定', claimMerchant:'US031', claimBusiness:'Advertising', claimAccount:'US031-ADV', remark:'UK Campaign' },
      { id:55, platform:'PingPong', alias:'PPG-AU#1', txId:'PPG-778899', time:'2025-08-10 09:25', ccy:'USD', amount:2200.00, fee:6.6, payer:'ppg **** 1122', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'AU Market' },
      { id:56, platform:'PingPong', alias:'PPG-CA#1', txId:'PPG-990011', time:'2025-08-08 14:15', ccy:'USD', amount:750.00, fee:2.3, payer:'ppg **** 3344', source:'API', uploader:'', claim:'已认领', claimMerchant:'US032', claimBusiness:'Fulfillment', claimAccount:'US032-FUL', remark:'CA Operations' },
      { id:57, platform:'PingPong', alias:'PPG-SG#1', txId:'PPG-223344', time:'2025-08-06 17:50', ccy:'USD', amount:1200.00, fee:3.6, payer:'ppg **** 5566', source:'手动', uploader:'oliver', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'SG Hub' },
      { id:58, platform:'PingPong', alias:'PPG-JP#1', txId:'PPG-556677', time:'2025-08-04 13:30', ccy:'USD', amount:1800.00, fee:5.4, payer:'ppg **** 7788', source:'API', uploader:'', claim:'认领锁定', claimMerchant:'US033', claimBusiness:'Advertising', claimAccount:'US033-ADV', remark:'JP Launch' },
      { id:59, platform:'PingPong', alias:'PPG-MX#1', txId:'PPG-889900', time:'2025-08-02 15:45', ccy:'USD', amount:650.00, fee:2.0, payer:'ppg **** 9900', source:'API', uploader:'', claim:'已认领', claimMerchant:'US034', claimBusiness:'Fulfillment', claimAccount:'US034-FUL', remark:'MX Expansion' },
      { id:60, platform:'PingPong', alias:'PPG-IN#1', txId:'PPG-334455', time:'2025-07-31 12:10', ccy:'USD', amount:1400.00, fee:4.2, payer:'ppg **** 1122', source:'手动', uploader:'peter', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'IN Development' }
    ];

    // 使用外部数据文件中的数据
    let rows = [];

    // 从 localStorage 加载，如无则使用外部数据初始化并保存
    function initStorage(){
      try{
        const cached = localStorage.getItem('receivingLedgerRows');
        if(cached){ 
          rows = JSON.parse(cached); 
          console.log('从localStorage加载数据:', rows.length, '条');
        } else { 
          // 使用外部数据文件中的数据
          if (typeof receivingLedgerData !== 'undefined') {
            rows = [...receivingLedgerData];
            console.log('从外部数据文件加载数据:', rows.length, '条');
          } else {
            // 如果外部数据未加载，使用默认数据
            rows = [
              { id:1, platform:'PayPal', alias:'PayPal-NA#1', txId:'PP-987654', time:'2025-08-30 12:10', ccy:'USD', amount:1200.50, fee:23.1, payer:'john@example.com', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'INV-20250830' },
              { id:2, platform:'Wise', alias:'Wise-EU#1', txId:'UTR00921', time:'2025-08-28 20:00', ccy:'EUR', amount:3000.00, fee:0, payer:'IBAN **** 1234', source:'手动', uploader:'bob', claim:'已认领', claimMerchant:'US003', claimBusiness:'Advertising', claimAccount:'US003-ADV', remark:'Supplier payout' },
              { id:3, platform:'Airwallex', alias:'AWX-HK#1', txId:'AWX-7788', time:'2025-08-29 16:30', ccy:'USD', amount:520.00, fee:7.2, payer:'HSBC **** 9988', source:'API', uploader:'', claim:'认领锁定', claimMerchant:'US002', claimBusiness:'Fulfillment', claimAccount:'US002-FUL', remark:'订单#8891' },
              { id:4, platform:'Stripe', alias:'Stripe-US#2', txId:'ch_1ABCD', time:'2025-08-29 08:20', ccy:'USD', amount:520.00, fee:15.7, payer:'visa **** 4242', source:'API', uploader:'alice', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'Order#8891' }
            ];
            console.log('使用默认数据:', rows.length, '条');
          }
          localStorage.setItem('receivingLedgerRows', JSON.stringify(rows)); 
        }
      }catch(err){ 
        console.error('数据加载失败:', err);
        // 如果所有方法都失败，使用默认数据
        rows = [
          { id:1, platform:'PayPal', alias:'PayPal-NA#1', txId:'PP-987654', time:'2025-08-30 12:10', ccy:'USD', amount:1200.50, fee:23.1, payer:'john@example.com', source:'API', uploader:'', claim:'待认领', claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'INV-20250830' }
        ];
        console.log('使用fallback数据:', rows.length, '条');
      }
    }

    // 页面滚动锁定工具
    const pageScroll = {
      lock(){ document.documentElement.style.overflow='hidden'; document.body.style.overflow='hidden'; },
      unlock(){ document.documentElement.style.overflow=''; document.body.style.overflow=''; }
    };

    // 支付平台选择相关变量
    let currentAction = ''; // 'download' 或 'upload'
    const platformModal = document.getElementById('platformModal');
    const fileInput = document.getElementById('fileInput');

    // 打开支付平台选择弹窗
    function openPlatformModal(action) {
      currentAction = action;
      platformModal.style.display = 'flex';
      pageScroll.lock();
      
      // 重置选择
      const radios = document.querySelectorAll('input[name="platform"]');
      radios.forEach(radio => radio.checked = false);
      
      // 更新确认按钮文本
      const confirmBtn = document.getElementById('confirmPlatformBtn');
      confirmBtn.textContent = action === 'download' ? '下载模版' : '选择文件';
    }

    // 关闭支付平台选择弹窗
    function closePlatformModal() {
      platformModal.style.display = 'none';
      pageScroll.unlock();
    }

    // 确认支付平台选择
    function confirmPlatform() {
      const selectedPlatform = document.querySelector('input[name="platform"]:checked');
      if (!selectedPlatform) {
        alert('请先选择支付平台');
        return;
      }

      const platform = selectedPlatform.value;
      closePlatformModal();

      if (currentAction === 'download') {
        downloadTemplate(platform);
      } else if (currentAction === 'upload') {
        openFileSelector(platform);
      }
    }

    // 下载Excel模版
    function downloadTemplate(platform) {
      // 根据平台生成不同的模版文件名
      const templateNames = {
        'PayPal': 'PayPal收款明细模版.xlsx',
        'Wise': 'Wise收款明细模版.xlsx',
        'Airwallex': 'Airwallex收款明细模版.xlsx',
        'Worldfirst': 'Worldfirst收款明细模版.xlsx',
        'Payoneer': 'Payoneer收款明细模版.xlsx',
        'PingPong': 'PingPong收款明细模版.xlsx'
      };

      const fileName = templateNames[platform] || '收款明细模版.xlsx';
      
      // 创建下载链接
      const link = document.createElement('a');
      link.href = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,UEsDBBQAAAAIAA=='; // 空Excel文件的base64
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      console.log(`下载${platform}模版: ${fileName}`);
    }

    // 打开文件选择器
    function openFileSelector(platform) {
      fileInput.onchange = function(event) {
        const file = event.target.files[0];
        if (file) {
          handleFileUpload(file, platform);
        }
      };
      fileInput.click();
    }

    // 处理文件上传
    function handleFileUpload(file, platform) {
      console.log(`上传${platform}文件:`, file.name);
      
      // 文件类型验证
      const allowedTypes = ['.xlsx', '.xls', '.csv'];
      const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
      
      if (!allowedTypes.includes(fileExtension)) {
        alert('请选择Excel文件（.xlsx、.xls或.csv格式）');
        return;
      }

      // 文件大小验证（10MB限制）
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('文件大小超过10MB限制');
        return;
      }

      // 将选择的平台信息存储到全局变量中，供预览功能使用
      window.selectedPlatform = platform;
      
      // 调用原有的文件处理逻辑，显示预览弹窗
      const event = { target: { files: [file] } };
      onFileSelected(event);
    }

    const tbody = document.querySelector('#tbl tbody');
    function fmt(n){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
    // 分页变量
    let currentPage = 1;
    let pageSize = 10;

    function render(){
      console.log('开始渲染，数据条数:', rows.length);
      tbody.innerHTML = '';
      const startIndex = (currentPage-1)*pageSize;
      const endIndex = startIndex + pageSize;
      rows.slice(startIndex,endIndex).forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.platform}</td>
          <td>${r.alias}</td>
          <td>${r.txId}</td>
          <td>${r.time}</td>
          <td>${r.ccy}</td>
          <td>${fmt(r.amount)}</td>
          <td>${r.fee?fmt(r.fee):'-'}</td>
          <td>${r.payer||'-'}</td>
          <td><span class="tag">${r.source}</span></td>
          <td>${r.uploader||'-'}</td>
          <td>${r.claim}</td>
          <td>${r.claimMerchant||'-'}</td>
          <td>${r.claimBusiness||'-'}</td>
          <td>${r.claimAccount||'-'}</td>
          <td>${r.remark||'-'}</td>`;
        tbody.appendChild(tr);
      });
      console.log('渲染完成，表格行数:', tbody.children.length);
      try{ localStorage.setItem('receivingLedgerRows', JSON.stringify(rows)); }catch(err){}
      updatePagination();
    }

    function updatePagination(){
      const total = rows.length;
      const totalPages = Math.max(1, Math.ceil(total/pageSize));
      if(currentPage>totalPages) currentPage=totalPages;
      const start = total===0?0:(currentPage-1)*pageSize + 1;
      const end = Math.min(currentPage*pageSize, total);
      document.getElementById('paginationInfo').textContent = `显示第 ${start}-${end} 条，共 ${total} 条记录`;
      document.getElementById('firstPage').disabled = currentPage===1;
      document.getElementById('prevPage').disabled = currentPage===1;
      document.getElementById('nextPage').disabled = currentPage===totalPages;
      document.getElementById('lastPage').disabled = currentPage===totalPages;
      const pn = document.getElementById('pageNumbers');
      pn.innerHTML='';
      const maxVisible = 5; let sp=Math.max(1,currentPage-Math.floor(maxVisible/2)); let ep=Math.min(totalPages, sp+maxVisible-1); if(ep-sp+1<maxVisible) sp=Math.max(1, ep-maxVisible+1);
      for(let i=sp;i<=ep;i++){ const b=document.createElement('button'); b.className=`pagination-btn ${i===currentPage?'active':''}`; b.textContent=i; b.onclick=()=>goToPage(i); pn.appendChild(b); }
    }
    function goToPage(p){ const totalPages = Math.max(1, Math.ceil(rows.length/pageSize)); if(p>=1 && p<=totalPages){ currentPage=p; render(); } }


    function openDetail(row){
      document.getElementById('dPlatform').textContent = row.platform;
      document.getElementById('dAccount').textContent = row.alias;
      document.getElementById('dTime').textContent = row.time;
      document.getElementById('dTxId').textContent = row.txId||'-';
      document.getElementById('dCounter').textContent = row.payer||'-';
      document.getElementById('dCcyAmt').textContent = `${row.ccy} ${fmt(row.amount)}`;
      document.getElementById('dFee').textContent = row.fee?fmt(row.fee):'-';
      document.getElementById('dRef').textContent = row.remark||'-';
      document.getElementById('dRaw').textContent = JSON.stringify(row.raw,null,2);
      modal.style.display='flex';
      pageScroll.lock();
    }

    // 绑定按钮事件
    document.getElementById('btnDownloadTpl').addEventListener('click', () => {
      openPlatformModal('download');
    });

    document.getElementById('btnUpload').addEventListener('click', () => {
      openPlatformModal('upload');
    });

    document.getElementById('btnExport').addEventListener('click', () => {
      // 导出当前结果
      const data = rows.map(r => ({
        支付平台: r.platform,
        账户别名: r.alias,
        交易ID: r.txId,
        交易时间: r.time,
        收款币种: r.ccy,
        收款金额: r.amount,
        手续费: r.fee || 0,
        付款方信息: r.payer || '',
        数据来源: r.source,
        上传人员: r.uploader || '',
        认领状态: r.claim,
        认领商户: r.claimMerchant || '',
        认领业务: r.claimBusiness || '',
        认领资金账户: r.claimAccount || '',
        备注: r.remark || ''
      }));
      
      const csv = convertToCSV(data);
      downloadCSV(csv, '收款明细导出.csv');
    });

    // CSV转换和下载工具函数
    function convertToCSV(data) {
      if (data.length === 0) return '';
      
      const headers = Object.keys(data[0]);
      const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
      ].join('\n');
      
      return csvContent;
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    const modal = document.getElementById('modalDetail');
    modal.addEventListener('click', (e)=>{ if(e.target===modal){ modal.style.display='none'; pageScroll.unlock(); } });


    // 平台代码映射：将上传文档中的数字代码翻译为平台名称
    // 示例：2 → Stripe
    const platformCodes = { '1':'PayPal', '2':'Stripe', '3':'Wise', '4':'Airwallex', '5':'Payoneer', '6':'PingPong', '7':'Worldfirst' };
    const validCurrencies = ['USD','EUR','GBP','CHF'];

    const modalPreview = document.getElementById('modalPreview');
    const tblPreviewBody = document.querySelector('#tblPreview tbody');
    const statTotal = document.getElementById('statTotal');
    const statOk = document.getElementById('statOk');
    const statErr = document.getElementById('statErr');
    const statDup = document.getElementById('statDup');
    document.getElementById('btnCancelImport').addEventListener('click', ()=>{ modalPreview.style.display='none'; tblPreviewBody.innerHTML=''; pageScroll.unlock(); });
    document.getElementById('btnConfirmImport').addEventListener('click', confirmImport);
    modalPreview.addEventListener('click', (e)=>{ if(e.target===modalPreview){ modalPreview.style.display='none'; tblPreviewBody.innerHTML=''; pageScroll.unlock(); } });

    let previewData = [];

    async function onFileSelected(e){
      const file = e.target.files[0]; if(!file) return;
      // 大小校验 10MB
      const maxSize = 10 * 1024 * 1024;
      if(file.size > maxSize){ alert('文件大小超过10MB限制'); e.target.value=''; return; }
      const name = file.name.toLowerCase();
      const isCSV = name.endsWith('.csv');
      const isXLS = name.endsWith('.xls') || name.endsWith('.xlsx');
      if(!isCSV && !isXLS){ alert('仅支持 .xlsx、.csv、.xls'); e.target.value=''; return; }
      if(isCSV){
        const reader = new FileReader();
        reader.onload = () => {
          const text = reader.result;
          const rows = parseCSV(text);
          if(rows.length <= 1){ alert('文件内容为空或无有效数据'); return; }
          const dataRows = rows.slice(1); // 从第二行开始识别
          buildPreview(dataRows);
        };
        reader.readAsText(file, 'utf-8');
        return;
      }
      // Excel解析：动态加载xlsx库
      try{
        await ensureXLSX();
      }catch(err){ alert('加载Excel解析库失败'); return; }
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = new Uint8Array(reader.result);
          const wb = window.XLSX.read(data, { type: 'array' });
          const firstSheetName = wb.SheetNames[0];
          const ws = wb.Sheets[firstSheetName];
          const arr = window.XLSX.utils.sheet_to_json(ws, { header:1, raw:false });
          if(arr.length <= 1){ alert('文件内容为空或无有效数据'); return; }
          const dataRows = arr.slice(1); // 从第二行开始识别
          buildPreview(dataRows);
        }catch(err){
          alert('Excel解析失败，请检查文件格式');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // 动态加载xlsx库（SheetJS）
    function ensureXLSX(){
      return new Promise((resolve,reject)=>{
        if(window.XLSX){ resolve(); return; }
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
        s.onload = ()=>resolve();
        s.onerror = ()=>reject(new Error('load xlsx failed'));
        document.head.appendChild(s);
      });
    }

    function parseCSV(text){
      // 简易CSV解析（不处理复杂嵌套引号场景）
      return text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.trim().length>0).map(line=>{
        const parts = [];
        let cur = '', inQuotes = false;
        for(let i=0;i<line.length;i++){
          const ch = line[i];
          if(ch==='"'){
            if(inQuotes && line[i+1]==='"'){ cur += '"'; i++; }
            else { inQuotes = !inQuotes; }
          } else if(ch===',' && !inQuotes){
            parts.push(cur); cur='';
          } else { cur += ch; }
        }
        parts.push(cur);
        return parts;
      });
    }

    function trimSafe(v){ return (v||'').trim(); }
    
    function joinReason(current, newReason) {
      return current ? `${current}; ${newReason}` : newReason;
    }

    // 期望列（模板）：platformCode, alias, txId, time, ccy, amount, fee, payer
    function buildPreview(dataRows){
      tblPreviewBody.innerHTML='';
      previewData = [];
      let ok=0, err=0, dup=0;
      // 现有去重基线：平台名称+交易ID
      const existingKey = new Set(rows.map(r=>`${r.platform}||${(r.txId||'').toUpperCase()}`));
      const batchKey = new Set();
      dataRows.forEach((cols, idx)=>{
        const [platformCodeRaw, aliasRaw, txIdRaw, timeRaw, ccyRaw, amountRaw, feeRaw, payerRaw] = cols;
        const platformCode = trimSafe(platformCodeRaw);
        const alias = trimSafe(aliasRaw);
        const txId = trimSafe(txIdRaw);
        const time = trimSafe(timeRaw);
        const ccy = trimSafe(ccyRaw);
        const amount = Number(trimSafe(amountRaw).replace(/,/g,''));
        const fee = amountRaw!==undefined && feeRaw!==undefined && trimSafe(feeRaw) !== '' ? Number(trimSafe(feeRaw).replace(/,/g,'')) : 0;
        const payer = trimSafe(payerRaw);

        let status = 'ok';
        let reason = '';

        // 基础校验
        const selectedPlatform = window.selectedPlatform || '';
        let platformName, platformCodeFinal;
        
        if(selectedPlatform) {
          // 如果选择了特定平台，使用该平台名称
          platformName = selectedPlatform;
          platformCodeFinal = selectedPlatform;
        } else {
          // 原有逻辑：验证平台代码
        if(!platformCode || !(platformCode in platformCodes)){
          status = 'err'; reason = '支付平台代码无效（示例：2→Stripe）';
          }
          platformName = platformCodes[platformCode] || platformCode;
          platformCodeFinal = platformCode;
        }
        
        if(!txId){ status='err'; reason = joinReason(reason,'交易ID为空'); }
        // 去空格已处理
        if(ccy && !validCurrencies.includes(ccy.toUpperCase())){
          status='err'; reason = joinReason(reason,'收款币种无效（USD/EUR/GBP/CHF）');
        }
        if(isNaN(amount)){ status='err'; reason = joinReason(reason,'收款金额无效'); }
        if(fee!==0 && isNaN(fee)){ status='err'; reason = joinReason(reason,'手续费无效'); }

        // 同平台同交易ID重复（与现有/本次）
        const key = `${platformName}||${txId.toUpperCase()}`;
        if(status==='ok'){
          if(existingKey.has(key) || batchKey.has(key)){
            status='dup'; reason='同平台同交易ID重复';
          }
        }

        if(status==='ok'){ ok++; batchKey.add(key); }
        else if(status==='dup'){ dup++; }
        else { err++; }

        previewData.push({ platformCode: platformCodeFinal, platformName, alias, txId, time, ccy: ccy.toUpperCase(), amount, fee, payer, status, reason });

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+2}</td>
          <td>${platformCodeFinal}</td>
          <td>${alias||'-'}</td>
          <td>${txId||'-'}</td>
          <td>${time||'-'}</td>
          <td>${ccy||'-'}</td>
          <td>${isNaN(amount)?'-':fmt(amount)}</td>
          <td>${isNaN(fee)?'-':fmt(fee)}</td>
          <td>${payer||'-'}</td>
          <td>${statusLabel(status)}</td>
          <td>${reason||'-'}</td>`;
        tblPreviewBody.appendChild(tr);
      });

      statTotal.textContent = `总计: ${previewData.length}`;
      statOk.textContent = `正常: ${ok}`;
      statErr.textContent = `格式错误: ${err}`;
      statDup.textContent = `同平台同交易ID: ${dup}`;
      modalPreview.style.display='flex';
      pageScroll.lock();
    }

    function statusLabel(status){
      if(status==='ok') return `<span class="status-ok">正常</span>`;
      if(status==='dup') return `<span class="status-dup">同平台同交易ID</span>`;
      return `<span class="status-err">格式错误</span>`;
    }

    function joinReason(a,b){ return a? (a+'；'+b) : b; }

    function confirmImport(){
      const okList = previewData.filter(x=>x.status==='ok');
      if(okList.length===0){ alert('没有可导入的数据'); return; }
      const nextId = rows.length ? Math.max(...rows.map(r=>r.id))+1 : 1;
      let idCounter = nextId;
      okList.forEach(item=>{
        rows.push({
          id: idCounter++,
          platform: item.platformName,
          alias: item.alias || '-',
          txId: item.txId,
          time: item.time || '-',
          ccy: (item.ccy||'').toUpperCase(),
          amount: Number(item.amount)||0,
          fee: Number(item.fee)||0,
          payer: item.payer || '-',
          source: '手动',
          uploader: '-',
          claim: '待认领',
          claimMerchant:'-', claimBusiness:'-', claimAccount:'-', remark:'-'
        });
      });
      render();
      modalPreview.style.display='none';
      tblPreviewBody.innerHTML='';
      alert(`导入完成：成功 ${okList.length} 条`);
      pageScroll.unlock();
    }

    // 等待DOM加载完成后再渲染
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化数据存储
      initStorage();
      
      // 渲染数据
      render();
      // 绑定分页事件
      document.getElementById('pageSize').addEventListener('change', (e)=>{ pageSize=parseInt(e.target.value); currentPage=1; render(); });
      document.getElementById('firstPage').addEventListener('click', ()=>goToPage(1));
      document.getElementById('prevPage').addEventListener('click', ()=>goToPage(currentPage-1));
      document.getElementById('nextPage').addEventListener('click', ()=>goToPage(currentPage+1));
      document.getElementById('lastPage').addEventListener('click', ()=>{ const tp=Math.max(1, Math.ceil(rows.length/pageSize)); goToPage(tp); });
      document.getElementById('jumpBtn').addEventListener('click', ()=>{ const v=parseInt(document.getElementById('jumpToPage').value); if(v) goToPage(v); });
      document.getElementById('jumpToPage').addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ const v=parseInt(e.target.value); if(v) goToPage(v);} });
      
      // 页面加载动画
      const rows = document.querySelectorAll('tbody tr');
      rows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateY(20px)';
        setTimeout(() => {
          row.style.transition = 'all 0.3s ease';
          row.style.opacity = '1';
          row.style.transform = 'translateY(0)';
        }, index * 100);
      });
    });
  </script>
</body>
</html>
