<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>线下充值审核 - 资金中台管理系统</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f8fafc;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    header {
      background: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      color: #2563eb;
      text-decoration: none;
    }

    .nav-menu {
      display: flex;
      list-style: none;
      gap: 30px;
    }

    .nav-menu li {
      position: relative;
    }

    .nav-menu li a {
      text-decoration: none;
      color: #64748b;
      font-weight: 500;
      transition: color 0.3s ease;
      padding: 10px 15px;
      border-radius: 8px;
      display: block;
    }

    .nav-menu li a:hover,
    .nav-menu li a.active {
      color: #2563eb;
      background: rgba(37, 99, 235, 0.1);
    }

    /* 下拉菜单样式 */
    .dropdown {
      position: relative;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      min-width: 200px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border-radius: 8px;
      z-index: 1000;
      padding: 8px 0;
      border: 1px solid #e2e8f0;
    }

    .dropdown:hover .dropdown-content {
      display: block;
    }

    .dropdown-content a {
      padding: 12px 20px;
      display: block;
      border-radius: 0;
      font-size: 14px;
    }

    .dropdown-content a:hover {
      background: rgba(37, 99, 235, 0.1);
      color: #2563eb;
    }

    /* Page styles similar to customer management */
    .page-header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
      border-left: 4px solid #2563eb;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 10px;
    }

    .page-description {
      color: #64748b;
      font-size: 16px;
    }

    /* 分页样式 */
    .pagination-controls { display:flex; align-items:center; gap:8px; }
    .page-size-select { padding:6px 12px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px; }
    .pagination-container { display:flex; justify-content:space-between; align-items:center; padding:20px 25px; border-top:1px solid #e2e8f0; background:#f8fafc; }
    .pagination-left { display:flex; align-items:center; gap:20px; }
    .pagination-info { color:#64748b; font-size:14px; }
    .pagination { display:flex; align-items:center; gap:8px; }
    .pagination-btn { padding:8px 12px; border:1px solid #e2e8f0; background:white; border-radius:6px; cursor:pointer; font-size:14px; transition:all 0.2s; }
    .pagination-btn:hover:not(:disabled) { background:#f1f5f9; border-color:#cbd5e1; }
    .pagination-btn:disabled { opacity:0.5; cursor:not-allowed; }
    .pagination-btn.active { background:#2563eb; color:white; border-color:#2563eb; }
    .page-numbers { display:flex; gap:4px; }
    .page-jump { display:flex; align-items:center; gap:8px; margin-left:20px; }
    .jump-input { width:60px; padding:6px 8px; border:1px solid #e2e8f0; border-radius:4px; text-align:center; font-size:14px; }
    .jump-btn { padding:6px 12px; border:1px solid #2563eb; background:#2563eb; color:white; border-radius:4px; cursor:pointer; font-size:14px; }
    .jump-btn:hover { background:#1d4ed8; }

    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      text-align: center;
    }

    .stat-number {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-pending { color: #f59e0b; }
    .stat-approved { color: #059669; }
    .stat-rejected { color: #dc2626; }
    .stat-unmatched { color: #f59e0b; }
    .stat-matched { color: #3b82f6; }
    .stat-total { color: #2563eb; }

    .stat-label {
      color: #64748b;
      font-size: 14px;
    }

    .search-section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 25px;
    }

    .search-row {
      display: flex;
      gap: 20px;
      align-items: end;
      flex-wrap: wrap;
    }

    .search-group {
      flex: 1;
      min-width: 180px;
    }

    .search-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: #2563eb;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-primary { background: #2563eb; color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: #6b7280; color: white; }
    .btn-secondary:hover { background: #4b5563; }
    .btn-success { background: #059669; color: white; }
    .btn-success:hover { background: #047857; }
    .btn-danger { background: #dc2626; color: white; }
    .btn-danger:hover { background: #b91c1c; }

    /* Table Container with Horizontal Scroll */
    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 25px;
      border-bottom: 1px solid #e2e8f0;
    }

    .table-title {
      font-size: 20px;
      font-weight: 600;
      color: #1e293b;
    }

    .batch-actions {
      display: flex;
      gap: 10px;
    }

    .table-wrapper {
      overflow-x: auto;
      position: relative;
    }

    .transfer-table {
      width: 100%;
      min-width: 2280px;
      border-collapse: collapse;
      position: relative;
    }

    .transfer-table th,
    .transfer-table td {
      padding: 12px 8px;
      text-align: left;
      border-bottom: 1px solid #f1f5f9;
      font-size: 12px;
      white-space: nowrap;
    }

    .transfer-table th {
      background: #f8fafc;
      font-weight: 600;
      color: #374151;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* Fixed columns */
    .transfer-table th:nth-child(1),
    .transfer-table th:nth-child(2),
    .transfer-table th:nth-child(3),
    .transfer-table th:nth-child(4),
    .transfer-table td:nth-child(1),
    .transfer-table td:nth-child(2),
    .transfer-table td:nth-child(3),
    .transfer-table td:nth-child(4) {
      position: sticky;
      left: 0;
      background: white;
      z-index: 15;
    }

    .transfer-table th:nth-child(2),
    .transfer-table td:nth-child(2) { left: 40px; }
    .transfer-table th:nth-child(3),
    .transfer-table td:nth-child(3) { left: 160px; }
    .transfer-table th:nth-child(4),
    .transfer-table td:nth-child(4) { left: 310px; }

    /* Fixed operation column */
    .transfer-table th:last-child,
    .transfer-table td:last-child {
      position: sticky;
      right: 0;
      background: white;
      z-index: 15;
    }

    .transfer-table tr:hover {
      background: #f8fafc;
    }

    .transfer-table tr:hover td:nth-child(1),
    .transfer-table tr:hover td:nth-child(2),
    .transfer-table tr:hover td:nth-child(3),
    .transfer-table tr:hover td:nth-child(4),
    .transfer-table tr:hover td:last-child {
      background: #f8fafc;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
    }

    .status-pending { background: #fef3c7; color: #92400e; }
    .status-confirm { background: #dbeafe; color: #1e40af; }
    .status-approved { background: #dcfce7; color: #166534; }
    .status-rejected { background: #fee2e2; color: #991b1b; }
    .precharge-none { color: #64748b; }
    .precharge-applying { background: #fef3c7; color: #92400e; }
    .precharge-success { background: #dcfce7; color: #166534; }
    .precharge-failed { background: #fee2e2; color: #991b1b; }
    .precharge-canceled { color: #94a3b8; }

    .amount-large {
      font-weight: 600;
      font-size: 13px;
    }

    .amount-positive { color: #059669; }
    .amount-negative { color: #dc2626; }

    .business-tag {
      background: #dbeafe;
      color: #1e40af;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
    }

    .platform-tag {
      background: #f3e8ff;
      color: #7c3aed;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
    }

    .action-buttons {
      display: flex;
      gap: 6px;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 4px;
    }

    .screenshot-link {
      color: #2563eb;
      text-decoration: none;
      font-size: 11px;
    }

    .screenshot-link:hover {
      text-decoration: underline;
    }

    .audit-remark {
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 12px;
      color: #374151;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 700px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 600;
      color: #1e293b;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #64748b;
    }

    .detail-section {
      margin-bottom: 20px;
    }

    .detail-section h4 {
      color: #374151;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      background: #f8fafc;
      border-radius: 6px;
    }

    .detail-label {
      color: #64748b;
      font-weight: 500;
    }

    .detail-value {
      color: #1e293b;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
      resize: vertical;
    }

    .form-input:focus {
      outline: none;
      border-color: #2563eb;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    /* 单选按钮样式 */
    input[type="radio"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #2563eb;
    }

    label[for*="m-action"] {
      user-select: none;
    }

    label[for*="m-action"]:hover {
      opacity: 0.8;
    }

    .screenshot-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    /* 覆盖处理弹窗内候选表格的固定列与sticky，避免缝隙与分层 */
    #processModal .transfer-table th { position: static; top: auto; z-index: auto; }
    #processModal .transfer-table th:nth-child(1),
    #processModal .transfer-table th:nth-child(2),
    #processModal .transfer-table th:nth-child(3),
    #processModal .transfer-table th:nth-child(4),
    #processModal .transfer-table td:nth-child(1),
    #processModal .transfer-table td:nth-child(2),
    #processModal .transfer-table td:nth-child(3),
    #processModal .transfer-table td:nth-child(4),
    #processModal .transfer-table th:last-child,
    #processModal .transfer-table td:last-child { position: static; left: auto; right: auto; z-index: auto; background: white; }
    #processModal .transfer-table thead th { background: #f8fafc; }

    /* Responsive Design */
    @media (max-width: 768px) {
      .search-row {
        flex-direction: column;
      }

      .search-group {
        min-width: 100%;
      }

      .stats-cards {
        grid-template-columns: repeat(2, 1fr);
      }

      .detail-grid {
        grid-template-columns: 1fr;
      }

      .batch-actions {
        flex-direction: column;
      }

      .action-buttons {
        flex-direction: column;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <a href="index.html" class="logo">资金中台</a>
      <nav>
        <ul class="nav-menu">
          <li><a href="index.html">首页</a></li>
          <li class="dropdown">
            <a href="customer-management.html">账户管理</a>
            <div class="dropdown-content">
              <a href="customer-management.html">账户管理</a>
            </div>
          </li>
          <li class="dropdown">
            <a href="online-recharge.html">转账和收款</a>
            <div class="dropdown-content">
              <a href="online-recharge.html">在线充值</a>
              <a href="transfer-audit.html" class="active">转账审核</a>
              <a href="precharge-tracking.html">预充追踪</a>
              <a href="account-config.html">收款账户</a>
              <a href="receiving-ledger.html">收款明细</a>
            </div>
          </li>
          <li class="dropdown">
            <a href="transaction-details.html">交易管理</a>
            <div class="dropdown-content">
              <a href="transaction-details.html">交易明细</a>
            </div>
          </li>
          <li class="dropdown">
            <a href="credit-audit.html">额度管理</a>
            <div class="dropdown-content">
              <a href="credit-audit.html">信用额度</a>
              <a href="credit-bill.html">额度账单</a>
            </div>
          </li>
          <li class="dropdown">
            <a href="../Public component/button.html" target="_blank">公共组件</a>
            <div class="dropdown-content">
              <a href="../Public component/button.html" target="_blank">充值转账组件</a>
              <a href="../Public component/payment.html" target="_blank">支付组件</a>
              <a href="../Public component/payment2.html" target="_blank">支付组件(三列)</a>
              <a href="../Public component/view.html" target="_blank">钱包余额组件</a>
            </div>
          </li>
          <li class="dropdown">
            <a href="exchange-rate-detail.html">汇率管理</a>
            <div class="dropdown-content">
              <a href="exchange-rate-detail.html">中国人民银行汇率</a>
              <a href="exchange-rate-config.html">汇率浮动配置</a>
              <a href="hqy-business-exchange.html">灏仟亿业务汇率</a>
            </div>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- 页面标题和描述 -->
    <div class="page-header">
      <h1 class="page-title">转账审核</h1>
      <p class="page-description">处理各子业务线的线下转账申请审核，包括匹配、确认和入账等审核流程</p>
    </div>

    <div class="search-section">
      <div class="search-row">
        <div class="search-group">
          <label>商户ID</label>
          <input type="text" class="search-input" placeholder="输入商户ID">
        </div>
        <div class="search-group">
          <label>商户邮箱</label>
          <input type="text" class="search-input" placeholder="输入商户邮箱">
        </div>
        <div class="search-group">
          <label>商户名称</label>
          <input type="text" class="search-input" placeholder="输入商户名称">
        </div>
        <div class="search-group">
          <label>子业务名称</label>
          <select class="search-input">
            <option value="">全部业务</option>
            <option value="advertising">Advertising</option>
            <option value="fulfillment">Fulfillment</option>
          </select>
        </div>
        <div class="search-group">
          <label>审核状态</label>
          <select class="search-input">
            <option value="">全部状态</option>
            <option value="pending">待匹配</option>
            <option value="confirm">待确认</option>
            <option value="approved">审核通过</option>
            <option value="rejected">审核失败</option>
          </select>
        </div>
        <div class="search-group">
          <label>提交时间</label>
          <input type="date" class="search-input">
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-primary">搜索</button>
          <button class="btn btn-secondary">重置</button>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title">转账申请列表</h3>
        <div class="batch-actions">
          <button class="btn btn-danger btn-small" onclick="batchReject()">批量拒绝</button>
        </div>
      </div>
      
      <div class="table-wrapper">
        <table class="transfer-table">
          <thead>
            <tr>
              <th width="40px"><input type="checkbox" id="selectAll"></th>
              <th width="120px">商户ID</th>
              <th width="150px">商户邮箱</th>
              <th width="120px">商户名称</th>
              <th width="120px">提交时间</th>
              <th width="80px">审核状态</th>
              <th width="100px">预充状态</th>
              <th width="80px">预充币种</th>
              <th width="100px">预充金额</th>
              <th width="100px">子业务</th>
              <th width="100px">转账平台</th>
              <th width="120px">转账凭证号</th>
              <th width="80px">转账截图</th>
              <th width="120px">匹配时间</th>
              <th width="80px">匹配人员</th>
              <th width="150px">匹配备注</th>
              <th width="120px">确认时间</th>
              <th width="80px">确认人</th>
              <th width="80px">入账币种</th>
              <th width="100px">入账金额</th>
              <th width="150px">确认备注</th>
              <th width="150px">操作</th>
            </tr>
          </thead>
          <tbody>
            <tr data-status="待匹配" data-precharge-status="无预充">
              <td><input type="checkbox" class="row-select"></td>
              <td>US001</td>
              <td>contact@apple.com</td>
              <td>Apple Inc.</td>
              <td>2024-01-15 14:30</td>
              <td><span class="status-badge status-pending">待匹配</span></td>
              <td><span class="status-badge precharge-none">无预充</span></td>
              <td>-</td>
              <td>-</td>
              <td><span class="business-tag">Advertising</span></td>
              <td><span class="platform-tag">Wise</span></td>
              <td>WS202401150001</td>
              <td><a href="#" class="screenshot-link" onclick="viewScreenshot('screenshot1.jpg')">查看</a></td>
              <td>-</td>
              <td>-</td>
              <td class="audit-remark">-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td class="audit-remark">-</td>
              <td>
                <div class="action-buttons">
                  <button class="btn btn-primary btn-small" onclick="openPrecharge(this)">预充</button>
                  <button class="btn btn-primary btn-small" onclick="openMatch('match', this)">匹配</button>
                </div>
              </td>
            </tr>
            <tr data-status="待确认" data-precharge-status="无预充">
              <td><input type="checkbox" class="row-select"></td>
              <td>US002</td>
              <td>service@microsoft.com</td>
              <td>Microsoft Corporation</td>
              <td>2024-01-15 16:45</td>
              <td><span class="status-badge status-confirm">待确认</span></td>
              <td><span class="status-badge precharge-none">无预充</span></td>
              <td>-</td>
              <td>-</td>
              <td><span class="business-tag">Fulfillment</span></td>
              <td><span class="platform-tag">PayPal</span></td>
              <td>PP202401150002</td>
              <td><a href="#" class="screenshot-link" onclick="viewScreenshot('screenshot2.jpg')">查看</a></td>
              <td>2024-01-15 17:30</td>
              <td>张经理</td>
              <td class="audit-remark">已匹配到收款记录</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td class="audit-remark">-</td>
              <td>
                <div class="action-buttons">
                  <button class="btn btn-success btn-small" onclick="openConfirm('confirm', this)">确认</button>
                </div>
              </td>
            </tr>
            <tr data-status="审核通过" data-precharge-status="无预充">
              <td><input type="checkbox" class="row-select" disabled></td>
              <td>US003</td>
              <td>contact@google.com</td>
              <td>Google LLC</td>
              <td>2024-01-14 09:20</td>
              <td><span class="status-badge status-approved">审核通过</span></td>
              <td><span class="status-badge precharge-none">无预充</span></td>
              <td>-</td>
              <td>-</td>
              <td><span class="business-tag">Advertising</span></td>
              <td><span class="platform-tag">Bank Transfer</span></td>
              <td>BT202401140001</td>
              <td><a href="#" class="screenshot-link" onclick="viewScreenshot('screenshot3.jpg')">查看</a></td>
              <td>2024-01-14 14:30</td>
              <td>李经理</td>
              <td class="audit-remark">匹配成功</td>
              <td>2024-01-14 15:30</td>
              <td>张经理</td>
              <td>USD</td>
              <td class="amount-large amount-positive">80,000</td>
              <td class="audit-remark">客户信用良好，业务稳定，同意入账</td>
              <td>
                <div class="action-buttons">
                </div>
              </td>
            </tr>
            <tr data-status="审核失败" data-precharge-status="无预充">
              <td><input type="checkbox" class="row-select" disabled></td>
              <td>US001</td>
              <td>contact@apple.com</td>
              <td>Apple Inc.</td>
              <td>2024-01-13 11:15</td>
              <td><span class="status-badge status-rejected">审核失败</span></td>
              <td><span class="status-badge precharge-none">无预充</span></td>
              <td>-</td>
              <td>-</td>
              <td><span class="business-tag">Fulfillment</span></td>
              <td><span class="platform-tag">Wise</span></td>
              <td>WS202401130001</td>
              <td><a href="#" class="screenshot-link" onclick="viewScreenshot('screenshot4.jpg')">查看</a></td>
              <td>-</td>
              <td>-</td>
              <td class="audit-remark">-</td>
              <td>2024-01-13 17:20</td>
              <td>李经理</td>
              <td>-</td>
              <td>-</td>
              <td class="audit-remark">转账截图不清晰，无法确认真实性</td>
              <td>
                <div class="action-buttons">
                </div>
              </td>
            </tr>
            <!-- 预充成功 + 待匹配 -->
            <tr data-status="待匹配" data-precharge-status="预充成功">
              <td><input type="checkbox" class="row-select"></td>
              <td>US004</td>
              <td>finance@amazon.com</td>
              <td>Amazon.com Inc.</td>
              <td>2024-01-16 10:20</td>
              <td><span class="status-badge status-pending">待匹配</span></td>
              <td><span class="status-badge precharge-success">预充成功</span></td>
              <td>USD</td>
              <td class="amount-large amount-positive">15,000</td>
              <td><span class="business-tag">Advertising</span></td>
              <td><span class="platform-tag">Stripe</span></td>
              <td>ST202401160001</td>
              <td><a href="#" class="screenshot-link" onclick="viewScreenshot('screenshot5.jpg')">查看</a></td>
              <td>-</td>
              <td>-</td>
              <td class="audit-remark">-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td class="audit-remark">-</td>
              <td>
                <div class="action-buttons">
                  <button class="btn btn-primary btn-small" onclick="openMatch('match', this)">匹配</button>
                </div>
              </td>
            </tr>
            <!-- 预充成功 + 待确认 -->
            <tr data-status="待确认" data-precharge-status="预充成功">
              <td><input type="checkbox" class="row-select"></td>
              <td>US005</td>
              <td>payment@meta.com</td>
              <td>Meta Platforms Inc.</td>
              <td>2024-01-16 11:30</td>
              <td><span class="status-badge status-confirm">待确认</span></td>
              <td><span class="status-badge precharge-success">预充成功</span></td>
              <td>USD</td>
              <td class="amount-large amount-positive">25,000</td>
              <td><span class="business-tag">Fulfillment</span></td>
              <td><span class="platform-tag">PayPal</span></td>
              <td>PP202401160002</td>
              <td><a href="#" class="screenshot-link" onclick="viewScreenshot('screenshot6.jpg')">查看</a></td>
              <td>2024-01-16 12:00</td>
              <td>王经理</td>
              <td class="audit-remark">已匹配到收款记录</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td class="audit-remark">-</td>
              <td>
                <div class="action-buttons">
                  <button class="btn btn-success btn-small" onclick="openConfirm('confirm', this)">确认</button>
                </div>
              </td>
            </tr>
            <!-- 预充成功 + 审核通过 -->
            <tr data-status="审核通过" data-precharge-status="预充成功">
              <td><input type="checkbox" class="row-select" disabled></td>
              <td>US006</td>
              <td>accounting@tesla.com</td>
              <td>Tesla Inc.</td>
              <td>2024-01-15 08:15</td>
              <td><span class="status-badge status-approved">审核通过</span></td>
              <td><span class="status-badge precharge-success">预充成功</span></td>
              <td>USD</td>
              <td class="amount-large amount-positive">30,000</td>
              <td><span class="business-tag">Advertising</span></td>
              <td><span class="platform-tag">Wise</span></td>
              <td>WS202401150003</td>
              <td><a href="#" class="screenshot-link" onclick="viewScreenshot('screenshot7.jpg')">查看</a></td>
              <td>2024-01-15 09:30</td>
              <td>赵经理</td>
              <td class="audit-remark">匹配成功</td>
              <td>2024-01-15 10:00</td>
              <td>钱经理</td>
              <td>USD</td>
              <td class="amount-large amount-positive">100,000</td>
              <td class="audit-remark">预充已成功，确认入账</td>
              <td>
                <div class="action-buttons">
                </div>
              </td>
            </tr>
            <!-- 预充失败 + 待匹配（可以重新申请） -->
            <tr data-status="待匹配" data-precharge-status="预充失败">
              <td><input type="checkbox" class="row-select"></td>
              <td>US007</td>
              <td>finance@netflix.com</td>
              <td>Netflix Inc.</td>
              <td>2024-01-16 13:45</td>
              <td><span class="status-badge status-pending">待匹配</span></td>
              <td><span class="status-badge precharge-failed">预充失败</span></td>
              <td>USD</td>
              <td class="amount-large amount-negative">50,000</td>
              <td><span class="business-tag">Fulfillment</span></td>
              <td><span class="platform-tag">Bank Transfer</span></td>
              <td>BT202401160001</td>
              <td><a href="#" class="screenshot-link" onclick="viewScreenshot('screenshot8.jpg')">查看</a></td>
              <td>-</td>
              <td>-</td>
              <td class="audit-remark">-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td class="audit-remark">-</td>
              <td>
                <div class="action-buttons">
                  <button class="btn btn-primary btn-small" onclick="openPrecharge(this)">预充</button>
                  <button class="btn btn-primary btn-small" onclick="openMatch('match', this)">匹配</button>
                </div>
              </td>
            </tr>
            <!-- 预充取消 + 审核通过（因为审核通过导致预充被取消） -->
            <tr data-status="审核通过" data-precharge-status="预充取消">
              <td><input type="checkbox" class="row-select" disabled></td>
              <td>US008</td>
              <td>payment@nvidia.com</td>
              <td>NVIDIA Corporation</td>
              <td>2024-01-14 15:20</td>
              <td><span class="status-badge status-approved">审核通过</span></td>
              <td><span class="status-badge precharge-canceled">预充取消</span></td>
              <td>USD</td>
              <td class="amount-large">20,000</td>
              <td><span class="business-tag">Advertising</span></td>
              <td><span class="platform-tag">Stripe</span></td>
              <td>ST202401140002</td>
              <td><a href="#" class="screenshot-link" onclick="viewScreenshot('screenshot9.jpg')">查看</a></td>
              <td>2024-01-14 16:00</td>
              <td>孙经理</td>
              <td class="audit-remark">匹配成功</td>
              <td>2024-01-14 16:30</td>
              <td>周经理</td>
              <td>USD</td>
              <td class="amount-large amount-positive">60,000</td>
              <td class="audit-remark">审核通过，预充申请已取消</td>
              <td>
                <div class="action-buttons">
                </div>
              </td>
            </tr>
            <!-- 预充取消 + 审核失败（因为审核失败导致预充被取消） -->
            <tr data-status="审核失败" data-precharge-status="预充取消">
              <td><input type="checkbox" class="row-select" disabled></td>
              <td>US009</td>
              <td>accounting@oracle.com</td>
              <td>Oracle Corporation</td>
              <td>2024-01-13 14:10</td>
              <td><span class="status-badge status-rejected">审核失败</span></td>
              <td><span class="status-badge precharge-canceled">预充取消</span></td>
              <td>USD</td>
              <td class="amount-large">18,000</td>
              <td><span class="business-tag">Fulfillment</span></td>
              <td><span class="platform-tag">PayPal</span></td>
              <td>PP202401130002</td>
              <td><a href="#" class="screenshot-link" onclick="viewScreenshot('screenshot10.jpg')">查看</a></td>
              <td>-</td>
              <td>-</td>
              <td class="audit-remark">-</td>
              <td>2024-01-13 18:00</td>
              <td>吴经理</td>
              <td>-</td>
              <td>-</td>
              <td class="audit-remark">转账信息不匹配，预充申请已取消</td>
              <td>
                <div class="action-buttons">
                </div>
              </td>
            </tr>
            <!-- 预充申请中 + 待匹配（正在审批中） -->
            <tr data-status="待匹配" data-precharge-status="预充申请中">
              <td><input type="checkbox" class="row-select"></td>
              <td>US010</td>
              <td>finance@adobe.com</td>
              <td>Adobe Inc.</td>
              <td>2024-01-17 09:00</td>
              <td><span class="status-badge status-pending">待匹配</span></td>
              <td><span class="status-badge precharge-applying">预充申请中</span></td>
              <td>USD</td>
              <td class="amount-large">80,000</td>
              <td><span class="business-tag">Advertising</span></td>
              <td><span class="platform-tag">Wise</span></td>
              <td>WS202401170001</td>
              <td><a href="#" class="screenshot-link" onclick="viewScreenshot('screenshot11.jpg')">查看</a></td>
              <td>-</td>
              <td>-</td>
              <td class="audit-remark">-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td class="audit-remark">-</td>
              <td>
                <div class="action-buttons">
                  <button class="btn btn-primary btn-small" onclick="openMatch('match', this)">匹配</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="pagination-container">
        <div class="pagination-left">
          <div class="pagination-controls">
            <span>每页显示：</span>
            <select id="pageSize" class="page-size-select">
              <option value="10">10条</option>
              <option value="20">20条</option>
              <option value="50">50条</option>
              <option value="100">100条</option>
            </select>
          </div>
          <div class="pagination-info">
            <span id="paginationInfo">显示第 1-4 条，共 4 条记录</span>
          </div>
        </div>
        <div class="pagination">
          <button id="firstPage" class="pagination-btn">首页</button>
          <button id="prevPage" class="pagination-btn">上一页</button>
          <div id="pageNumbers" class="page-numbers"></div>
          <button id="nextPage" class="pagination-btn">下一页</button>
          <button id="lastPage" class="pagination-btn">末页</button>
          <div class="page-jump">
            <span>跳转到</span>
            <input type="number" id="jumpToPage" class="jump-input" min="1" placeholder="页码">
            <button id="jumpBtn" class="jump-btn">跳转</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 详情模态框 -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">转账申请详情</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div class="detail-section">
        <h4>账户信息</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">商户ID</span>
            <span class="detail-value" id="detail-entity-id">US001</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">商户邮箱</span>
            <span class="detail-value" id="detail-email">contact@apple.com</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">商户名称</span>
            <span class="detail-value" id="detail-entity-name">Apple Inc.</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">子业务名称</span>
            <span class="detail-value" id="detail-business">Advertising</span>
          </div>
        </div>
      </div>
      <div class="detail-section">
        <h4>转账信息</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">转账平台</span>
            <span class="detail-value" id="detail-platform">Wise</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">转账凭证号</span>
            <span class="detail-value" id="detail-voucher">WS202401150001</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">转账币种</span>
            <span class="detail-value" id="detail-currency">USD</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">转账金额</span>
            <span class="detail-value amount-positive" id="detail-amount">50,000</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">提交时间</span>
            <span class="detail-value" id="detail-submit-time">2024-01-15 14:30</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">审核状态</span>
            <span class="detail-value" id="detail-status">待审核</span>
          </div>
        </div>
      </div>
      <div class="detail-section">
        <h4>转账截图</h4>
        <div style="text-align: center;">
          <img src="#" alt="转账截图" class="screenshot-preview" id="detail-screenshot" style="display: none;">
          <p id="no-screenshot" style="color: #64748b;">暂无截图</p>
        </div>
      </div>
      <div class="detail-section" id="audit-info" style="display: none;">
        <h4>审核信息</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">审核时间</span>
            <span class="detail-value" id="detail-audit-time">-</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">审核人</span>
            <span class="detail-value" id="detail-auditor">-</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">入账币种</span>
            <span class="detail-value" id="detail-credit-currency">-</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">入账金额</span>
            <span class="detail-value" id="detail-credit-amount">-</span>
          </div>
        </div>
      </div>
      <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
        <button class="btn btn-secondary" onclick="closeModal()">关闭</button>
      </div>
    </div>
  </div>

  <!-- 匹配弹窗 -->
  <div class="modal" id="matchModal">
    <div class="modal-content" style="max-width:900px;">
      <div class="modal-header">
        <h2 class="modal-title">匹配转账申请</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div class="detail-section">
        <h4>客户上传的转账信息</h4>
        <div class="detail-grid">
          <div class="detail-item"><span class="detail-label">商户ID</span><span class="detail-value" id="m-entity"></span></div>
          <div class="detail-item"><span class="detail-label">商户邮箱</span><span class="detail-value" id="m-email"></span></div>
          <div class="detail-item"><span class="detail-label">商户名称</span><span class="detail-value" id="m-name"></span></div>
          <div class="detail-item"><span class="detail-label">子业务</span><span class="detail-value" id="m-biz"></span></div>
          <div class="detail-item"><span class="detail-label">支付平台</span><span class="detail-value" id="m-platform"></span></div>
          <div class="detail-item"><span class="detail-label">转账凭证号</span><span class="detail-value" id="m-voucher"></span></div>
        </div>
        <div style="margin-top:8px;">
          <button class="btn btn-secondary btn-small" id="m-attachBtn" type="button">预览附件</button>
        </div>
      </div>
      <div class="detail-section" id="m-candSection">
        <h4>我司收款账户的交易信息（同支付平台）</h4>
        <div id="m-candList">
          <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
            <input class="form-input" id="m-tx" placeholder="交易ID（关键词）" style="padding:6px 10px; height:34px; width:180px;">
            <select class="form-input" id="m-ccySel" style="padding:6px 10px; height:34px; width:140px;">
              <option value="">币种（全部）</option><option>USD</option><option>EUR</option><option>GBP</option><option>CHF</option>
            </select>
            <input class="form-input" id="m-min" placeholder="金额最小" style="padding:6px 10px; height:34px; width:120px;">
            <input class="form-input" id="m-max" placeholder="金额最大" style="padding:6px 10px; height:34px; width:120px;">
            <button class="btn btn-primary btn-small" id="btnMatchSearch" type="button">筛选</button>
          </div>
          <div class="table-wrap" style="max-height:38vh; overflow:auto; border:1px solid #e5e7eb; border-radius:8px;">
            <table class="transfer-table" style="min-width:1200px; position:static;">
              <thead>
                <tr>
                  <th width="40px"></th>
                  <th>支付平台</th>
                  <th>账户别名</th>
                  <th>交易ID</th>
                  <th>交易时间</th>
                  <th>收款币种</th>
                  <th>收款金额</th>
                  <th>付款方信息</th>
                  <th>认领状态</th>
                  <th>数据来源</th>
                </tr>
              </thead>
              <tbody id="m-candTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="detail-section">
        <h4>匹配操作</h4>
        <div class="form-group">
          <label>操作类型</label>
          <div style="display:flex; gap:20px; margin-bottom:15px;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="radio" name="matchAction" value="pass" id="m-action-pass" checked>
              <span>通过</span>
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="radio" name="matchAction" value="return" id="m-action-return">
              <span>退回</span>
            </label>
          </div>
        </div>
        <div class="form-group" id="m-return-warning" style="display:none; padding:15px; background:#fef3c7; border:1px solid #f59e0b; border-radius:8px; margin-bottom:15px;">
          <div style="color:#92400e; font-weight:500; line-height:1.6;" id="m-return-text"></div>
        </div>
        <div class="form-group">
          <label>匹配备注（可选）</label>
          <textarea class="form-input" id="m-memo" rows="3" placeholder="匹配备注信息"></textarea>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
          <button class="btn btn-secondary" onclick="closeModal()">取消</button>
          <button class="btn btn-danger" id="m-return-btn" style="display:none;">退回</button>
          <button class="btn btn-success" id="m-match-btn">匹配</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 确认弹窗 -->
  <div class="modal" id="confirmModal">
    <div class="modal-content" style="max-width:900px;">
      <div class="modal-header">
        <h2 class="modal-title">确认转账申请</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div class="detail-section">
        <h4>客户上传的转账信息</h4>
        <div class="detail-grid">
          <div class="detail-item"><span class="detail-label">商户ID</span><span class="detail-value" id="c-entity"></span></div>
          <div class="detail-item"><span class="detail-label">商户邮箱</span><span class="detail-value" id="c-email"></span></div>
          <div class="detail-item"><span class="detail-label">商户名称</span><span class="detail-value" id="c-name"></span></div>
          <div class="detail-item"><span class="detail-label">子业务</span><span class="detail-value" id="c-biz"></span></div>
          <div class="detail-item"><span class="detail-label">支付平台</span><span class="detail-value" id="c-platform"></span></div>
          <div class="detail-item"><span class="detail-label">转账凭证号</span><span class="detail-value" id="c-voucher"></span></div>
        </div>
      </div>
      <div class="detail-section">
        <h4>匹配的收款信息</h4>
        <div class="detail-grid">
          <div class="detail-item"><span class="detail-label">支付平台</span><span class="detail-value" id="c-matched-platform"></span></div>
          <div class="detail-item"><span class="detail-label">账户别名</span><span class="detail-value" id="c-matched-alias"></span></div>
          <div class="detail-item"><span class="detail-label">交易ID</span><span class="detail-value" id="c-matched-txid"></span></div>
          <div class="detail-item"><span class="detail-label">交易时间</span><span class="detail-value" id="c-matched-time"></span></div>
          <div class="detail-item"><span class="detail-label">收款币种</span><span class="detail-value" id="c-matched-ccy"></span></div>
          <div class="detail-item"><span class="detail-label">收款金额</span><span class="detail-value" id="c-matched-amount"></span></div>
        </div>
      </div>
      <div class="detail-section">
        <h4>客户历史确认入账记录</h4>
        <div class="table-wrap" style="max-height:200px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px;">
          <table class="transfer-table" style="min-width:800px; position:static;">
            <thead>
              <tr>
                <th>确认时间</th>
                <th>入账币种</th>
                <th>入账金额</th>
                <th>确认人</th>
                <th>备注</th>
              </tr>
            </thead>
            <tbody id="c-historyTbody">
              <tr>
                <td>2024-01-10 15:30</td>
                <td>USD</td>
                <td>25,000</td>
                <td>张经理</td>
                <td>正常入账</td>
              </tr>
              <tr>
                <td>2024-01-08 10:20</td>
                <td>USD</td>
                <td>15,000</td>
                <td>李经理</td>
                <td>快速确认</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="detail-section">
        <h4>确认入账</h4>
        <div class="form-row">
          <div class="form-group">
            <label>*入账金额（该金额会入账到商户对应业务的钱包）</label>
            <input type="number" class="form-input" id="c-amt" placeholder="请输入入账金额" min="0" step="0.01">
          </div>
        </div>
        <div class="form-group">
          <label>确认备注（可选）</label>
          <textarea class="form-input" id="c-memo" rows="3" placeholder="确认备注信息"></textarea>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
          <button class="btn btn-danger" id="c-reject">拒绝</button>
          <button class="btn btn-success" id="c-confirm">确认</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 处理弹窗：用于"匹配并处理/查看并处理" -->
  <div class="modal" id="processModal">
    <div class="modal-content" style="max-width:900px;">
      <div class="modal-header">
        <h2 class="modal-title" id="processTitle">处理转账申请</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div class="detail-section">
        <h4>客户上传的转账信息</h4>
        <div class="detail-grid">
          <div class="detail-item"><span class="detail-label">商户ID</span><span class="detail-value" id="p-entity"></span></div>
          <div class="detail-item"><span class="detail-label">商户邮箱</span><span class="detail-value" id="p-email"></span></div>
          <div class="detail-item"><span class="detail-label">商户名称</span><span class="detail-value" id="p-name"></span></div>
          <div class="detail-item"><span class="detail-label">子业务</span><span class="detail-value" id="p-biz"></span></div>
          <div class="detail-item"><span class="detail-label">支付平台</span><span class="detail-value" id="p-platform"></span></div>
          <div class="detail-item"><span class="detail-label">转账凭证号</span><span class="detail-value" id="p-voucher"></span></div>
        </div>
        <div style="margin-top:8px;">
          <button class="btn btn-secondary btn-small" id="p-attachBtn" type="button">预览附件</button>
        </div>
      </div>
      <div class="detail-section">
        <h4>系统匹配到的收款信息</h4>
        <div id="p-candList">
          <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
            <select class="form-input" id="fPlatSel" style="padding:6px 10px; height:34px; width:160px;">
              <option value="">支付平台（全部）</option>
            </select>
            <input class="form-input" id="fTx" placeholder="交易ID（关键词）" style="padding:6px 10px; height:34px; width:180px;">
            <select class="form-input" id="fCcySel" style="padding:6px 10px; height:34px; width:140px;">
              <option value="">币种（全部）</option><option>USD</option><option>EUR</option><option>GBP</option><option>CHF</option>
            </select>
            <input class="form-input" id="fMin" placeholder="金额最小" style="padding:6px 10px; height:34px; width:120px;">
            <input class="form-input" id="fMax" placeholder="金额最大" style="padding:6px 10px; height:34px; width:120px;">
            <button class="btn btn-primary btn-small" id="btnCandSearch" type="button">筛选</button>
          </div>
          <div class="table-wrap" style="max-height:38vh; overflow:auto; border:1px solid #e5e7eb; border-radius:8px;">
            <table class="transfer-table" style="min-width:1200px; position:static;">
              <thead>
                <tr>
                  <th width="40px"></th>
                  <th>支付平台</th>
                  <th>账户别名</th>
                  <th>交易ID</th>
                  <th>交易时间</th>
                  <th>收款币种</th>
                  <th>收款金额</th>
                  <th>付款方信息</th>
                  <th>认领状态</th>
                  <th>数据来源</th>
                </tr>
              </thead>
              <tbody id="p-candTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="detail-section">
        <h4>确认入账</h4>
        <div class="form-row">
          <div class="form-group">
            <label>*入账金额（该金额会入账到商户对应业务的钱包）</label>
            <input type="number" class="form-input" id="p-amt" placeholder="请输入入账金额" min="0" step="0.01">
          </div>
        </div>
        <div class="form-group">
          <label>备注（可选）</label>
          <textarea class="form-input" id="p-memo" rows="3" placeholder="备注信息"></textarea>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
          <button class="btn btn-danger" id="p-reject">设为拒绝</button>
          <button class="btn btn-success" id="p-confirm">审核通过</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 截图查看模态框 -->
  <div class="modal" id="screenshotModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">转账截图</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div style="text-align: center;">
        <img src="#" alt="转账截图" style="max-width: 100%; max-height: 500px;" id="screenshot-preview">
      </div>
      <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
        <button class="btn btn-secondary" onclick="closeModal()">关闭</button>
      </div>
    </div>
  </div>

  <!-- 预充弹窗 -->
  <div class="modal" id="prechargeModal">
    <div class="modal-content" style="max-width:900px;">
      <div class="modal-header">
        <h2 class="modal-title">预充申请</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div class="detail-section">
        <h4>客户上传的转账信息</h4>
        <div class="detail-grid">
          <div class="detail-item"><span class="detail-label">商户ID</span><span class="detail-value" id="pc-entity"></span></div>
          <div class="detail-item"><span class="detail-label">商户邮箱</span><span class="detail-value" id="pc-email"></span></div>
          <div class="detail-item"><span class="detail-label">商户名称</span><span class="detail-value" id="pc-name"></span></div>
          <div class="detail-item"><span class="detail-label">子业务</span><span class="detail-value" id="pc-biz"></span></div>
          <div class="detail-item"><span class="detail-label">客户转账币种</span><span class="detail-value" id="pc-transfer-ccy"></span></div>
          <div class="detail-item"><span class="detail-label">客户转账金额</span><span class="detail-value" id="pc-transfer-amount"></span></div>
        </div>
        <div style="margin-top:8px;">
          <button class="btn btn-secondary btn-small" id="pc-attachBtn" type="button">预览附件</button>
        </div>
      </div>
      <div class="detail-section">
        <h4>客户预充额度信息</h4>
        <div class="detail-grid">
          <div class="detail-item"><span class="detail-label">客户预充上限币种</span><span class="detail-value" id="pc-limit-ccy"></span></div>
          <div class="detail-item"><span class="detail-label">客户预充上限金额</span><span class="detail-value amount-positive" id="pc-limit-amount"></span></div>
          <div class="detail-item"><span class="detail-label">客户已预充金额</span><span class="detail-value" id="pc-charged-amount"></span></div>
          <div class="detail-item"><span class="detail-label">客户预充申请中金额</span><span class="detail-value" id="pc-applying-amount"></span></div>
          <div class="detail-item" style="grid-column: 1 / -1; background: #eff6ff; border: 2px solid #2563eb;">
            <span class="detail-label" style="font-weight: 600; color: #1e40af;">客户可预充金额</span>
            <span class="detail-value" style="font-weight: 700; color: #1e40af; font-size: 18px;" id="pc-available-amount"></span>
          </div>
        </div>
      </div>
      <div class="detail-section">
        <h4>预充申请</h4>
        <div class="form-group">
          <label>*客户本次申请预充金额</label>
          <input type="number" class="form-input" id="pc-apply-amount" placeholder="请输入预充金额" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>*客户本次申请备注</label>
          <textarea class="form-input" id="pc-apply-remark" rows="3" placeholder="请输入备注信息（最多500字符）" maxlength="500"></textarea>
          <div style="text-align: right; margin-top: 4px; color: #64748b; font-size: 12px;">
            <span id="pc-remark-count">0</span>/500
          </div>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
          <button class="btn btn-secondary" onclick="closeModal()">取消</button>
          <button class="btn btn-primary" id="pc-submit">提交申请</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentAuditAction = '';
    let currentRow = null;

    // 模拟转账数据
    const transferData = {
      'WS202401150001': {
        entityId: 'US001',
        email: 'contact@apple.com',
        entityName: 'Apple Inc.',
        business: 'Advertising',
        platform: 'Wise',
        voucher: 'WS202401150001',
        currency: 'USD',
        amount: 50000,
        screenshot: 'screenshot1.jpg',
        submitTime: '2024-01-15 14:30',
        status: 'pending'
      },
      'PP202401150002': {
        entityId: 'US002',
        email: 'service@microsoft.com',
        entityName: 'Microsoft Corporation',
        business: 'Fulfillment',
        platform: 'PayPal',
        voucher: 'PP202401150002',
        currency: 'EUR',
        amount: 35000,
        screenshot: 'screenshot2.jpg',
        submitTime: '2024-01-15 16:45',
        status: 'pending'
      },
      'BT202401140001': {
        entityId: 'US003',
        email: 'contact@google.com',
        entityName: 'Google LLC',
        business: 'Advertising',
        platform: 'Bank Transfer',
        voucher: 'BT202401140001',
        currency: 'USD',
        amount: 80000,
        screenshot: 'screenshot3.jpg',
        submitTime: '2024-01-14 09:20',
        auditTime: '2024-01-14 15:30',
        auditor: '张经理',
        creditCurrency: 'USD',
        creditAmount: 80000,
        status: 'approved'
      },
      'WS202401130001': {
        entityId: 'US001',
        email: 'contact@apple.com',
        entityName: 'Apple Inc.',
        business: 'Fulfillment',
        platform: 'Wise',
        voucher: 'WS202401130001',
        currency: 'EUR',
        amount: 25000,
        screenshot: 'screenshot4.jpg',
        submitTime: '2024-01-13 11:15',
        auditTime: '2024-01-13 17:20',
        auditor: '李经理',
        rejectReason: '转账截图不清晰，无法确认真实性',
        status: 'rejected'
      }
    };

    function openModal(type, action = '', rowElement = null) {
      currentAuditAction = action;
      currentRow = rowElement;

      if (type === 'detail') {
        // 获取行数据
        const row = rowElement.closest('tr');
        const cells = row.querySelectorAll('td');
        
        document.getElementById('detail-entity-id').textContent = cells[1].textContent;
        document.getElementById('detail-email').textContent = cells[2].textContent;
        document.getElementById('detail-entity-name').textContent = cells[3].textContent;
        document.getElementById('detail-business').textContent = cells[9].textContent.trim();
        document.getElementById('detail-platform').textContent = cells[10].textContent.trim();
        document.getElementById('detail-voucher').textContent = cells[11].textContent;
        document.getElementById('detail-currency').textContent = cells[18].textContent;
        document.getElementById('detail-amount').textContent = cells[19].textContent;
        document.getElementById('detail-submit-time').textContent = cells[4].textContent;
        document.getElementById('detail-status').textContent = cells[5].textContent.trim();

        // 显示审核信息（如果已审核）
        if (cells[16].textContent !== '-') {
          document.getElementById('audit-info').style.display = 'block';
          document.getElementById('detail-audit-time').textContent = cells[16].textContent;
          document.getElementById('detail-auditor').textContent = cells[17].textContent;
          document.getElementById('detail-credit-currency').textContent = cells[18].textContent;
          document.getElementById('detail-credit-amount').textContent = cells[19].textContent;
        } else {
          document.getElementById('audit-info').style.display = 'none';
        }

        document.getElementById('detailModal').classList.add('show');
      }
    }

    // 打开匹配弹窗
    function openMatch(mode, btn){
      const row = btn.closest('tr');
      const cells = row.querySelectorAll('td');
      
      document.getElementById('m-entity').textContent = cells[1].textContent;
      document.getElementById('m-email').textContent = cells[2].textContent;
      document.getElementById('m-name').textContent = cells[3].textContent;
      document.getElementById('m-biz').textContent = cells[9].textContent.trim();
      document.getElementById('m-platform').textContent = cells[10].textContent.trim();
      document.getElementById('m-voucher').textContent = cells[11].textContent;
      
      // 附件预览按钮
      document.getElementById('m-attachBtn').onclick = ()=>{
        const voucher = cells[11].textContent;
        const info = (window.transferData||{})[voucher];
        if(info && info.screenshot){ viewScreenshot(info.screenshot); }
        else { alert('无附件'); }
      };

      // 从 localStorage 读取收款明细；若为空则尝试回填默认数据
      let ledger = [];
      try{ ledger = JSON.parse(localStorage.getItem('receivingLedgerRows')||'[]'); }catch(err){ ledger = []; }
      const currentPlatform = cells[10].textContent.trim();
      // 若不存在数据，尝试从回退数据源初始化（与收款明细页保持一致的key）
      if(!Array.isArray(ledger) || ledger.length===0){
        // 若页面预先注入了 receivingLedgerData（可选），则写入本地缓存
        if(Array.isArray(window.receivingLedgerData) && window.receivingLedgerData.length>0){
          try{
            localStorage.setItem('receivingLedgerRows', JSON.stringify(window.receivingLedgerData));
            ledger = [...window.receivingLedgerData];
            console.log('[转账审核] 已从 window.receivingLedgerData 回填收款明细，条数:', ledger.length);
          }catch(err){ ledger = []; }
        }
      }

      // 标准化平台名称后再过滤（避免空格/大小写导致的不一致）
      const norm = (v)=>String(v||'').trim();
      ledger = (ledger||[]).filter(x => norm(x.platform) === norm(currentPlatform));

      document.getElementById('m-memo').value = '';
      
      // 重置操作类型为"通过"
      document.getElementById('m-action-pass').checked = true;
      document.getElementById('m-action-return').checked = false;
      document.getElementById('m-candSection').style.display = 'block';
      document.getElementById('m-return-warning').style.display = 'none';
      document.getElementById('m-match-btn').style.display = 'inline-block';
      document.getElementById('m-return-btn').style.display = 'none';
      
      // 获取预充状态和预充金额
      const prechargeStatus = row.dataset.prechargeStatus || '无预充';
      const prechargeCurrency = cells[7].textContent.trim();
      const prechargeAmountText = cells[8].textContent.trim();
      const prechargeAmount = prechargeAmountText !== '-' ? parseFloat(prechargeAmountText.replace(/,/g, '')) : 0;
      
      // 模拟客户可用余额（实际应从账户管理获取）
      const entityId = cells[1].textContent;
      const mockCustomerBalance = {
        'US001': { availableBalance: 50000 },
        'US002': { availableBalance: 30000 },
        'US003': { availableBalance: 100000 },
        'US004': { availableBalance: 20000 },
        'US005': { availableBalance: 35000 },
        'US006': { availableBalance: 80000 },
        'US007': { availableBalance: 10000 },
        'US008': { availableBalance: 15000 },
        'US009': { availableBalance: 5000 },
        'US010': { availableBalance: 120000 }
      };
      const customerBalance = mockCustomerBalance[entityId] || { availableBalance: 0 };
      const availableBalance = customerBalance.availableBalance;
      
      // 操作类型切换事件
      function updateMatchAction() {
        const action = document.querySelector('input[name="matchAction"]:checked').value;
        if(action === 'pass'){
          // 通过：显示收款信息区域，隐藏退回提示
          document.getElementById('m-candSection').style.display = 'block';
          document.getElementById('m-return-warning').style.display = 'none';
          document.getElementById('m-match-btn').style.display = 'inline-block';
          document.getElementById('m-return-btn').style.display = 'none';
        } else {
          // 退回：隐藏收款信息区域，显示退回提示
          document.getElementById('m-candSection').style.display = 'none';
          document.getElementById('m-return-warning').style.display = 'block';
          document.getElementById('m-match-btn').style.display = 'none';
          document.getElementById('m-return-btn').style.display = 'inline-block';
          
          // 根据预充状态和可用余额显示提示文本
          let warningText = '';
          if(prechargeStatus === '预充成功'){
            if(availableBalance >= prechargeAmount){
              // 可用余额充足，可以回收
              warningText = `该转账审核已预充客户【${prechargeAmount.toLocaleString()} ${prechargeCurrency}】，退回转账审核将从客户钱包扣除【${prechargeAmount.toLocaleString()} ${prechargeCurrency}】，请知悉。`;
            } else {
              // 可用余额不足，记录坏账
              warningText = `该转账审核已预充客户【${prechargeAmount.toLocaleString()} ${prechargeCurrency}】，客户可用余额为【${availableBalance.toLocaleString()} ${prechargeCurrency}】，无法回收预充金额，将记录坏账，并发送飞书通知，请知悉。`;
            }
          } else {
            // 无预充或其他状态，正常退回
            warningText = '确认退回该转账审核申请？';
          }
          document.getElementById('m-return-text').textContent = warningText;
        }
      }
      
      document.getElementById('m-action-pass').addEventListener('change', updateMatchAction);
      document.getElementById('m-action-return').addEventListener('change', updateMatchAction);
      
      // 初始化显示
      updateMatchAction();

      // 列表渲染
      const tbody = document.getElementById('m-candTbody');
      let pickedRow = null;
      function renderTable(list){
        tbody.innerHTML = '';
        if(!list || list.length===0){
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="10" style="color:#64748b;">未找到可匹配的收款记录，请先在"收款明细"页加载数据或调整筛选条件</td>';
          tbody.appendChild(tr);
          return;
        }
        list.forEach(c=>{
          const tr = document.createElement('tr');
          const disabled = c.claim !== '待认领';
          tr.innerHTML = `
            <td><input type="radio" name="matchRadio" value="${c.id}" ${disabled?'disabled':''}></td>
            <td>${c.platform}</td>
            <td>${c.alias||'-'}</td>
            <td>${c.txId||'-'}</td>
            <td>${c.time||'-'}</td>
            <td>${c.ccy||'-'}</td>
            <td>${Number(c.amount).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}</td>
            <td>${c.payer||'-'}</td>
            <td>${c.claim||'-'}</td>
            <td>${c.source||'-'}</td>`;
          tbody.appendChild(tr);
        });
      }
      function doFilter(){
        const tx = (document.getElementById('m-tx').value||'').trim().toLowerCase();
        const ccy = (document.getElementById('m-ccySel').value||'').trim().toUpperCase();
        const min = parseFloat((document.getElementById('m-min').value||'').trim());
        const max = parseFloat((document.getElementById('m-max').value||'').trim());
        return ledger.filter(x=>
          (!tx || (x.txId||'').toLowerCase().includes(tx)) &&
          (!ccy || (x.ccy||'').toUpperCase()===ccy) &&
          (isNaN(min) || Number(x.amount)>=min) &&
          (isNaN(max) || Number(x.amount)<=max)
        );
      }
      renderTable(doFilter());
      document.getElementById('btnMatchSearch').onclick = ()=>{ renderTable(doFilter()); };
      tbody.addEventListener('change', (e)=>{
        const r = e.target.closest('input[type="radio"][name="matchRadio"]');
        if(!r) return;
        const id = r.value;
        pickedRow = ledger.find(x=> String(x.id)===String(id));
      });

      // 匹配按钮（通过操作）
      document.getElementById('m-match-btn').onclick = ()=>{
        if(!pickedRow){ alert('请选择一条收款信息'); return; }
        const memo = document.getElementById('m-memo').value.trim();
        
        // 更新审核状态为待确认
        const statusBadges = row.querySelectorAll('.status-badge');
        statusBadges[0].textContent = '待确认';
        statusBadges[0].className = 'status-badge status-confirm';
        row.dataset.status = '待确认';
        const tds = row.querySelectorAll('td');
        tds[13].textContent = new Date().toLocaleString('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).replace(/\//g,'-');
        tds[14].textContent = '当前用户';
        tds[15].textContent = memo || '已匹配到收款记录';
        
        // 存储匹配信息到行数据
        row.dataset.matchedData = JSON.stringify(pickedRow);
        
        // 检查是否需要中断预充申请
        checkPrechargeInterrupt(row);
        
        document.getElementById('matchModal').classList.remove('show');
      };
      
      // 退回按钮
      document.getElementById('m-return-btn').onclick = ()=>{
        const memo = document.getElementById('m-memo').value.trim();
        const prechargeStatus = row.dataset.prechargeStatus || '无预充';
        const prechargeCurrency = cells[7].textContent.trim();
        const prechargeAmountText = cells[8].textContent.trim();
        const prechargeAmount = prechargeAmountText !== '-' ? parseFloat(prechargeAmountText.replace(/,/g, '')) : 0;
        const availableBalance = customerBalance.availableBalance;
        
        // 确认退回
        let confirmMsg = '确认退回该转账审核申请？';
        if(prechargeStatus === '预充成功'){
          if(availableBalance >= prechargeAmount){
            confirmMsg = `确认退回？将从客户钱包扣除【${prechargeAmount.toLocaleString()} ${prechargeCurrency}】。`;
          } else {
            confirmMsg = `确认退回？将记录坏账并发送飞书通知。`;
          }
        }
        
        if(!confirm(confirmMsg)){
          return;
        }
        
        // 执行退回操作
        const statusBadges = row.querySelectorAll('.status-badge');
        statusBadges[0].textContent = '审核失败';
        statusBadges[0].className = 'status-badge status-rejected';
        row.dataset.status = '审核失败';
        const tds = row.querySelectorAll('td');
        tds[16].textContent = new Date().toLocaleString('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).replace(/\//g,'-');
        tds[17].textContent = '当前用户';
        tds[20].textContent = memo || '退回处理';
        
        // 如果预充成功且可用余额充足，执行预充回收
        if(prechargeStatus === '预充成功' && availableBalance >= prechargeAmount){
          // 这里应该调用API扣除客户钱包金额，变动类型为"预充回收"
          console.log(`预充回收：从客户钱包扣除 ${prechargeAmount.toLocaleString()} ${prechargeCurrency}`);
        } else if(prechargeStatus === '预充成功' && availableBalance < prechargeAmount){
          // 记录坏账并发送飞书通知
          console.log(`记录坏账：预充金额 ${prechargeAmount.toLocaleString()} ${prechargeCurrency}，可用余额 ${availableBalance.toLocaleString()} ${prechargeCurrency}`);
          alert('已记录坏账，飞书通知已发送');
        }
        
        // 检查是否需要中断预充申请
        checkPrechargeInterrupt(row);
        
        document.getElementById('matchModal').classList.remove('show');
      };
      
      document.getElementById('matchModal').classList.add('show');
    }

    // 打开确认弹窗
    function openConfirm(mode, btn){
      const row = btn.closest('tr');
      const cells = row.querySelectorAll('td');
      
      document.getElementById('c-entity').textContent = cells[1].textContent;
      document.getElementById('c-email').textContent = cells[2].textContent;
      document.getElementById('c-name').textContent = cells[3].textContent;
      document.getElementById('c-biz').textContent = cells[9].textContent.trim();
      document.getElementById('c-platform').textContent = cells[10].textContent.trim();
      document.getElementById('c-voucher').textContent = cells[11].textContent;
      
      // 显示匹配的收款信息
      const matchedData = row.dataset.matchedData ? JSON.parse(row.dataset.matchedData) : null;
      if(matchedData) {
        document.getElementById('c-matched-platform').textContent = matchedData.platform || '-';
        document.getElementById('c-matched-alias').textContent = matchedData.alias || '-';
        document.getElementById('c-matched-txid').textContent = matchedData.txId || '-';
        document.getElementById('c-matched-time').textContent = matchedData.time || '-';
        document.getElementById('c-matched-ccy').textContent = matchedData.ccy || '-';
        document.getElementById('c-matched-amount').textContent = Number(matchedData.amount).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
        
        // 默认填入匹配的金额
        document.getElementById('c-amt').value = matchedData.amount || '';
      }

      document.getElementById('c-memo').value = '';
      document.getElementById('confirmModal').classList.add('show');

      document.getElementById('c-confirm').onclick = ()=>{
        const inputAmt = parseFloat(document.getElementById('c-amt').value);
        if(isNaN(inputAmt) || inputAmt<=0){ alert('请输入有效入账金额'); return; }
        const memo = document.getElementById('c-memo').value.trim();
        
        // 更新审核状态为审核通过
        const statusBadges = row.querySelectorAll('.status-badge');
        statusBadges[0].textContent = '审核通过';
        statusBadges[0].className = 'status-badge status-approved';
        row.dataset.status = '审核通过';
        const tds = row.querySelectorAll('td');
        tds[16].textContent = new Date().toLocaleString('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).replace(/\//g,'-');
        tds[17].textContent = '当前用户';
        tds[18].textContent = matchedData ? matchedData.ccy : 'USD';
        tds[19].innerHTML = `<span class="amount-large amount-positive">${inputAmt.toLocaleString()}</span>`;
        tds[20].textContent = memo || '确认入账';

        // 回写收款明细为已认领
        if(matchedData) {
          try{
            const id = matchedData.id;
            let newLedger = JSON.parse(localStorage.getItem('receivingLedgerRows')||'[]');
            newLedger = newLedger.map(x=> x.id==id ? { ...x, claim:'已认领' } : x);
            localStorage.setItem('receivingLedgerRows', JSON.stringify(newLedger));
          }catch(err){}
        }
        
        // 检查是否需要中断预充申请
        checkPrechargeInterrupt(row);
        
        document.getElementById('confirmModal').classList.remove('show');
      };
      
      document.getElementById('c-reject').onclick = ()=>{
        const statusBadges = row.querySelectorAll('.status-badge');
        statusBadges[0].textContent = '审核失败';
        statusBadges[0].className = 'status-badge status-rejected';
        row.dataset.status = '审核失败';
        const tds = row.querySelectorAll('td');
        tds[16].textContent = new Date().toLocaleString('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).replace(/\//g,'-');
        tds[17].textContent = '当前用户';
        tds[20].textContent = '拒绝入账';
        
        // 检查是否需要中断预充申请
        checkPrechargeInterrupt(row);
        
        document.getElementById('confirmModal').classList.remove('show');
      };
    }

    // 打开预充弹窗
    function openPrecharge(btn){
      const row = btn.closest('tr');
      const cells = row.querySelectorAll('td');
      const auditStatus = row.dataset.status;
      const prechargeStatus = row.dataset.prechargeStatus || '无预充';
      
      // 只有待匹配状态才能预充
      if(auditStatus !== '待匹配'){
        alert('只有待匹配状态的转账申请才能进行预充操作');
        return;
      }
      
      // 预充失败状态可以重新申请
      if(prechargeStatus !== '无预充' && prechargeStatus !== '预充失败'){
        alert('当前预充状态不允许重新申请');
        return;
      }
      
      // 填充基本信息
      document.getElementById('pc-entity').textContent = cells[1].textContent;
      document.getElementById('pc-email').textContent = cells[2].textContent;
      document.getElementById('pc-name').textContent = cells[3].textContent;
      document.getElementById('pc-biz').textContent = cells[9].textContent.trim();
      
      // 获取转账信息（从transferData或行数据）
      const voucher = cells[11].textContent;
      const transferInfo = transferData[voucher] || {};
      document.getElementById('pc-transfer-ccy').textContent = transferInfo.currency || 'USD';
      document.getElementById('pc-transfer-amount').textContent = transferInfo.amount ? transferInfo.amount.toLocaleString() : '-';
      
      // 附件预览按钮
      document.getElementById('pc-attachBtn').onclick = ()=>{
        if(transferInfo.screenshot){ viewScreenshot(transferInfo.screenshot); }
        else { alert('无附件'); }
      };
      
      // 模拟客户预充额度数据（实际应从上游业务系统获取）
      const entityId = cells[1].textContent;
      const mockPrechargeData = {
        'US001': {
          limitCcy: 'USD',
          limitAmount: 100000,
          chargedAmount: 20000,  // 已预充金额（待匹配状态下的成功预充）
          applyingAmount: 5000   // 申请中金额（待匹配状态下的申请中预充）
        },
        'US002': {
          limitCcy: 'USD',
          limitAmount: 50000,
          chargedAmount: 10000,
          applyingAmount: 0
        },
        'US003': {
          limitCcy: 'USD',
          limitAmount: 200000,
          chargedAmount: 50000,
          applyingAmount: 10000
        }
      };
      
      const prechargeInfo = mockPrechargeData[entityId] || {
        limitCcy: 'USD',
        limitAmount: 0,
        chargedAmount: 0,
        applyingAmount: 0
      };
      
      // 填充预充额度信息
      document.getElementById('pc-limit-ccy').textContent = prechargeInfo.limitCcy;
      document.getElementById('pc-limit-amount').textContent = prechargeInfo.limitAmount.toLocaleString();
      document.getElementById('pc-charged-amount').textContent = prechargeInfo.chargedAmount.toLocaleString();
      document.getElementById('pc-applying-amount').textContent = prechargeInfo.applyingAmount.toLocaleString();
      
      // 计算可预充金额
      const availableAmount = prechargeInfo.limitAmount - prechargeInfo.chargedAmount - prechargeInfo.applyingAmount;
      document.getElementById('pc-available-amount').textContent = Math.max(0, availableAmount).toLocaleString();
      
      // 清空输入
      document.getElementById('pc-apply-amount').value = '';
      document.getElementById('pc-apply-remark').value = '';
      document.getElementById('pc-remark-count').textContent = '0';
      
      // 备注字数统计
      document.getElementById('pc-apply-remark').addEventListener('input', function(){
        document.getElementById('pc-remark-count').textContent = this.value.length;
      });
      
      // 显示弹窗
      document.getElementById('prechargeModal').classList.add('show');
      
      // 存储当前行和预充信息
      currentRow = row;
      window.currentPrechargeInfo = prechargeInfo;
      window.currentAvailableAmount = availableAmount;
      
      // 提交按钮事件
      const submitBtn = document.getElementById('pc-submit');
      submitBtn.onclick = function(){
        const applyAmount = parseFloat(document.getElementById('pc-apply-amount').value);
        const applyRemark = document.getElementById('pc-apply-remark').value.trim();
        
        // 验证
        if(isNaN(applyAmount) || applyAmount <= 0){
          alert('请输入有效的预充金额');
          return;
        }
        if(!applyRemark){
          alert('请输入预充备注');
          return;
        }
        if(applyRemark.length > 500){
          alert('备注不能超过500字符');
          return;
        }
        
        // 判断是否需要审批
        const needApproval = applyAmount > window.currentAvailableAmount;
        const prechargeCurrency = window.currentPrechargeInfo.limitCcy || 'USD';
        
        if(needApproval){
          // 需要飞书审批
          if(confirm(`申请金额 ${applyAmount.toLocaleString()} 超过可预充金额 ${window.currentAvailableAmount.toLocaleString()}，将触发飞书审批流程。是否继续？`)){
            // 更新状态为预充申请中
            updatePrechargeStatus(row, '预充申请中', prechargeCurrency, applyAmount);
            alert('预充申请已提交，等待飞书审批');
            document.getElementById('prechargeModal').classList.remove('show');
          }
        } else {
          // 立即成功
          if(confirm(`确认提交预充申请，金额：${applyAmount.toLocaleString()}？`)){
            // 更新状态为预充成功
            updatePrechargeStatus(row, '预充成功', prechargeCurrency, applyAmount);
            alert('预充成功！');
            document.getElementById('prechargeModal').classList.remove('show');
          }
        }
      };
    }
    
    // 更新预充状态
    function updatePrechargeStatus(row, status, currency = null, amount = null){
      const tds = row.querySelectorAll('td');
      const statusBadge = tds[6].querySelector('span.status-badge');
      if(statusBadge){
        statusBadge.textContent = status;
        statusBadge.className = 'status-badge ';
        switch(status){
          case '无预充':
            statusBadge.className += 'precharge-none';
            break;
          case '预充申请中':
            statusBadge.className += 'precharge-applying';
            break;
          case '预充成功':
            statusBadge.className += 'precharge-success';
            break;
          case '预充失败':
            statusBadge.className += 'precharge-failed';
            break;
          case '预充取消':
            statusBadge.className += 'precharge-canceled';
            break;
        }
      }
      
      // 更新预充币种和预充金额
      if(status === '无预充'){
        tds[7].textContent = '-';
        tds[8].textContent = '-';
      } else if(status === '预充取消'){
        // 预充取消时保留原有币种和金额显示
        if(currency && amount){
          tds[7].textContent = currency;
          tds[8].textContent = amount.toLocaleString();
        }
      } else {
        // 预充成功、预充失败、预充申请中时显示币种和金额
        if(currency && amount){
          tds[7].textContent = currency;
          if(status === '预充成功'){
            tds[8].innerHTML = `<span class="amount-large amount-positive">${amount.toLocaleString()}</span>`;
          } else if(status === '预充失败'){
            tds[8].innerHTML = `<span class="amount-large amount-negative">${amount.toLocaleString()}</span>`;
          } else {
            tds[8].innerHTML = `<span class="amount-large">${amount.toLocaleString()}</span>`;
          }
        } else {
          tds[7].textContent = '-';
          tds[8].textContent = '-';
        }
      }
      
      row.dataset.prechargeStatus = status;
      
      // 如果预充申请中，但转账审核状态变为已确认或审核失败，则中断预充申请
      const auditStatus = row.dataset.status;
      if(status === '预充申请中' && (auditStatus === '审核通过' || auditStatus === '审核失败')){
        // 保留原有币种和金额
        const oldCurrency = tds[7].textContent;
        const oldAmount = tds[8].textContent;
        updatePrechargeStatus(row, '预充取消', oldCurrency !== '-' ? oldCurrency : null, oldAmount !== '-' ? parseFloat(oldAmount.replace(/,/g, '')) : null);
      }
    }
    
    // 监听审核状态变化，自动中断预充申请
    function checkPrechargeInterrupt(row){
      const auditStatus = row.dataset.status;
      const prechargeStatus = row.dataset.prechargeStatus;
      if(prechargeStatus === '预充申请中' && (auditStatus === '审核通过' || auditStatus === '审核失败')){
        updatePrechargeStatus(row, '预充取消');
      }
    }

    // 打开处理弹窗
    function openProcess(mode, btn){
      const row = btn.closest('tr');
      const cells = row.querySelectorAll('td');
      document.getElementById('processTitle').textContent = '处理';
      document.getElementById('p-entity').textContent = cells[1].textContent;
      document.getElementById('p-email').textContent = cells[2].textContent;
      document.getElementById('p-name').textContent = cells[3].textContent;
      document.getElementById('p-biz').textContent = cells[9].textContent.trim();
      document.getElementById('p-platform').textContent = cells[10].textContent.trim();
      document.getElementById('p-voucher').textContent = cells[11].textContent;
      // 申报金额已移除
      // 附件预览按钮
      document.getElementById('p-attachBtn').onclick = ()=>{
        const voucher = cells[9].textContent;
        const info = (window.transferData||{})[voucher];
        if(info && info.screenshot){ viewScreenshot(info.screenshot); }
        else { alert('无附件'); }
      };
 
      // 从 localStorage 读取收款明细（包含已认领，用于展示；仅未认领可选）
      let ledger = [];
      try{ ledger = JSON.parse(localStorage.getItem('receivingLedgerRows')||'[]'); }catch(err){ ledger = []; }
      // 平台下拉
      const platSel = document.getElementById('fPlatSel');
      const plats = Array.from(new Set(ledger.map(x=>x.platform))).filter(Boolean);
      platSel.innerHTML = '<option value="">全部</option>' + plats.map(p=>`<option>${p}</option>`).join('');

      document.getElementById('p-amt').value = '';
      document.getElementById('p-memo').value = '';
      document.getElementById('processModal').classList.add('show');

      // 列表渲染
      const tbody = document.getElementById('p-candTbody');
      let pickedRow = null;
      function renderTable(list){
        tbody.innerHTML = '';
        list.forEach(c=>{
          const tr = document.createElement('tr');
          const disabled = c.claim !== '待认领';
          tr.innerHTML = `
            <td><input type="radio" name="candRadio" value="${c.id}" ${disabled?'disabled':''}></td>
            <td>${c.platform}</td>
            <td>${c.alias||'-'}</td>
            <td>${c.txId||'-'}</td>
            <td>${c.time||'-'}</td>
            <td>${c.ccy||'-'}</td>
            <td>${Number(c.amount).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}</td>
            <td>${c.payer||'-'}</td>
            <td>${c.claim||'-'}</td>
            <td>${c.source||'-'}</td>`;
          tbody.appendChild(tr);
        });
      }
      function doFilter(){
        const plat = platSel.value;
        const tx = (document.getElementById('fTx').value||'').trim().toLowerCase();
        const ccy = (document.getElementById('fCcySel').value||'').trim().toUpperCase();
        const min = parseFloat((document.getElementById('fMin').value||'').trim());
        const max = parseFloat((document.getElementById('fMax').value||'').trim());
        return ledger.filter(x=>
          (!plat || x.platform===plat) &&
          (!tx || (x.txId||'').toLowerCase().includes(tx)) &&
          (!ccy || (x.ccy||'').toUpperCase()===ccy) &&
          (isNaN(min) || Number(x.amount)>=min) &&
          (isNaN(max) || Number(x.amount)<=max)
        );
      }
      renderTable(doFilter());
      document.getElementById('btnCandSearch').onclick = ()=>{ renderTable(doFilter()); };
      tbody.addEventListener('change', (e)=>{
        const r = e.target.closest('input[type="radio"][name="candRadio"]');
        if(!r) return;
        const id = r.value;
        pickedRow = ledger.find(x=> String(x.id)===String(id));
        if(pickedRow){ document.getElementById('p-amt').value = Number(pickedRow.amount).toString(); }
      });

      document.getElementById('p-confirm').onclick = ()=>{
        if(!pickedRow){ alert('请选择一条收款信息'); return; }
        const inputAmt = parseFloat(document.getElementById('p-amt').value);
        if(isNaN(inputAmt) || inputAmt<=0){ alert('请输入有效入账金额'); return; }
        // 审核通过：更新当前行状态
        const statusBadges = row.querySelectorAll('.status-badge');
        statusBadges[0].textContent = '审核通过';
        statusBadges[0].className = 'status-badge status-approved';
        row.dataset.status = '审核通过';
        const tds = row.querySelectorAll('td');
        tds[13].textContent = new Date().toLocaleString('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).replace(/\//g,'-');
        tds[14].textContent = '当前用户';
        tds[16].textContent = new Date().toLocaleString('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).replace(/\//g,'-');
        tds[17].textContent = '当前用户';
        tds[18].textContent = (pickedRow.ccy||'USD');
        tds[19].innerHTML = `<span class="amount-large amount-positive">${inputAmt.toLocaleString()}</span>`;

        // 回写收款明细为已认领
        try{
          const id = pickedRow.id;
          let newLedger = JSON.parse(localStorage.getItem('receivingLedgerRows')||'[]');
          newLedger = newLedger.map(x=> x.id==id ? { ...x, claim:'已认领' } : x);
          localStorage.setItem('receivingLedgerRows', JSON.stringify(newLedger));
        }catch(err){}
        
        // 检查是否需要中断预充申请
        checkPrechargeInterrupt(row);
        
        document.getElementById('processModal').classList.remove('show');
      };
      document.getElementById('p-reject').onclick = ()=>{
        const statusBadges = row.querySelectorAll('.status-badge');
        statusBadges[0].textContent = '审核失败';
        statusBadges[0].className = 'status-badge status-rejected';
        row.dataset.status = '审核失败';
        const tds = row.querySelectorAll('td');
        tds[13].textContent = new Date().toLocaleString('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).replace(/\//g,'-');
        tds[14].textContent = '当前用户';
        
        // 检查是否需要中断预充申请
        checkPrechargeInterrupt(row);
        
        document.getElementById('processModal').classList.remove('show');
      };
    }

    function closeModal() {
      const hide = (id)=>{ const el = document.getElementById(id); if(el) el.classList.remove('show'); };
      hide('detailModal');
      hide('auditModal');
      hide('screenshotModal');
      hide('processModal');
      hide('matchModal');
      hide('confirmModal');
      hide('prechargeModal');
    }

    function viewScreenshot(filename) {
      // 模拟显示截图
      document.getElementById('screenshot-preview').src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPui9rOi0pea4qOWbvjwvdGV4dD48L3N2Zz4=';
      document.getElementById('screenshotModal').classList.add('show');
    }

    function batchReject() {
      const checkedBoxes = document.querySelectorAll('.row-select:checked');
      if (checkedBoxes.length === 0) {
        alert('请先选择要拒绝的申请');
        return;
      }
      
      if (confirm(`确定要批量拒绝 ${checkedBoxes.length} 个申请吗？`)) {
        // 这里可以添加批量拒绝的逻辑
        alert(`已批量拒绝 ${checkedBoxes.length} 个申请`);
        checkedBoxes.forEach(checkbox => {
          checkbox.checked = false;
        });
      }
    }

    // 全选功能（只选择待匹配和待确认的）
    document.getElementById('selectAll').addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('.row-select:not(:disabled)');
      checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
    });

    // 审核表单提交
    // 关闭处理弹窗事件
    // 复用 closeModal()

    // 点击模态框外部关闭
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          closeModal();
        }
      });
    });

    // 页面加载动画
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化分页
      initPagination();
      animateRows();
    });

    // 分页：基于现有DOM行进行分页隐藏/显示
    let currentPage = 1;
    let pageSize = 10;
    let allRows = [];
    function initPagination(){
      const tbody = document.querySelector('.transfer-table tbody');
      allRows = Array.from(tbody.querySelectorAll('tr'));
      renderPage();
      // 事件监听
      document.getElementById('pageSize').addEventListener('change', (e)=>{ pageSize=parseInt(e.target.value); currentPage=1; renderPage(); });
      document.getElementById('firstPage').addEventListener('click', ()=>goToPage(1));
      document.getElementById('prevPage').addEventListener('click', ()=>goToPage(currentPage-1));
      document.getElementById('nextPage').addEventListener('click', ()=>goToPage(currentPage+1));
      document.getElementById('lastPage').addEventListener('click', ()=>{ const tp = Math.max(1, Math.ceil(allRows.length/pageSize)); goToPage(tp); });
      document.getElementById('jumpBtn').addEventListener('click', ()=>{ const v=parseInt(document.getElementById('jumpToPage').value); if(v) goToPage(v); });
      document.getElementById('jumpToPage').addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ const v=parseInt(e.target.value); if(v) goToPage(v);} });
    }
    function renderPage(){
      const total = allRows.length;
      const totalPages = Math.max(1, Math.ceil(total/pageSize));
      if(currentPage>totalPages) currentPage=totalPages;
      const startIndex = (currentPage-1)*pageSize;
      const endIndex = startIndex + pageSize;
      allRows.forEach((tr,idx)=>{ tr.style.display = (idx>=startIndex && idx<endIndex) ? '' : 'none'; });
      // 更新信息与页码
      const start = total===0?0:startIndex+1;
      const end = Math.min(endIndex,total);
      const info = document.getElementById('paginationInfo'); if(info) info.textContent = `显示第 ${start}-${end} 条，共 ${total} 条记录`;
      const fp=document.getElementById('firstPage'), pp=document.getElementById('prevPage'), np=document.getElementById('nextPage'), lp=document.getElementById('lastPage');
      if(fp){ fp.disabled = currentPage===1; }
      if(pp){ pp.disabled = currentPage===1; }
      if(np){ np.disabled = currentPage===totalPages; }
      if(lp){ lp.disabled = currentPage===totalPages; }
      const pn = document.getElementById('pageNumbers'); if(pn){
        pn.innerHTML='';
        const maxVisible=5; let sp=Math.max(1,currentPage-Math.floor(maxVisible/2)); let ep=Math.min(totalPages, sp+maxVisible-1); if(ep-sp+1<maxVisible) sp=Math.max(1, ep-maxVisible+1);
        for(let i=sp;i<=ep;i++){ const b=document.createElement('button'); b.className=`pagination-btn ${i===currentPage?'active':''}`; b.textContent=i; b.onclick=()=>goToPage(i); pn.appendChild(b);} }
    }
    function goToPage(p){ const tp=Math.max(1, Math.ceil(allRows.length/pageSize)); if(p>=1 && p<=tp){ currentPage=p; renderPage(); } }
    function animateRows(){
      const visibleRows = Array.from(document.querySelectorAll('.transfer-table tbody tr')).filter(tr=>tr.style.display!=="none");
      visibleRows.forEach((row, index) => {
        row.style.opacity = '0'; row.style.transform = 'translateY(20px)';
        setTimeout(() => { row.style.transition = 'all 0.3s ease'; row.style.opacity = '1'; row.style.transform = 'translateY(0)'; }, index * 60);
      });
    }
  </script>
</body>
</html> 