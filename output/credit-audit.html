<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>信用额度审核 - 资金中台管理系统</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f8fafc;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    header {
      background: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      color: #2563eb;
      text-decoration: none;
    }

    .nav-menu {
      display: flex;
      list-style: none;
      gap: 30px;
    }

    .nav-menu li a {
      text-decoration: none;
      color: #64748b;
      font-weight: 500;
      transition: color 0.3s ease;
      padding: 10px 15px;
      border-radius: 8px;
    }

    .nav-menu li a:hover,
    .nav-menu li a.active {
      color: #2563eb;
      background: rgba(37, 99, 235, 0.1);
    }

    .page-header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
      border-left: 4px solid #2563eb;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 10px;
    }

    .page-description {
      color: #64748b;
      font-size: 16px;
    }

    /* Statistics Cards */
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      text-align: center;
    }

    .stat-number {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-pending { color: #f59e0b; }
    .stat-approved { color: #059669; }
    .stat-rejected { color: #dc2626; }
    .stat-total { color: #2563eb; }

    .stat-label {
      color: #64748b;
      font-size: 14px;
    }

    /* Search Section */
    .search-section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 25px;
    }

    .search-row {
      display: flex;
      gap: 20px;
      align-items: end;
      flex-wrap: wrap;
    }

    .search-group {
      flex: 1;
      min-width: 180px;
    }

    .search-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: #2563eb;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-primary { background: #2563eb; color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: #6b7280; color: white; }
    .btn-secondary:hover { background: #4b5563; }
    .btn-success { background: #059669; color: white; }
    .btn-success:hover { background: #047857; }
    .btn-danger { background: #dc2626; color: white; }
    .btn-danger:hover { background: #b91c1c; }
    .btn-small { padding: 6px 12px; font-size: 12px; border-radius: 6px; }

    /* Credit Table with Horizontal Scroll */
    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 25px;
      border-bottom: 1px solid #e2e8f0;
    }

    .table-title {
      font-size: 20px;
      font-weight: 600;
      color: #1e293b;
    }

    .table-wrapper {
      overflow-x: auto;
      position: relative;
    }

    .credit-table {
      width: 100%;
      min-width: 1400px;
      border-collapse: collapse;
      position: relative;
    }

    .credit-table th,
    .credit-table td {
      padding: 12px 8px;
      text-align: left;
      border-bottom: 1px solid #f1f5f9;
      font-size: 12px;
      white-space: nowrap;
    }

    .credit-table th {
      background: #f8fafc;
      font-weight: 600;
      color: #374151;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* Fixed operation column (last column) */
    .credit-table th:last-child,
    .credit-table td:last-child {
      position: sticky;
      right: 0;
      background: white;
      z-index: 15;
    }

    .credit-table tr:hover {
      background: #f8fafc;
    }

    .credit-table tr:hover td:nth-child(1),
    .credit-table tr:hover td:nth-child(2),
    .credit-table tr:hover td:nth-child(3),
    .credit-table tr:hover td:nth-child(4),
    .credit-table tr:hover td:last-child {
      background: #f8fafc;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
    }

    .status-pending { background: #fef3c7; color: #92400e; }
    .status-approved { background: #dcfce7; color: #166534; }
    .status-rejected { background: #fee2e2; color: #991b1b; }

    .credit-amount {
      font-weight: 600;
      font-size: 12px;
    }

    .credit-increase { color: #059669; }
    .credit-decrease { color: #dc2626; }

    .business-tag {
      background: #dbeafe;
      color: #1e40af;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
    }

    .adjustment-type {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .type-increase { background: #dcfce7; color: #166534; }
    .type-decrease { background: #fee2e2; color: #991b1b; }

    .action-buttons {
      display: flex;
      gap: 6px;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 4px;
    }

    /* Mouse-following tooltip for remarks */
    .remark-cell {
      position: relative;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: help;
    }
    
    /* 周期说明帮助提示 */
    .label-help-wrap { position: relative; display: inline-flex; align-items: center; gap: 6px; }
    .help-tip { display:inline-block; width:16px; height:16px; line-height:16px; text-align:center; border-radius:50%; background:#64748b; color:#fff; font-size:12px; cursor:help; }
    .help-popup { position:absolute; left:0; top:24px; background:#1f2937; color:#fff; padding:10px 12px; border-radius:8px; font-size:12px; max-width:320px; box-shadow:0 6px 20px rgba(0,0,0,0.15); opacity:0; visibility:hidden; transition:opacity .2s ease; z-index:50; }
    .label-help-wrap:hover .help-popup { opacity:1; visibility:visible; }
         .help-popup p { margin: 4px 0; }
     .help-popup b { color: #93c5fd; }
 
     /* Mouse-following tooltip for remarks */
     .mouse-tooltip {
       position: fixed;
       background: #1f2937;
       color: white;
       padding: 8px 12px;
       border-radius: 6px;
       font-size: 12px;
       white-space: normal;
       max-width: 250px;
       z-index: 2000;
       box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
       pointer-events: none;
       opacity: 0;
       transition: opacity 0.3s ease;
     }
     .mouse-tooltip.show { opacity: 1; }
 
     /* 周期可视化文本覆盖 */
    #progressBar { position: relative; }
    #progressBar > div { position: relative; display:flex; align-items:center; justify-content:center; }
    .seg-label { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#fff; font-size:10px; text-shadow:0 1px 2px rgba(0,0,0,0.3); padding:0 4px; }
    @media (max-width: 768px) { .seg-label { font-size:9px; } }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 700px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 600;
      color: #1e293b;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #64748b;
    }

    .detail-section {
      margin-bottom: 20px;
    }

    .detail-section h4 {
      color: #374151;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      background: #f8fafc;
      border-radius: 6px;
    }

    .detail-label {
      color: #64748b;
      font-weight: 500;
    }

    .detail-value {
      color: #1e293b;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
      resize: vertical;
    }

    .form-input:focus {
      outline: none;
      border-color: #2563eb;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .search-row {
        flex-direction: column;
      }

      .search-group {
        min-width: 100%;
      }

      .stats-cards {
        grid-template-columns: repeat(2, 1fr);
      }

      .detail-grid {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }
    }
    /* 固定商户邮箱和商户名称列 */
    .sticky-col {
      position: sticky;
      left: 0;
      background: white;
      z-index: 16;
    }
    .sticky-email { left: 0; }
    .sticky-name { left: 150px; }
    .credit-table th.sticky-col, .credit-table td.sticky-col {
      background: white;
      z-index: 16;
    }
    /* 固定操作列 */
    .sticky-op {
      position: sticky;
      right: 0;
      left: auto !important;
      background: white;
      z-index: 16;
    }
    /* 取消账户ID相关样式 */
    
    /* Tab样式 */
    .tab-btn {
      flex: 1;
      padding: 15px;
      border: none;
      background: none;
      cursor: pointer;
      font-weight: 500;
      color: #64748b;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
      position: relative;
      z-index: 10;
    }
    
    .tab-btn:hover {
      color: #2563eb;
      background: rgba(37, 99, 235, 0.05);
    }
    
    .tab-btn.active {
      color: #2563eb;
      border-bottom: 2px solid #2563eb;
      background: rgba(37, 99, 235, 0.1);
    }
    
    .tab-nav {
      display: flex;
      border-bottom: 1px solid #e2e8f0;
      position: relative;
      z-index: 5;
    }
    
    .tab-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 25px;
      position: relative;
      z-index: 1;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <a href="index.html" class="logo">资金中台</a>
      <nav>
        <ul class="nav-menu">
          <li><a href="index.html">首页</a></li>
          <li><a href="customer-management.html">账户管理</a></li>
          <li><a href="transfer-audit.html">转账审核</a></li>
          <li><a href="credit-audit.html" class="active">信用额度</a></li>
          <li><a href="transaction-details.html">交易明细</a></li>
          <li><a href="permission-config.html">权限配置</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="page-header">
      <h1 class="page-title">信用额度管理</h1>
      <p class="page-description">管理信用额度申请和审核流程，支持多级审核和风险评估</p>
    </div>

    <div class="stats-cards">
      <div class="stat-card">
        <div class="stat-number stat-pending">12</div>
        <div class="stat-label">待审核</div>
      </div>
      <div class="stat-card">
        <div class="stat-number stat-approved">45</div>
        <div class="stat-label">已通过</div>
      </div>
      <div class="stat-card">
        <div class="stat-number stat-rejected">8</div>
        <div class="stat-label">已拒绝</div>
      </div>
      <div class="stat-card">
        <div class="stat-number stat-total">65</div>
        <div class="stat-label">总申请数</div>
      </div>
    </div>

    <!-- Tab导航 -->
    <div class="tab-container">
      <div class="tab-nav">
        <button class="tab-btn active" data-tab="my-applications">我发起的</button>
        <button class="tab-btn" data-tab="pending-review">待审核</button>
        <button class="tab-btn" data-tab="history">历史处理</button>
        <button class="tab-btn" data-tab="all">全部</button>
      </div>
    </div>

    <!-- 我发起的Tab搜索 -->
    <div class="search-section" id="search-my-applications" style="display: block;">
      <div class="search-row">
        <div class="search-group">
          <label>商户邮箱</label>
          <input type="text" class="search-input" placeholder="输入商户邮箱">
        </div>
        <div class="search-group">
          <label>商户名称</label>
          <input type="text" class="search-input" placeholder="输入商户名称">
        </div>
        <div class="search-group">
          <label>审核状态</label>
          <select class="search-input" id="searchStatusMy">
            <option value="">全部状态</option>
            <option value="pre-review">待初审</option>
            <option value="final-review">待终审</option>
            <option value="approved">审核通过</option>
            <option value="rejected">审核不通过</option>
          </select>
        </div>
        <div class="search-group">
          <label>申请时间</label>
          <input type="date" class="search-input">
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-primary">搜索</button>
          <button class="btn btn-secondary">重置</button>
        </div>
      </div>
    </div>
    
    <!-- 待审核Tab搜索 -->
    <div class="search-section" id="search-pending-review" style="display: none;">
      <div class="search-row">
        <div class="search-group">
          <label>商户邮箱</label>
          <input type="text" class="search-input" placeholder="输入商户邮箱">
        </div>
        <div class="search-group">
          <label>商户名称</label>
          <input type="text" class="search-input" placeholder="输入商户名称">
        </div>
        <div class="search-group">
          <label>申请人</label>
          <input type="text" class="search-input" placeholder="输入申请人">
        </div>
        <div class="search-group">
          <label>申请时间</label>
          <input type="date" class="search-input">
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-primary">搜索</button>
          <button class="btn btn-secondary">重置</button>
        </div>
      </div>
    </div>
    
    <!-- 历史处理Tab搜索 -->
    <div class="search-section" id="search-history" style="display: none;">
      <div class="search-row">
        <div class="search-group">
          <label>商户邮箱</label>
          <input type="text" class="search-input" placeholder="输入商户邮箱">
        </div>
        <div class="search-group">
          <label>商户名称</label>
          <input type="text" class="search-input" placeholder="输入商户名称">
        </div>
        <div class="search-group">
          <label>审核结果</label>
          <select class="search-input" id="searchResultHistory">
            <option value="">全部结果</option>
            <option value="approved">审核通过</option>
            <option value="rejected">审核不通过</option>
          </select>
        </div>
        <div class="search-group">
          <label>申请时间</label>
          <input type="date" class="search-input">
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-primary">搜索</button>
          <button class="btn btn-secondary">重置</button>
        </div>
      </div>
    </div>
    
    <!-- 全部Tab搜索 -->
    <div class="search-section" id="search-all" style="display: none;">
      <div class="search-row">
        <div class="search-group">
          <label>商户邮箱</label>
          <input type="text" class="search-input" placeholder="输入商户邮箱">
        </div>
        <div class="search-group">
          <label>商户名称</label>
          <input type="text" class="search-input" placeholder="输入商户名称">
        </div>
        <div class="search-group">
          <label>子业务名称</label>
          <select class="search-input">
            <option value="">全部业务</option>
            <option value="advertising">Advertising</option>
            <option value="fulfillment">Fulfillment</option>
          </select>
        </div>
        <div class="search-group">
          <label>审核状态</label>
          <select class="search-input" id="searchStatusAll">
            <option value="">全部状态</option>
            <option value="pre-review">待初审</option>
            <option value="final-review">待终审</option>
            <option value="approved">审核通过</option>
            <option value="rejected">审核不通过</option>
          </select>
        </div>
        <div class="search-group">
          <label>申请时间</label>
          <input type="date" class="search-input">
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-primary">搜索</button>
          <button class="btn btn-secondary">重置</button>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title" id="tableTitle">我发起的申请</h3>
        <button class="btn btn-primary" id="openApplyModalBtn" style="display: block;">发起信用额度调整申请</button>
      </div>
      
      <div class="table-wrapper">
        <table class="credit-table">
          <thead>
            <tr id="tableHeader">
              <th width="150px" class="sticky-col sticky-email">商户邮箱</th>
              <th width="150px" class="sticky-col sticky-name">商户名称</th>
              <th width="100px">子业务名称</th>
              <th width="100px">审核状态</th>
              <th width="120px" class="applicant-header">申请人</th>
              <th width="140px">申请时间</th>
              <th width="140px">申请备注</th>
              <th width="120px">初审人</th>
              <th width="140px">初审时间</th>
              <th width="140px">初审备注</th>
              <th width="120px">终审人</th>
              <th width="140px">终审时间</th>
              <th width="140px">终审备注</th>
              <th width="150px" class="sticky-col sticky-op" style="right:0;left:auto;">操作</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>US001</td>
              <td>contact@apple.com</td>
              <td><span class="business-tag">Advertising</span></td>
              <td><span class="status-badge status-pending">待初审</span></td>
              <td>李运营</td>
              <td>2024-01-15 14:30</td>
              <td class="remark-cell" data-remark="由于业务扩展需要，客户申请增加信用额度以支持更大规模的广告投放。客户近期业务增长稳定，现有额度已无法满足日常运营需求。">
                业务扩展需要...
              </td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td class="sticky-col sticky-op" style="right:0;left:auto;">
                <div class="action-buttons">
                  <button class="btn btn-primary btn-small" onclick="openAudit(0,'approve','pre')">初审通过</button>
                  <button class="btn btn-danger btn-small" onclick="openAudit(0,'reject','pre')">初审拒绝</button>
                  <button class="btn btn-primary btn-small" onclick="openAudit(0,'approve','final')">终审通过</button>
                  <button class="btn btn-danger btn-small" onclick="openAudit(0,'reject','final')">终审拒绝</button>
                  <button class="btn btn-secondary btn-small" onclick="openDetail(0)">详情</button>
                </div>
              </td>
            </tr>
            <tr>
              <td>US002</td>
              <td>service@microsoft.com</td>
              <td><span class="business-tag">Fulfillment</span></td>
              <td><span class="status-badge status-pending">待审核</span></td>
              <td>张运营</td>
              <td>2024-01-16 09:15</td>
              <td class="remark-cell" data-remark="由于业务策略调整，客户主动申请减少履约业务的信用额度。当前使用率较低，减少额度有助于降低风险敞口。">
                业务调整...
              </td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td class="sticky-col sticky-op" style="right:0;left:auto;">
                <div class="action-buttons">
                  <button class="btn btn-primary btn-small" onclick="openAudit(1,'approve','pre')">初审通过</button>
                  <button class="btn btn-danger btn-small" onclick="openAudit(1,'reject','pre')">初审拒绝</button>
                  <button class="btn btn-primary btn-small" onclick="openAudit(1,'approve','final')">终审通过</button>
                  <button class="btn btn-danger btn-small" onclick="openAudit(1,'reject','final')">终审拒绝</button>
                  <button class="btn btn-secondary btn-small" onclick="openDetail(1)">详情</button>
                </div>
              </td>
            </tr>
            <tr>
              <td>US003</td>
              <td>contact@google.com</td>
              <td><span class="business-tag">Advertising</span></td>
              <td><span class="status-badge status-approved">已通过</span></td>
              <td>王运营</td>
              <td>2024-01-14 09:20</td>
              <td class="remark-cell" data-remark="客户历史还款记录良好，业务规模稳定增长，财务状况健康，无逾期记录。同意增加信用额度。">
                客户信用良好...
              </td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td class="sticky-col sticky-op" style="right:0;left:auto;">
                <button class="btn btn-secondary btn-small" onclick="openDetail(2)">详情</button>
              </td>
            </tr>
            <tr>
              <td>US001</td>
              <td>contact@apple.com</td>
              <td><span class="business-tag">Fulfillment</span></td>
              <td><span class="status-badge status-rejected">已拒绝</span></td>
              <td>赵运营</td>
              <td>2024-01-13 11:15</td>
              <td class="remark-cell" data-remark="经财务部门评估，客户当前现金流状况不稳定，且近期投诉较多，暂不适合提高信用额度。建议3个月后重新评估。">
                财务评估未通过...
              </td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td class="sticky-col sticky-op" style="right:0;left:auto;">
                <button class="btn btn-secondary btn-small" onclick="openDetail(3)">详情</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Mouse-following tooltip -->
  <div class="mouse-tooltip" id="mouseTooltip"></div>

  <!-- 详情模态框 -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">信用额度申请详情</h2>
        <button class="close-btn" onclick="closeModal('detailModal')">&times;</button>
      </div>
      <div class="detail-section">
        <h4>客户信息</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">账户ID</span>
            <span class="detail-value">US001</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">商户邮箱</span>
            <span class="detail-value">contact@apple.com</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">商户名称</span>
            <span class="detail-value">Apple Inc.</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">子业务名称</span>
            <span class="detail-value">Advertising</span>
          </div>
        </div>
      </div>
      <div class="detail-section">
        <h4>当前额度信息</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">当前信用额度</span>
            <span class="detail-value" style="color: #2563eb; font-weight: bold;">50,000</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">已用额度</span>
            <span class="detail-value" style="color: #dc2626; font-weight: bold;">15,000</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">剩余额度</span>
            <span class="detail-value" style="color: #059669; font-weight: bold;">35,000</span>
          </div>
        </div>
      </div>
      <div class="detail-section">
        <h4>申请额度信息</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">设定信用额度</span>
            <span class="detail-value" style="color: #f59e0b; font-weight: bold;">60,000</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">单笔额度限制</span>
            <span class="detail-value">不限</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">当日额度限制</span>
            <span class="detail-value">不限</span>
          </div>
        </div>
      </div>
      <div class="detail-section">
        <h4>申请备注</h4>
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; color: #64748b;">
          由于业务扩展需要，客户申请增加信用额度以支持更大规模的广告投放。客户近期业务增长稳定，现有额度已无法满足日常运营需求。
        </div>
      </div>
      <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
        <button class="btn btn-secondary" onclick="closeModal('detailModal')">关闭</button>
      </div>
    </div>
  </div>

  <!-- 审核模态框 -->
  <div class="modal" id="auditModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="auditModalTitle">审核信用额度申请</h2>
        <button class="close-btn" onclick="closeModal('auditModal')">&times;</button>
      </div>
      <form id="auditForm">
        <div class="form-group">
          <label>备注 *</label>
          <textarea class="form-input" name="auditComment" rows="4" placeholder="请填写备注信息" required></textarea>
        </div>
        <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
          <button type="button" class="btn btn-secondary" onclick="closeModal('auditModal')">取消</button>
          <button type="submit" class="btn btn-primary" id="auditSubmitBtn">确认审核</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 申请模态框 -->
  <div class="modal" id="applyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">发起信用额度申请</h2>
        <button class="close-btn" onclick="closeModal('applyModal')">&times;</button>
      </div>
      <form id="applyForm">
        <!-- 基础选择：商户 + 资金账户 -->
        <div class="form-group">
          <label>商户名称 *</label>
          <select class="form-input" id="merchantSelect" required>
            <option value="">请选择商户</option>
          </select>
          <input type="hidden" name="accountId" />
          <input type="hidden" name="email" />
          <input type="hidden" name="merchantName" />
        </div>
        <div class="form-group">
          <label>资金账户 *</label>
          <select class="form-input" id="fundAccountSelect" required>
            <option value="">请选择</option>
            <option value="ADS">ADS</option>
            <option value="BPS">BPS</option>
          </select>
        </div>

        <!-- ADS：新增信用额度 -->
        <div id="adsForm" style="display:none;">
          <div class="detail-section">
            <h4>商户信息</h4>
            <div class="detail-grid">
              <div class="detail-item"><span class="detail-label">商户名称</span><span class="detail-value" id="adsMerchantName">-</span></div>
              <div class="detail-item"><span class="detail-label">资金账户</span><span class="detail-value" id="adsFundAccount">ADS</span></div>
            </div>
          </div>
          <div class="detail-section">
            <h4>额度设置</h4>
            <div class="form-group">
              <label>设定信用额度 *</label>
              <input class="form-input" name="adsCreditLimit" id="adsCreditLimit" type="number" min="1" required placeholder="请输入信用额度" />
            </div>
            <div class="form-group">
              <label>设定单日额度 *</label>
              <input class="form-input" name="adsDailyLimit" id="adsDailyLimit" type="number" min="1" required placeholder="请输入单日额度" />
            </div>
            <div class="form-group">
              <label>设定单笔额度 *</label>
              <input class="form-input" name="adsSingleLimit" id="adsSingleLimit" type="number" min="1" required placeholder="请输入单笔额度" />
            </div>
          </div>
          <div class="detail-section">
            <h4>周期与日期设置</h4>
            <div class="form-group">
              <label>结算周期类型 *</label>
              <select class="form-input" id="cycleTypeSelect" required>
                <option value="">请选择结算周期类型</option>
                <option value="custom">自定义</option>
                <option value="natural_week">自然周</option>
                <option value="natural_month">自然月</option>
              </select>
            </div>
            <div class="form-group" id="customCycleGroup" style="display:none;">
              <label>自定义结算设置</label>
              <div style="display:flex;gap:10px;">
                <div style="flex:1;">
                  <label style="font-size:12px;color:#666;">开始结算日期 *</label>
                  <input class="form-input" type="date" id="settlementStartDate" />
                </div>
                <div style="flex:1;">
                  <label style="font-size:12px;color:#666;">结算周期天数 *</label>
                  <input class="form-input" type="number" min="1" max="365" id="settlementPeriodDays" placeholder="请输入天数" />
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>账期（天） *</label>
              <input class="form-input" type="number" min="1" max="365" id="accountPeriodDays" required placeholder="请输入账期（1-365）" />
            </div>
            <div class="form-group">
              <label>宽限期（天） *</label>
              <input class="form-input" type="number" min="1" max="365" id="gracePeriodDays" required placeholder="请输入宽限期（1-365）" />
            </div>
            <div class="label-help-wrap">
              <label>周期说明</label>
              <span class="help-tip" tabindex="0">?</span>
              <div class="help-popup">
                <p><b>结算周期</b>：定义账单的统计周期，如自然周/自然月/自定义周期。</p>
                <p><b>账期</b>：结算完成后给予客户支付账单的时间（以天为单位）。</p>
                <p><b>宽限期</b>：账期结束后额外允许的延期支付时间（以天为单位）。</p>
              </div>
            </div>
            <div id="cycleProgress" style="background:#e5e7eb;border-radius:8px;overflow:hidden;padding:10px;">
              <div id="progressBar" style="display:flex;height:22px;border-radius:6px;overflow:hidden;">
                <div id="segmentCycle" style="background:#93c5fd;width:40%"><span id="segCycleLabel" class="seg-label"></span></div>
                <div id="segmentAccount" style="background:#86efac;width:40%"><span id="segAccountLabel" class="seg-label"></span></div>
                <div id="segmentGrace" style="background:#fca5a5;width:20%"><span id="segGraceLabel" class="seg-label"></span></div>
              </div>
              <div style="display:flex;justify-content:space-between;font-size:12px;color:#64748b;margin-top:6px;">
                <span>结算周期</span><span>账期</span><span>宽限期</span>
              </div>
            </div>
          </div>
          <div class="detail-section">
            <h4>更多信息</h4>
            <div class="form-group">
              <label>是否有推荐人</label>
              <label style="margin-right:10px;"><input type="radio" name="adsHasReferrer" value="no" checked> 无</label>
              <label><input type="radio" name="adsHasReferrer" value="yes"> 有</label>
            </div>
            <div class="form-group" id="adsReferrerGroup" style="display:none;">
              <label>推荐人名称</label>
              <input class="form-input" id="adsReferrerName" placeholder="请输入推荐人名称" />
            </div>
            <div class="form-group"><label>客户网站</label><input class="form-input" id="adsWebsite" placeholder="请输入客户网站" /></div>
            <div class="form-group"><label>客户每月营收</label><input class="form-input" id="adsMonthlyRevenue" placeholder="请输入客户每月营收" /></div>
            <div class="form-group"><label>客户每月销售额</label><input class="form-input" id="adsMonthlySales" placeholder="请输入客户每月销售额" /></div>
            <div class="form-group"><label>客户历史总利润</label><input class="form-input" id="adsTotalProfit" placeholder="请输入客户历史总利润" /></div>
            <div class="form-group"><label>备注 *</label><textarea class="form-input" id="adsRemark" rows="3" required placeholder="请填写备注"></textarea></div>
            <div class="form-group">
              <label>附件（支持上传jpg/png/pdf格式文件，最多10个，单个文件20M内）*</label>
              <input class="form-input" id="adsFiles" type="file" accept=".jpg,.jpeg,.png,.pdf" multiple required />
              <small style="color:#666;">支持格式：JPG、PNG、PDF，单个文件最大20MB</small>
            </div>
          </div>
        </div>

        <!-- BPS：调整信用额度 -->
        <div id="bpsForm" style="display:none;">
          <div class="detail-section">
            <h4>商户信息</h4>
            <div class="detail-grid">
              <div class="detail-item"><span class="detail-label">商户名称</span><span class="detail-value" id="bpsMerchantName">-</span></div>
              <div class="detail-item"><span class="detail-label">资金账户</span><span class="detail-value" id="bpsFundAccount">BPS</span></div>
            </div>
          </div>
          <div class="detail-section">
            <h4>信用额度</h4>
            <div class="form-group"><label>当前信用额度</label><input class="form-input" id="bpsCurrentCredit" type="number" readonly value="50000" /></div>
            <div class="form-group"><label>新的信用额度 *</label><input class="form-input" id="bpsNewCredit" type="number" min="1" required placeholder="请输入新的信用额度" /></div>
          </div>
          <div class="detail-section">
            <h4>每日额度</h4>
            <div class="form-group"><label>当前每日额度</label><input class="form-input" id="bpsCurrentDaily" type="number" readonly value="80000" /></div>
            <div class="form-group"><label>新的每日额度 *</label><input class="form-input" id="bpsNewDaily" type="number" min="1" required placeholder="请输入新的每日额度" /></div>
          </div>
          <div class="detail-section">
            <h4>单笔额度</h4>
            <div class="form-group"><label>当前单笔额度</label><input class="form-input" id="bpsCurrentSingle" type="number" readonly value="20000" /></div>
            <div class="form-group"><label>新的单笔额度 *</label><input class="form-input" id="bpsNewSingle" type="number" min="1" required placeholder="请输入新的单笔额度" /></div>
          </div>
          <div class="detail-section">
            <h4>备注与附件</h4>
            <div class="form-group"><label>备注 *</label><textarea class="form-input" id="bpsRemark" rows="3" required placeholder="请填写备注"></textarea></div>
            <div class="form-group">
              <label>附件（支持上传jpg/png/pdf格式文件，最多10个，单个文件20M内）*</label>
              <input class="form-input" id="bpsFiles" type="file" accept=".jpg,.jpeg,.png,.pdf" multiple required />
              <small style="color:#666;">支持格式：JPG、PNG、PDF，单个文件最大20MB</small>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:15px;justify-content:flex-end;margin-top:30px;">
          <button type="button" class="btn btn-secondary" onclick="closeModal('applyModal')">取消</button>
          <button type="submit" class="btn btn-primary">提交申请</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // let currentAuditAction = ''; // 删除重复声明，统一在后面全局声明

    // Mouse-following tooltip functionality
    const tooltip = document.getElementById('mouseTooltip');
    
    document.querySelectorAll('.remark-cell').forEach(cell => {
      cell.addEventListener('mouseenter', function(e) {
        const remarkText = this.getAttribute('data-remark');
        tooltip.textContent = remarkText;
        tooltip.classList.add('show');
        updateTooltipPosition(e);
      });

      cell.addEventListener('mousemove', function(e) {
        updateTooltipPosition(e);
      });

      cell.addEventListener('mouseleave', function() {
        tooltip.classList.remove('show');
      });
    });

    function updateTooltipPosition(e) {
      const tooltipRect = tooltip.getBoundingClientRect();
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      
      let left = e.clientX + 10;
      let top = e.clientY - 10;
      
      // 防止tooltip超出右边界
      if (left + tooltipRect.width > windowWidth) {
        left = e.clientX - tooltipRect.width - 10;
      }
      
      // 防止tooltip超出下边界
      if (top + tooltipRect.height > windowHeight) {
        top = e.clientY - tooltipRect.height - 10;
      }
      
      // 防止tooltip超出上边界
      if (top < 0) {
        top = e.clientY + 10;
      }
      
      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';
    }

    function openModal(type, action = '') {
      if (type === 'detail') {
        document.getElementById('detailModal').classList.add('show');
      } else if (type === 'audit') {
        currentAuditAction = action;
        const modal = document.getElementById('auditModal');
        const title = document.getElementById('auditModalTitle');
        const submitBtn = document.getElementById('auditSubmitBtn');
        
        if (action === 'approve') {
          title.textContent = '通过信用额度申请';
          submitBtn.textContent = '确认通过';
          submitBtn.className = 'btn btn-success';
        } else {
          title.textContent = '拒绝信用额度申请';
          submitBtn.textContent = '确认拒绝';
          submitBtn.className = 'btn btn-danger';
        }
        
        modal.classList.add('show');
      }
    }

    function closeModal() {
      document.getElementById('detailModal').classList.remove('show');
      document.getElementById('auditModal').classList.remove('show');
    }

    // 审核表单提交
    document.getElementById('auditForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const action = currentAuditAction === 'approve' ? '通过' : '拒绝';
      alert(`审核${action}成功！`);
      closeModal();
    });

    // 点击模态框外部关闭
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          closeModal();
        }
      });
    });

    // 页面加载动画
    document.addEventListener('DOMContentLoaded', function() {
      const rows = document.querySelectorAll('tbody tr');
      rows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateY(20px)';
        setTimeout(() => {
          row.style.transition = 'all 0.3s ease';
          row.style.opacity = '1';
          row.style.transform = 'translateY(0)';
        }, index * 100);
      });
    });

    // 商户数据
    const merchants = [
      {accountId:'US001', email:'contact@apple.com', merchantName:'Apple Inc.'},
      {accountId:'US002', email:'service@microsoft.com', merchantName:'Microsoft Corporation'},
      {accountId:'US003', email:'contact@google.com', merchantName:'Google LLC'},
      {accountId:'US004', email:'service@amazon.com', merchantName:'Amazon Inc.'},
      {accountId:'US005', email:'contact@bytedance.com', merchantName:'ByteDance Ltd.'},
      {accountId:'US006', email:'contact@alibaba.com', merchantName:'Alibaba Group'},
      {accountId:'US007', email:'contact@tencent.com', merchantName:'Tencent Holdings'},
      {accountId:'US008', email:'contact@baidu.com', merchantName:'Baidu Inc.'},
      {accountId:'US009', email:'contact@meituan.com', merchantName:'Meituan Dianping'},
      {accountId:'US010', email:'contact@jd.com', merchantName:'JD.com'}
    ];
    // 生成20条申请数据，覆盖所有状态
    let creditApplications = [];
    for(let i=0;i<20;i++){
      let m = merchants[i%merchants.length];
      let statusArr = ['pre-review','final-review','approved','rejected'];
      let status = statusArr[i%4];
      let now = new Date(Date.now()-i*86400000);
      let applyTime = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+' '+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
      let preReviewer = status!=='pre-review'?'审核员':('');
      let preReviewTime = status!=='pre-review'?applyTime:'';
      let preReviewRemark = status!=='pre-review'?'初审备注'+i:'';
      let finalReviewer = status==='approved'||status==='rejected'?'审核员':'';
      let finalReviewTime = status==='approved'||status==='rejected'?applyTime:'';
      let finalReviewRemark = status==='approved'||status==='rejected'?'终审备注'+i:'';
      // 确保有一些申请是"当前用户"发起的
      let applicant = i < 5 ? '当前用户' : '申请人'+(i%7+1);
      creditApplications.push({
        accountId:m.accountId,
        email:m.email,
        merchantName:m.merchantName,
        business:i%2===0?'Advertising':'Fulfillment',
        status,
        applyTime,
        preReviewer,
        preReviewTime,
        preReviewRemark,
        finalReviewer,
        finalReviewTime,
        finalReviewRemark,
        files: [], // 新增文件数组
        remark:'申请备注'+i,
        applicant: applicant,
        hasReferrer: i%3===0?'yes':'no',
        referrer: i%3===0?'推荐人'+i:'',
        website: 'https://site'+i+'.com',
        monthlyRevenue: i%2===0?('￥'+(100000+i*1000)):'',
        monthlySales: i%2===1?('￥'+(50000+i*500)):'',
        totalProfit: i%4===0?('￥'+(1000000+i*10000)):'',
        currentCredit: 50000,
        usedCredit: 15000,
        remainingCredit: 35000,
        newCredit: 60000 + i*1000,
        singleLimitType: i%2===0?'unlimited':'limited',
        singleLimitAmount: i%2===0?0:10000,
        dailyLimitType: i%3===0?'unlimited':'limited',
        dailyLimitAmount: i%3===0?0:50000,
        currentPeriod: '自然月',
        currentGracePeriod: 30,
        period: i%2===0?'natural_week':i%3===0?'biweekly':i%4===0?'half_month':i%5===0?'custom':'natural_month',
        periodDays: 30 + i*5,
        gracePeriod: 15 + i*5,
        startDate: i%5===0?'2024-01-01':null,
        customPeriodDays: i%5===0?45:null,
      });
    }

    // 打开申请模态框
    document.getElementById('openApplyModalBtn').onclick = function() {
      document.getElementById('applyModal').classList.add('show');
    };

    // 关闭模态框（兼容无参/有参）
    function closeModal(id) {
      if(id){
        document.getElementById(id)?.classList.remove('show');
        return;
      }
      document.getElementById('detailModal')?.classList.remove('show');
      document.getElementById('auditModal')?.classList.remove('show');
      document.getElementById('applyModal')?.classList.remove('show');
    }

    // 旧版申请表单提交逻辑已移除（由新版 ADS/BPS 表单接管）

    // 旧版商户模糊搜索已移除（改为下拉单选）

    // 旧版广告业务推荐人逻辑已移除（由 ADS 表单接管）

    // 旧版履约业务推荐人逻辑已移除（BPS 不使用该逻辑）

    // 旧版子业务选择逻辑已移除（改为资金账户 ADS/BPS 切换）

    // 旧版结算周期选择逻辑已移除（由 ADS 表单 cycleTypeSelect 接管）

    // 旧版额度限制逻辑（广告业务）已移除

    // 旧版额度限制逻辑（履约业务）已移除

    // 分页与筛选
    let currentPage = 1, pageSize = 8;
    // 为不同的搜索状态选择器添加事件监听
    document.getElementById('searchStatusMy')?.addEventListener('change',function(){currentPage=1;renderTable();});
    document.getElementById('searchStatusAll')?.addEventListener('change',function(){currentPage=1;renderTable();});
    document.getElementById('searchResultHistory')?.addEventListener('change',function(){currentPage=1;renderTable();});
    
    // Tab切换逻辑
    let currentTab = 'my-applications';
    
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        console.log('Tab clicked:', tabId); // 添加调试信息
        switchTab(tabId);
      });
    });
    
    function switchTab(tabId) {
      console.log('Switching to tab:', tabId); // 添加调试信息
      // 更新Tab按钮状态
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
      
      // 切换搜索区域
      document.querySelectorAll('.search-section').forEach(section => {
        section.style.display = 'none';
      });
      document.getElementById(`search-${tabId}`).style.display = 'block';
      
      // 更新表格标题和按钮
      const titles = {
        'my-applications': '我发起的申请',
        'pending-review': '待审核申请',
        'history': '历史处理记录',
        'all': '全部申请'
      };
      document.getElementById('tableTitle').textContent = titles[tabId];
      
      // 控制发起申请按钮显示
      document.getElementById('openApplyModalBtn').style.display = tabId === 'my-applications' ? 'block' : 'none';
      
      // 更新表格头部
      updateTableHeader(tabId);
      
      currentTab = tabId;
      currentPage = 1; // 切换Tab时重置到第一页
      renderTable();
    }
    
    // 更新表格头部
    function updateTableHeader(tabId) {
      const applicantHeader = document.querySelector('.applicant-header');
      if(tabId === 'my-applications') {
        // 我发起的Tab隐藏申请人列
        applicantHeader.style.display = 'none';
      } else {
        // 其他Tab显示申请人列
        applicantHeader.style.display = 'table-cell';
      }
    }

    // 页面加载时初始化默认Tab
    document.addEventListener('DOMContentLoaded', function() {
      // Tab按钮事件绑定
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const tabId = this.getAttribute('data-tab');
          switchTab(tabId);
        });
      });
      // 默认显示"我发起的"Tab
      switchTab('my-applications');
      
      // 为搜索输入框添加事件监听器
      addSearchEventListeners();
    });
    
    // 添加搜索事件监听器
    function addSearchEventListeners() {
      // 我发起的Tab搜索
      const myApplicationsInputs = document.querySelectorAll('#search-my-applications input[type="text"]');
      myApplicationsInputs.forEach(input => {
        input.addEventListener('input', function() {
          currentPage = 1;
          renderTable();
        });
      });
      
      // 待审核Tab搜索
      const pendingReviewInputs = document.querySelectorAll('#search-pending-review input[type="text"]');
      pendingReviewInputs.forEach(input => {
        input.addEventListener('input', function() {
          currentPage = 1;
          renderTable();
        });
      });
      
      // 历史处理Tab搜索
      const historyInputs = document.querySelectorAll('#search-history input[type="text"]');
      historyInputs.forEach(input => {
        input.addEventListener('input', function() {
          currentPage = 1;
          renderTable();
        });
      });
    }

    function renderTable() {
      const tbody = document.querySelector('.credit-table tbody');
      tbody.innerHTML = '';
      
      let filtered = [];
      
      switch(currentTab) {
        case 'my-applications':
          // 我发起的：申请人为当前用户
          filtered = creditApplications.filter(item => item.applicant === '当前用户');
          // 商户邮箱和商户名称模糊搜索
          let emailFilterMy = document.querySelector('#search-my-applications input[placeholder="输入商户邮箱"]').value.trim();
          let nameFilterMy = document.querySelector('#search-my-applications input[placeholder="输入商户名称"]').value.trim();
          if(emailFilterMy) {
            filtered = filtered.filter(item => item.email.toLowerCase().includes(emailFilterMy.toLowerCase()));
          }
          if(nameFilterMy) {
            filtered = filtered.filter(item => item.merchantName.toLowerCase().includes(nameFilterMy.toLowerCase()));
          }
          let statusFilterMy = document.getElementById('searchStatusMy').value;
          if(statusFilterMy) {
            filtered = filtered.filter(item => item.status === statusFilterMy);
          }
          break;
          
        case 'pending-review':
          // 待审核：等待当前用户审核的申请
          filtered = creditApplications.filter(item => 
            (item.status === 'pre-review' || item.status === 'final-review') && 
            item.applicant !== '当前用户'
          );
          // 商户邮箱和商户名称模糊搜索
          let emailFilterPending = document.querySelector('#search-pending-review input[placeholder="输入商户邮箱"]').value.trim();
          let nameFilterPending = document.querySelector('#search-pending-review input[placeholder="输入商户名称"]').value.trim();
          if(emailFilterPending) {
            filtered = filtered.filter(item => item.email.toLowerCase().includes(emailFilterPending.toLowerCase()));
          }
          if(nameFilterPending) {
            filtered = filtered.filter(item => item.merchantName.toLowerCase().includes(nameFilterPending.toLowerCase()));
          }
          break;
          
        case 'history':
          // 历史处理：当前用户已审核的申请
          filtered = creditApplications.filter(item => 
            (item.preReviewer === '审核员' || item.finalReviewer === '审核员')
          );
          // 商户邮箱和商户名称模糊搜索
          let emailFilterHistory = document.querySelector('#search-history input[placeholder="输入商户邮箱"]').value.trim();
          let nameFilterHistory = document.querySelector('#search-history input[placeholder="输入商户名称"]').value.trim();
          if(emailFilterHistory) {
            filtered = filtered.filter(item => item.email.toLowerCase().includes(emailFilterHistory.toLowerCase()));
          }
          if(nameFilterHistory) {
            filtered = filtered.filter(item => item.merchantName.toLowerCase().includes(nameFilterHistory.toLowerCase()));
          }
          let resultFilter = document.getElementById('searchResultHistory').value;
          if(resultFilter) {
            filtered = filtered.filter(item => item.status === resultFilter);
          }
          break;
          
        case 'all':
          // 全部：所有申请
          filtered = [...creditApplications];
          let statusFilterAll = document.getElementById('searchStatusAll').value;
          if(statusFilterAll) {
            filtered = filtered.filter(item => item.status === statusFilterAll);
          }
          break;
      }
      
      let total = filtered.length;
      let pageCount = Math.ceil(total/pageSize);
      if(currentPage>pageCount) currentPage=pageCount||1;
      let start = (currentPage-1)*pageSize;
      let end = start+pageSize;
      let pageData = filtered.slice(start,end);
      pageData.forEach((item, idx) => {
        let statusText = '';
        let statusClass = '';
        if(item.status === 'pre-review') { statusText = '待初审'; statusClass = 'status-pending'; }
        else if(item.status === 'final-review') { statusText = '待终审'; statusClass = 'status-pending'; }
        else if(item.status === 'approved') { statusText = '审核通过'; statusClass = 'status-approved'; }
        else if(item.status === 'rejected') { statusText = '审核不通过'; statusClass = 'status-rejected'; }
        let opBtns = '';
        
        // 根据不同Tab显示不同操作
        switch(currentTab) {
          case 'my-applications':
            // 我发起的：详情 + 撤销（未审批完成）
            opBtns = `<button class='btn btn-secondary btn-small' onclick="openDetail(${start+idx})">详情</button>`;
            if(item.status==='pre-review' || item.status==='final-review'){
              opBtns += ` <button class='btn btn-danger btn-small' onclick="revokeApplication(${start+idx})">撤销</button>`;
            }
            break;
            
          case 'pending-review':
            // 待审核：统一文案"审核"，根据ADS/BPS展示不同内容
            if(item.status==='pre-review' || item.status==='final-review'){
              opBtns = `<button class='btn btn-primary btn-small' onclick="openAuditModal(${start+idx})">审核</button>`;
            }
            opBtns += ` <button class='btn btn-secondary btn-small' onclick="openDetail(${start+idx})">详情</button>`;
            break;
            
          case 'history':
            // 历史处理：只能查看详情
            opBtns = `<button class='btn btn-secondary btn-small' onclick="openDetail(${start+idx})">详情</button>`;
            break;
            
          case 'all':
            // 全部：只能查看详情
            opBtns = `<button class='btn btn-secondary btn-small' onclick="openDetail(${start+idx})">详情</button>`;
            break;
        }
        // 根据Tab决定是否显示申请人字段
        let applicantCell = currentTab === 'my-applications' ? '' : `<td>${item.applicant}</td>`;
        tbody.innerHTML += `
          <tr>
            <td class="sticky-col sticky-email">${item.email}</td>
            <td class="sticky-col sticky-name">${item.merchantName}</td>
            <td><span class="business-tag">${item.business}</span></td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            ${applicantCell}
            <td>${item.applyTime}</td>
            <td class="remark-cell" data-remark="${item.remark}">${item.remark.length>8?item.remark.slice(0,8)+'...':item.remark}</td>
            <td>${item.preReviewer||'-'}</td>
            <td>${item.preReviewTime||'-'}</td>
            <td class="remark-cell" data-remark="${item.preReviewRemark||''}">${item.preReviewRemark?(item.preReviewRemark.length>8?item.preReviewRemark.slice(0,8)+'...':item.preReviewRemark):'-'}</td>
            <td>${item.finalReviewer||'-'}</td>
            <td>${item.finalReviewTime||'-'}</td>
            <td class="remark-cell" data-remark="${item.finalReviewRemark||''}">${item.finalReviewRemark?(item.finalReviewRemark.length>8?item.finalReviewRemark.slice(0,8)+'...':item.finalReviewRemark):'-'}</td>
            <td class="sticky-col sticky-op" style="right:0;left:auto;"><div class="action-buttons">${opBtns}</div></td>
          </tr>
        `;
      });
      // 重新绑定tooltip
      document.querySelectorAll('.remark-cell').forEach(cell => {
        cell.addEventListener('mouseenter', function(e) {
          const remarkText = this.getAttribute('data-remark');
          tooltip.textContent = remarkText;
          tooltip.classList.add('show');
          updateTooltipPosition(e);
        });
        cell.addEventListener('mousemove', function(e) { updateTooltipPosition(e); });
        cell.addEventListener('mouseleave', function() { tooltip.classList.remove('show'); });
      });
      // 分页控件
      let pager = document.getElementById('pager');
      if(!pager){
        pager = document.createElement('div');
        pager.id = 'pager';
        pager.style='margin:16px 0;text-align:center;';
        document.querySelector('.table-container').appendChild(pager);
      }
      pager.innerHTML = '';
      if(pageCount>1){
        for(let i=1;i<=pageCount;i++){
          pager.innerHTML += `<button class='btn btn-small' style='margin:0 2px;${i===currentPage?'background:#2563eb;color:#fff;':''}' onclick='gotoPage(${i})'>${i}</button>`;
        }
      }
    }
    window.gotoPage = function(p){currentPage=p;renderTable();}

    // 审核弹窗逻辑
    let currentAuditIdx = null, currentAuditStage = '', currentAuditAction = '';
    function openAudit(idx, action, stage) {
      currentAuditIdx = idx;
      currentAuditStage = stage;
      currentAuditAction = action;
      document.getElementById('auditModal').classList.add('show');
      const title = document.getElementById('auditModalTitle');
      const submitBtn = document.getElementById('auditSubmitBtn');
      if(stage==='pre') {
        title.textContent = (action==='approve'?'初审通过':'初审拒绝')+'信用额度申请';
      } else {
        title.textContent = (action==='approve'?'终审通过':'终审拒绝')+'信用额度申请';
      }
      submitBtn.textContent = (action==='approve'?'确认通过':'确认拒绝');
      submitBtn.className = action==='approve'?'btn btn-success':'btn btn-danger';
    }
    document.getElementById('auditForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const remark = this.auditComment.value;
      const now = new Date();
      const timeStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0') + ' ' + String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
      const user = '审核员';
      let item = creditApplications[currentAuditIdx];
      if(currentAuditStage==='pre') {
        item.preReviewer = user;
        item.preReviewTime = timeStr;
        item.preReviewRemark = remark;
        if(currentAuditAction==='approve') item.status = 'final-review';
        else item.status = 'rejected';
      } else {
        item.finalReviewer = user;
        item.finalReviewTime = timeStr;
        item.finalReviewRemark = remark;
        if(currentAuditAction==='approve') item.status = 'approved';
        else item.status = 'rejected';
      }
      renderTable();
      closeModal('auditModal');
      this.reset();
    });

    // 详情弹窗
    function openDetail(idx) {
      const item = creditApplications[idx];
      let html = '';
      html += `<div style='padding:10px 0;'>`;
      html += `<b>商户邮箱：</b>${item.email}<br/>`;
      html += `<b>商户名称：</b>${item.merchantName}<br/>`;
      html += `<b>资金账户：</b>${item.business}<br/>`;
      if(item.business==='ADS'){
        html += `<div style='background:#fef3c7; padding:10px; border-radius:6px; margin:10px 0;'>`;
        html += `<b style='color:#374151;'>新增额度设置信息：</b><br/>`;
        html += `<span style='color:#f59e0b;font-weight:bold;'>设定信用额度：${item.newCredit}</span><br/>`;
        html += `<span>单笔额度：${item.singleLimitAmount}</span><br/>`;
        html += `<span>单日额度：${item.dailyLimitAmount}</span><br/>`;
        html += `</div>`;
        html += `<div style='background:#f8fafc;padding:10px;border-radius:6px;margin:10px 0;'>`;
        html += `<b>结算设置：</b><br/>`;
        html += `<span>申请结算周期：${item.period==='natural_week'?'自然周':item.period==='natural_month'?'自然月':'自定义'}</span><br/>`;
        if(item.period==='custom'){
          html += `<span>开始日期：${item.startDate||'-'}</span><br/>`;
          html += `<span>结算周期天数：${item.customPeriodDays||'-'}天</span><br/>`;
        }
        html += `<span>账期：${item.periodDays}天，宽限期：${item.gracePeriod}天</span>`;
        html += `</div>`;
      } else {
        html += `<div style='background:#f8fafc; padding:10px; border-radius:6px; margin:10px 0;'>`;
        html += `<b style='color:#374151;'>当前额度信息：</b><br/>`;
        html += `<span>当前信用额度：${item.currentCredit}</span><br/>`;
        html += `<span>当前单日额度：${item.dailyLimitAmount||'-'}</span><br/>`;
        html += `<span>当前单笔额度：${item.singleLimitAmount||'-'}</span><br/>`;
        html += `</div>`;
        html += `<div style='background:#fef3c7; padding:10px; border-radius:6px; margin:10px 0;'>`;
        html += `<b style='color:#374151;'>调整后额度：</b><br/>`;
        html += `<span style='color:#f59e0b;font-weight:bold;'>新的信用额度：${item.newCredit}</span><br/>`;
        html += `<span>新的单日额度：${item.dailyLimitAmount}</span><br/>`;
        html += `<span>新的单笔额度：${item.singleLimitAmount}</span><br/>`;
        html += `</div>`;
      }
      html += `<b>申请备注：</b>${item.remark||'-'}<br/>`;
      if(item.files && item.files.length){
        html += `<b>资料：</b><br/>` + item.files.map(f=>`<a href='${f.url}' download>${f.name}</a>`).join('<br/>') + `<br/>`;
      }
      html += `<b>申请人：</b>${item.applicant}<br/>`;
      html += `<b>申请时间：</b>${item.applyTime}<br/>`;
      html += `<b>审核状态：</b>${item.status==='pre-review'?'待初审':item.status==='final-review'?'待终审':item.status==='approved'?'审核通过':'审核不通过'}<br/>`;
      if(item.preReviewer){
        html += `<b>初审人：</b>${item.preReviewer}<br/>`;
        html += `<b>初审时间：</b>${item.preReviewTime}<br/>`;
        html += `<b>初审备注：</b>${item.preReviewRemark}<br/>`;
      }
      if(item.finalReviewer){
        html += `<b>终审人：</b>${item.finalReviewer}<br/>`;
        html += `<b>终审时间：</b>${item.finalReviewTime}<br/>`;
        html += `<b>终审备注：</b>${item.finalReviewRemark}<br/>`;
      }
      html += `</div>`;
      document.querySelector('#detailModal .modal-content').innerHTML = `
        <div class="modal-header">
          <h2 class="modal-title">信用额度申请详情</h2>
          <button class="close-btn" onclick="closeModal('detailModal')">&times;</button>
        </div>
        ${html}
        <div style="display:flex; gap:15px; justify-content:flex-end; margin-top:30px;">
          <button class="btn btn-secondary" onclick="closeModal('detailModal')">关闭</button>
        </div>
      `;
      document.getElementById('detailModal').classList.add('show');
    }

    // 表格横向滚动
    document.querySelector('.table-wrapper').style.overflowX = 'auto';
    document.querySelector('.credit-table').style.minWidth = '2000px';
    // 初始化渲染
    renderTable();

    // 新审核弹窗结构
    function renderAuditModal(idx, stage) {
      const item = creditApplications[idx];
      let html = '';
      html += `<div style='padding:10px 0;'>`;
      html += `<b>商户邮箱：</b>${item.email}<br/>`;
      html += `<b>商户名称：</b>${item.merchantName}<br/>`;
      html += `<b>资金账户：</b>${item.business}<br/>`;
      if(item.business==='ADS'){
        html += `<div style='background:#fef3c7; padding:10px; border-radius:6px; margin:10px 0;'>`;
        html += `<b>新增额度设置信息：</b><br/>`;
        html += `<span>设定信用额度：${item.newCredit}</span><br/>`;
        html += `<span>单笔额度：${item.singleLimitAmount}</span><br/>`;
        html += `<span>单日额度：${item.dailyLimitAmount}</span><br/>`;
        html += `</div>`;
        html += `<div style='background:#f8fafc; padding:10px; border-radius:6px; margin:10px 0;'>`;
        html += `<b>结算设置：</b><br/>`;
        html += `<span>申请结算周期：${item.period==='natural_week'?'自然周':item.period==='natural_month'?'自然月':'自定义'}</span><br/>`;
        if(item.period==='custom'){
          html += `<span>开始日期：${item.startDate||'-'}</span><br/>`;
          html += `<span>结算周期天数：${item.customPeriodDays||'-'}天</span><br/>`;
        }
        html += `<span>账期：${item.periodDays}天，宽限期：${item.gracePeriod}天</span>`;
        html += `</div>`;
      } else {
        html += `<div style='background:#f8fafc; padding:10px; border-radius:6px; margin:10px 0;'>`;
        html += `<b>当前额度信息：</b><br/>`;
        html += `<span>当前信用额度：${item.currentCredit}</span><br/>`;
        html += `<span>当前单日额度：${item.dailyLimitAmount||'-'}</span><br/>`;
        html += `<span>当前单笔额度：${item.singleLimitAmount||'-'}</span><br/>`;
        html += `</div>`;
        html += `<div style='background:#fef3c7; padding:10px; border-radius:6px; margin:10px 0;'>`;
        html += `<b>调整后额度：</b><br/>`;
        html += `<span>新的信用额度：${item.newCredit}</span><br/>`;
        html += `<span>新的单日额度：${item.dailyLimitAmount}</span><br/>`;
        html += `<span>新的单笔额度：${item.singleLimitAmount}</span><br/>`;
        html += `</div>`;
      }
      html += `<b>申请备注：</b>${item.remark||'-'}<br/>`;
      if(item.files && item.files.length){
        html += `<b>资料：</b><br/>` + item.files.map(f=>`<a href='${f.url}' download>${f.name}</a>`).join('<br/>') + `<br/>`;
      }
      html += `</div>`;
      html += `<form id='auditForm' style='margin-top:10px;'>`;
      html += `<div class='form-group'><label>审核结果 *</label><br/>
        <label style='margin-right:20px;'><input type='radio' name='auditResult' value='approve'> 通过</label>
        <label><input type='radio' name='auditResult' value='reject'> 不通过</label>
      </div>`;
      html += `<div class='form-group'><label>审核备注 *</label><textarea class='form-input' name='auditRemark' rows='3' required placeholder='请填写审核备注'></textarea></div>`;
      html += `<div style='display:flex;gap:15px;justify-content:flex-end;margin-top:20px;'>
        <button type='button' class='btn btn-secondary' onclick='closeAuditModal()'>取消</button>
        <button type='submit' class='btn btn-primary'>提交</button>
      </div>`;
      html += `</form>`;
      return html;
    }

    // 打开审核弹窗
    window.openAuditModal = function(idx, stage) {
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.id = 'customAuditModal';
      modal.innerHTML = `<div class='modal-content' style='max-width:600px;'>
        <div class='modal-header'><h2 class='modal-title'>审核</h2><button class='close-btn' onclick='closeAuditModal()'>&times;</button></div>
        ${renderAuditModal(idx)}
      </div>`;
      document.body.appendChild(modal);
      // 表单校验
      modal.querySelector('#auditForm').onsubmit = function(e) {
        e.preventDefault();
        const result = modal.querySelector('input[name="auditResult"]:checked');
        const remark = modal.querySelector('textarea[name="auditRemark"]').value.trim();
        if(!result) { alert('请选择审核结果'); return; }
        if(!remark) { alert('请填写审核备注'); return; }
        // 保存审核结果
        const cur = creditApplications[idx].status;
        if(cur==='pre-review'){
          creditApplications[idx].preReviewResult = result.value;
          creditApplications[idx].preReviewRemark = remark;
          creditApplications[idx].preReviewer = '审核员';
          creditApplications[idx].preReviewTime = new Date().toLocaleString();
          creditApplications[idx].status = result.value==='approve' ? 'final-review' : 'rejected';
        } else if(cur==='final-review'){
          creditApplications[idx].finalReviewResult = result.value;
          creditApplications[idx].finalReviewRemark = remark;
          creditApplications[idx].finalReviewer = '审核员';
          creditApplications[idx].finalReviewTime = new Date().toLocaleString();
          creditApplications[idx].status = result.value==='approve' ? 'approved' : 'rejected';
        }
        renderTable();
        closeAuditModal();
      };
      // 关闭弹窗点击遮罩
      modal.onclick = function(e){ if(e.target===modal) closeAuditModal(); };
    }
    window.closeAuditModal = function() {
      const m = document.getElementById('customAuditModal');
      if(m) m.remove();
    }
    // 撤销申请
    window.revokeApplication = function(idx){
      if(!confirm('确认撤销该申请吗？')) return;
      creditApplications.splice(idx,1);
      renderTable();
    }

    // 初始化商户下拉
    (function initMerchantSelect(){
      const sel = document.getElementById('merchantSelect');
      if(!sel) return;
      // 清空并填充
      while(sel.options.length>1){ sel.remove(1); }
      merchants.forEach(m=>{
        const opt = document.createElement('option');
        opt.value = m.accountId;
        opt.textContent = `${m.merchantName} (${m.email})`;
        opt.dataset.email = m.email;
        opt.dataset.name = m.merchantName;
        sel.appendChild(opt);
      });
    })();

    // 商户选择联动隐藏域与信息展示
    const merchantSelectEl = document.getElementById('merchantSelect');
    merchantSelectEl?.addEventListener('change', function(){
      const selected = this.options[this.selectedIndex];
      const accountId = this.value || '';
      const email = selected?.dataset.email || '';
      const name = selected?.dataset.name || '';
      document.querySelector('#applyForm input[name="accountId"]').value = accountId;
      document.querySelector('#applyForm input[name="email"]').value = email;
      document.querySelector('#applyForm input[name="merchantName"]').value = name;
      // 更新信息块
      const adsName = document.getElementById('adsMerchantName');
      const bpsName = document.getElementById('bpsMerchantName');
      if(adsName) adsName.textContent = name || '-';
      if(bpsName) bpsName.textContent = name || '-';
    });

    // 资金账户切换：显示对应表单，并设置必填
    const fundSelect = document.getElementById('fundAccountSelect');
    function toggleADSRequired(enabled){
      ['adsCreditLimit','adsDailyLimit','adsSingleLimit','adsRemark','adsFiles','cycleTypeSelect','accountPeriodDays','gracePeriodDays']
        .forEach(id=>{ const el = document.getElementById(id); if(el){ if(enabled) el.setAttribute('required',''); else el.removeAttribute('required'); }});
      // 自定义时的必填项在切换时一起调整
      ['settlementStartDate','settlementPeriodDays'].forEach(id=>{ const el=document.getElementById(id); if(el){ if(enabled && document.getElementById('cycleTypeSelect')?.value==='custom'){ el.setAttribute('required',''); } else { el.removeAttribute('required'); }}});
    }
    function toggleBPSRequired(enabled){
      ['bpsNewCredit','bpsNewDaily','bpsNewSingle','bpsRemark','bpsFiles']
        .forEach(id=>{ const el = document.getElementById(id); if(el){ if(enabled) el.setAttribute('required',''); else el.removeAttribute('required'); }});
    }
    fundSelect?.addEventListener('change', function(){
      const v = this.value;
      const ads = document.getElementById('adsForm');
      const bps = document.getElementById('bpsForm');
      if(v==='ADS'){
        ads.style.display = 'block';
        bps.style.display = 'none';
        toggleADSRequired(true);
        toggleBPSRequired(false);
        document.getElementById('adsFundAccount').textContent = 'ADS';
      } else if(v==='BPS'){
        ads.style.display = 'none';
        bps.style.display = 'block';
        toggleADSRequired(false);
        toggleBPSRequired(true);
        document.getElementById('bpsFundAccount').textContent = 'BPS';
      } else {
        ads.style.display = 'none';
        bps.style.display = 'none';
        toggleADSRequired(false);
        toggleBPSRequired(false);
      }
    });

    // ADS：结算周期联动与可视化
    const cycleTypeSelect = document.getElementById('cycleTypeSelect');
    function updateCycleVisualization(){
      const cycleType = cycleTypeSelect?.value || '';
      const accountDays = parseInt(document.getElementById('accountPeriodDays')?.value || '0',10) || 0;
      const graceDays = parseInt(document.getElementById('gracePeriodDays')?.value || '0',10) || 0;
      let cycleDays = 0;
      if(cycleType === 'natural_week') cycleDays = 7;
      else if(cycleType === 'natural_month') cycleDays = 30;
      else if(cycleType === 'custom') cycleDays = parseInt(document.getElementById('settlementPeriodDays')?.value || '0',10) || 0;
      const total = Math.max(1, cycleDays + accountDays + graceDays);
      const pCycle = Math.round(cycleDays/total*100);
      const pAccount = Math.round(accountDays/total*100);
      const pGrace = Math.max(0, 100 - pCycle - pAccount);
      const segCycle = document.getElementById('segmentCycle');
      const segAccount = document.getElementById('segmentAccount');
      const segGrace = document.getElementById('segmentGrace');
      if(segCycle) segCycle.style.width = pCycle + '%';
      if(segAccount) segAccount.style.width = pAccount + '%';
      if(segGrace) segGrace.style.width = pGrace + '%';

      // 计算并显示日期范围与天数
      function fmt(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
      function clone(d){ return new Date(d.getTime()); }
      function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
      function getMonday(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; }
      const today = new Date();
      let start = new Date();
      if(cycleType==='natural_week'){ start = getMonday(today); }
      else if(cycleType==='natural_month'){ start = new Date(today.getFullYear(), today.getMonth(), 1); }
      else if(cycleType==='custom'){
        const sd = document.getElementById('settlementStartDate')?.value;
        start = sd ? new Date(sd) : today;
      }
      start.setHours(0,0,0,0);
      const cycleEnd = cycleDays>0 ? addDays(start, cycleDays-1) : clone(start);
      const accountStart = addDays(cycleEnd, 1);
      const accountEnd = accountDays>0 ? addDays(accountStart, accountDays-1) : clone(accountStart);
      const graceStart = addDays(accountEnd, 1);
      const graceEnd = graceDays>0 ? addDays(graceStart, graceDays-1) : clone(graceStart);
      const segCycleLabel = document.getElementById('segCycleLabel');
      const segAccountLabel = document.getElementById('segAccountLabel');
      const segGraceLabel = document.getElementById('segGraceLabel');
      if(segCycleLabel) segCycleLabel.textContent = cycleDays>0 ? `${fmt(start)} ~ ${fmt(cycleEnd)} (${cycleDays}天)` : '';
      if(segAccountLabel) segAccountLabel.textContent = accountDays>0 ? `${fmt(accountStart)} ~ ${fmt(accountEnd)} (${accountDays}天)` : '';
      if(segGraceLabel) segGraceLabel.textContent = graceDays>0 ? `${fmt(graceStart)} ~ ${fmt(graceEnd)} (${graceDays}天)` : '';
    }
    cycleTypeSelect?.addEventListener('change', function(){
      const customGroup = document.getElementById('customCycleGroup');
      if(this.value==='custom'){
        customGroup.style.display = 'block';
        document.getElementById('settlementStartDate')?.setAttribute('required','');
        document.getElementById('settlementPeriodDays')?.setAttribute('required','');
      } else {
        customGroup.style.display = 'none';
        document.getElementById('settlementStartDate')?.removeAttribute('required');
        document.getElementById('settlementPeriodDays')?.removeAttribute('required');
      }
      updateCycleVisualization();
    });
    ['accountPeriodDays','gracePeriodDays','settlementPeriodDays'].forEach(id=>{
      document.getElementById(id)?.addEventListener('input', updateCycleVisualization);
    });

    // ADS：推荐人显示
    Array.from(document.querySelectorAll('input[name="adsHasReferrer"]')).forEach(r=>{
      r.addEventListener('change', function(){
        document.getElementById('adsReferrerGroup').style.display = this.value==='yes' ? 'block' : 'none';
      });
    });

    // 提交表单
    const applyFormEl = document.getElementById('applyForm');
    applyFormEl?.addEventListener('submit', function(e){
      e.preventDefault();
      const merchantOption = merchantSelectEl.options[merchantSelectEl.selectedIndex];
      const merchantName = merchantOption?.dataset.name || '';
      const email = merchantOption?.dataset.email || '';
      const accountId = merchantSelectEl.value || '';
      const fund = fundSelect.value;
      if(!merchantName || !fund){ alert('请选择商户与资金账户'); return; }
      const now = new Date();
      const timeStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0') + ' ' + String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');

      // 文件处理工具
      function extractFiles(inputId){
        const files = Array.from(document.getElementById(inputId)?.files || []).slice(0,10);
        return files.map(f=>({name:f.name,url:'#'}));
      }

      let newItem = {
        accountId: accountId,
        email: email,
        merchantName: merchantName,
        business: fund, // 在列表"子业务名称"列展示 ADS/BPS
        status: 'pre-review',
        applyTime: timeStr,
        preReviewer: '', preReviewTime: '', preReviewRemark: '',
        finalReviewer: '', finalReviewTime: '', finalReviewRemark: '',
        applicant: '当前用户',
        files: [],
        remark: ''
      };

      if(fund === 'ADS'){
        // 新增信用额度申请
        const credit = parseInt(document.getElementById('adsCreditLimit').value || '0',10);
        const daily = parseInt(document.getElementById('adsDailyLimit').value || '0',10);
        const single = parseInt(document.getElementById('adsSingleLimit').value || '0',10);
        const cycleType = document.getElementById('cycleTypeSelect').value;
        const accountDays = parseInt(document.getElementById('accountPeriodDays').value || '0',10);
        const graceDays = parseInt(document.getElementById('gracePeriodDays').value || '0',10);
        const startDate = document.getElementById('settlementStartDate')?.value || null;
        const customDays = document.getElementById('settlementPeriodDays')?.value ? parseInt(document.getElementById('settlementPeriodDays').value,10) : null;

        newItem.currentCredit = 0;
        newItem.usedCredit = 0;
        newItem.remainingCredit = 0;
        newItem.newCredit = credit;
        newItem.singleLimitType = 'limited';
        newItem.singleLimitAmount = single;
        newItem.dailyLimitType = 'limited';
        newItem.dailyLimitAmount = daily;
        newItem.currentPeriod = cycleType==='natural_week' ? '自然周' : (cycleType==='natural_month' ? '自然月' : '自定义');
        newItem.currentGracePeriod = graceDays;
        newItem.period = cycleType;
        newItem.periodDays = accountDays;
        newItem.gracePeriod = graceDays;
        newItem.startDate = cycleType==='custom' ? startDate : null;
        newItem.customPeriodDays = cycleType==='custom' ? customDays : null;
        newItem.remark = document.getElementById('adsRemark').value.trim();
        newItem.files = extractFiles('adsFiles');

        // 额外信息（可选）
        const hasRef = Array.from(document.querySelectorAll('input[name="adsHasReferrer"]')).find(x=>x.checked)?.value === 'yes';
        newItem.hasReferrer = hasRef ? 'yes' : 'no';
        newItem.referrer = hasRef ? (document.getElementById('adsReferrerName').value || '') : '';
        newItem.website = document.getElementById('adsWebsite').value || '';
        newItem.monthlyRevenue = document.getElementById('adsMonthlyRevenue').value || '';
        newItem.monthlySales = document.getElementById('adsMonthlySales').value || '';
        newItem.totalProfit = document.getElementById('adsTotalProfit').value || '';
      } else if(fund === 'BPS'){
        // 调整信用额度申请
        const newCredit = parseInt(document.getElementById('bpsNewCredit').value || '0',10);
        const newDaily = parseInt(document.getElementById('bpsNewDaily').value || '0',10);
        const newSingle = parseInt(document.getElementById('bpsNewSingle').value || '0',10);

        newItem.currentCredit = parseInt(document.getElementById('bpsCurrentCredit').value || '0',10);
        newItem.usedCredit = 0;
        newItem.remainingCredit = 0;
        newItem.newCredit = newCredit;
        newItem.singleLimitType = 'limited';
        newItem.singleLimitAmount = newSingle;
        newItem.dailyLimitType = 'limited';
        newItem.dailyLimitAmount = newDaily;
        newItem.currentPeriod = '自然月';
        newItem.currentGracePeriod = 15;
        newItem.period = 'natural_month';
        newItem.periodDays = 30;
        newItem.gracePeriod = 15;
        newItem.startDate = null;
        newItem.customPeriodDays = null;
        newItem.remark = document.getElementById('bpsRemark').value.trim();
        newItem.files = extractFiles('bpsFiles');
      } else {
        alert('请选择资金账户');
        return;
      }

      creditApplications.unshift(newItem);
      renderTable();
      closeModal('applyModal');
      this.reset();
      // 重置显示
      document.getElementById('adsForm').style.display = 'none';
      document.getElementById('bpsForm').style.display = 'none';
    });
  </script>
</body>
</html> 