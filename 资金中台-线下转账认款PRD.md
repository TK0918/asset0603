# 项目名称：资金中台-线下转账认款

## 1. 项目概述
### 1.1 项目背景
- 我司主营跨境电商，为跨境客户提供供应链、广告、物流等业务；同一客户在不同业务模块拥有独立资金账户。
- 资金中台用于统一管理客户资金流水，支持各业务线资金充值与消费。
- 入账方式包含在线充值（已对接 PayPal、Stripe）与线下转账。线下转账手续费更低、客户使用最广，但当前人工识别收款账户和交易，成本高易错。
- 拟通过“支付平台交易同步 + 客户提交凭证 + 系统匹配 + 财务确认”的方案实现高效、可追溯的线下转账认款流程。

### 1.2 项目目标
- 降低人工匹配成本与差错率，确保“每笔交易仅入账一次”。
- 建立全账户收款明细池，支持自动/人工匹配与认领。
- 以支付平台同步交易为准，剔除在线充值交易，避免重复入账。
- 财务最终确认入账，系统仅提供匹配建议与对账辅助。

### 1.3 目标用户
- 财务人员（审核与最终确认）。
- 客户经理（查看状态与协助客户）。
- 客户（提交线下转账凭证，查看处理状态）。
- 运维/管理员（配置收款账户、调整匹配策略）。

## 2. 功能需求
### 2.1 核心功能
- 收款账户配置（Wise、PayPal、Stripe、Airwallex、Payoneer、PingPong 等）。
- 全账户收款明细（统一视图 + 明细弹窗/详情页 + 手动上传Excel）。
- 认款匹配引擎（自动匹配、候选多选、未匹配列队，排除在线充值）。
- 财务确认页面（系统建议结果审核、人工认领、确认入账、冲销回退）。

### 2.2 功能详细描述
#### 2.2.1 收款账户配置
[业务流程]
- 新增/编辑/停用收款账户，存储各平台所需鉴权与标识；定时任务据此拉取交易并入池。

[功能说明]
- 支持多平台多账户；支持启用状态切换；支持鉴权测试；敏感信息脱敏展示。

[页面描述]
- 页面：账户配置列表 + 新建/编辑侧边抽屉/弹窗；“鉴权测试”按钮即时校验。

[字段明细]
- 通用字段：平台、账户别名、账户ID/邮箱、状态(启用/停用)、创建时间、最近同步时间、负责人。
- 平台特定字段（示例）：
  - PayPal：Client ID、Client Secret、Webhook ID、接收邮箱。
  - Stripe：API Key、账户ID(Account ID)、Webhook Secret。
  - Wise：API Token、Profile ID、Account ID。
  - Airwallex：Client ID、API Key、Merchant ID。
  - Payoneer：Program ID、API Key/Secret。
  - PingPong：API Key、Merchant/Account ID。

[操作交互]
- 新建/编辑/停用/删除、鉴权测试、立即同步一次、查看同步日志（拉取条数/耗时/错误）。


#### 2.2.2 全账户收款明细
[业务流程]
- 定时任务按账户配置拉取交易 → 标准化 → 去重/合并 → 剔除在线充值 → 进入“待认领池”。
- 人工上传Excel明细合并入池，标记来源为“手动”。

[功能说明]
- 统一列表展示核心字段与状态；支持明细页/弹窗展示平台原始字段；支持导出与去重标记。
- 不支持API的平台，提供Excel模板下载、手动上传并校验。

[页面描述]
- 列表 + 详情弹窗/页；支持批量选择标记“已认领/取消认领”（仅状态，不影响入账，入账由财务确认页执行）。

[筛选字段（表格）]

| 筛选项 | 类型 | 说明 |
| --- | --- | --- |
| 平台 | 下拉多选 | Wise/PayPal/Stripe/Airwallex/Payoneer/PingPong/手动 |
| 账户 | 下拉 | 依据平台过滤 |
| 交易时间 | 时间范围 | 平台交易创建时间 |
| 币种 | 下拉 | ISO 货币码，如 USD/EUR/CNY |
| 金额范围 | 数字区间 | 统一以交易币种展示与筛选 |
| 状态 | 下拉 | 待认领/已部分认领/已认领/已入账/已排除 |
| 来源 | 下拉 | API/手动上传 |
| 是否在线充值 | 单选 | 是/否（默认“否”）|
| 交易ID/对方账户 | 文本 | 精确/模糊匹配 |

[列表字段（表格）]

| 字段 | 说明 |
| --- | --- |
| 平台 | 支付/收款平台标识 |
| 账户 | 我司收款账户别名/ID |
| 交易时间 | 平台侧时间(UTC) |
| 交易ID | 平台唯一标识（可为空）|
| 对方名称/账号 | 付款方名/邮箱/账号标识 |
| 交易币种 | ISO 货币码 |
| 交易金额 | 正负号按平台原始方向（入账统一转正）|
| 手续费 | 平台扣费（如有）|
| 备注/附言 | 付款用途/Reference/UTR/备注 |
| 来源 | API/手动 |
| 匹配状态 | 未匹配/多候选/已匹配 |
| 认领状态 | 待认领/部分/已认领/已入账/已排除 |
| 操作 | 查看明细/标记排除/下载原始回单 |

[Excel 上传模板要求]
- 必填：平台、账户、交易时间(ISO或yyyy-MM-dd HH:mm:ss)、交易币种、交易金额、对方名称/账号；可选：交易ID、手续费、备注。
- 文件校验：必填列、时间/金额格式、币种码、行内重复；支持失败报告下载。

[操作交互]
- 查看明细（弹窗显示平台原始字段JSON视图+规范化字段对照）。
- 标记排除（原因：在线充值重复/测试交易/错误录入）。
- 批量操作（仅状态标记，不执行入账）。


#### 2.2.3 认款匹配规则
[业务流程]
- 客户提交线下转账申请（平台+交易ID可选+金额+币种+时间范围+凭证文件）→ 系统在“收款明细池”中进行匹配 → 输出匹配结果与置信度 → 进入财务确认。

[匹配策略（多层级，命中即收敛）]
1) 精确匹配：平台一致 AND 交易ID全等（最优）。
2) 强特征匹配：
   - 平台一致 AND 交易时间落入客户申报的±T窗口（默认±3天，可配置）AND 金额/币种全等。
   - 平台一致 AND 金额/币种全等 AND 对方账户标识（邮箱/账号/卡号后4位/IBAN片段/UTR）模糊命中。
3) 弱特征加权：
   - 付款备注/Reference/用途 模糊匹配客户填写的附言/订单号。
   - 付款方名称模糊匹配客户主体或联系人名。
   - 同一平台同一日同额重复出现时，优先对齐对方账号/UTR最接近的一笔。
4) 规则兜底：
   - 多候选：生成候选列表，按评分降序供财务选择。
   - 未匹配：进入待匹配队列，支持后续自动重扫（新交易同步/时间窗口扩展）。

[注意与排除]
- 必须剔除“在线充值”的交易单：
  - 依据交易来源字段(channel/source)标记为“online_topup”；
  - 或依据我司在线充值订单号在平台回单中的Reference/Metadata做关联排除；
  - 或依据平台为我司发起的收单通道（如Stripe PaymentIntent/Checkout）标记排除。
- 去重原则：同平台同交易ID仅保留一条；跨平台不合并；手动上传与API重复时保留API并标记手动行“被合并”。

[评分模型（建议实现）]
- 交易ID一致：+70；金额一致：+20；币种一致：+5；时间窗口内：+10→偏离每1天-2；对方账号模糊命中：+10；备注命中：+5。≥80视为高置信，50-79中置信，<50低置信。


#### 2.2.4 财务确认页面
[业务流程]
- 展示“系统建议匹配结果”（高/中/低置信）与“未匹配的客户申请”；财务可在“待认领交易”中人工指派匹配；确认后落账到指定客户资金账户（系统不自动入账）。

[页面描述]
- 左侧：客户线下转账申请列表；右侧：系统候选交易/已选交易与凭证预览；顶部批量操作（仅勾选已选中的申请）。

[筛选字段（表格）]

| 筛选项 | 类型 | 说明 |
| --- | --- | --- |
| 申请状态 | 下拉 | 待确认/已确认/已拒绝 |
| 置信等级 | 下拉 | 高/中/低/未匹配 |
| 平台 | 下拉 | 与客户申报平台一致或全部 |
| 客户主体 | 文本/下拉 | 主体ID/名称/邮箱 |
| 申请时间 | 时间范围 | 提交时间 |
| 业务线 | 下拉 | Advertising/Fulfillment… |

[列表字段（表格）]

| 字段 | 说明 |
| --- | --- |
| 申请单号 | 系统生成 |
| 客户主体 | 主体ID/名称/邮箱 |
| 业务线/钱包 | 目标钱包标识 |
| 申报平台 | 客户选择的平台 |
| 申报币种/金额 | 客户申报 |
| 申报时间范围 | 客户申报的预计到账窗口 |
| 匹配状态/置信度 | 未匹配/多候选/已匹配，高/中/低 |
| 已选交易摘要 | 平台/账户/交易ID/时间/金额 |
| 审核状态 | 待确认/已确认/已拒绝 |
| 操作 | 查看/指派匹配/确认入账/拒绝/回退 |

[操作交互]
- 指派匹配：从候选池选择一笔交易；或从“未认领交易”检索并指派。
- 确认入账：
  - 必填入账信息：入账币种、入账金额（默认等于交易金额，可调整但需校验≤交易金额）、汇率(如需跨币)、备注；
  - 二次确认弹窗，强调“每笔交易仅入账一次、入账不可逆（需冲销流程）”。
- 拒绝：必填原因，申请流转为“已拒绝”。
- 回退/冲销：对已确认记录提供冲销申请入口（独立审批，不在本PRD展开）。


### 2.3 用户流程
[Markdown 流程图]
```
客户提交线下转账申请(平台/金额/币种/时间/凭证)
        │
        ▼
匹配引擎：根据平台交易池进行匹配（排除在线充值）
        │                  ┌─────────────┐
        ├── 高置信/唯一匹配 ┤ 候选=1       ├─► 标记“已匹配(高)”
        │                  └─────────────┘
        │                  ┌─────────────┐
        ├── 多候选         ┤ 候选>1       ├─► 标记“多候选(中)”
        │                  └─────────────┘
        │                  ┌─────────────┐
        └── 未匹配         ┤ 候选=0       ├─► 标记“未匹配”
                           └─────────────┘
                              │
                              ▼
财务确认页面：查看申请 + 候选交易 + 凭证
  ├─ 选择/指派匹配
  ├─ 确认入账（写入资金账户变动 + 标记交易“已入账”）
  └─ 拒绝/回退（记录原因）
```


## 3. 非功能需求
### 3.1 性能要求
- 交易同步任务：单账户单次拉取≤60秒，失败重试指数退避；每日全量补偿扫描。
- 列表分页：默认20/页，最大100/页；筛选≤2秒返回（本地/后端缓存）。
- 匹配计算：新申请进入队列后≤10秒给出初步候选。

### 3.2 安全要求
- 鉴权信息加密存储，操作留痕（新增/编辑/停用/同步日志）。
- 文件上传：病毒与类型校验，单文件≤20MB，总量≤10个；敏感遮蔽展示。
- 权限隔离：仅财务可确认入账；客户仅可提交与查看自身申请。

### 3.3 可用性要求
- 支持中英文；异常可回溯（同步日志、匹配日志、操作日志）。
- Excel模板校验清晰的错误报告；所有关键操作二次确认。

## 4. 技术规格
### 4.1 技术栈
- 前端：现有HTML/CSS/JavaScript组件体系（可迁移到 Vue3 + TS + Element Plus）。
- 后端：同步与匹配服务（建议 Spring Boot + MQ），日志与审计（ELK/Cloud Logging）。
- 数据：MySQL 8 + Redis；对象存储（凭证文件）。

### 4.2 系统架构
- 组件：
  - 账户配置服务：存储平台账户与鉴权，提供同步任务参数。
  - 同步采集器：按平台调用API/回调，落库“收款明细池”。
  - 标准化与去重：统一字段、排除在线充值、去重与合并。
  - 匹配引擎：规则评分 + 候选集生成；日志可追溯。
  - 审核服务：财务确认入账、生成资金变动流水、幂等控制。

### 4.3 第三方集成
- 平台API：PayPal、Stripe、Wise、Airwallex、Payoneer、PingPong（按平台文档权限最小化申请）。
- Webhook/回调：对接事件回调补齐实时性；与在线充值通道共享“在线标记”以排除。

## 5. 交付：
### 5.1 里程碑
- M1（第2周）：收款账户配置页 + 鉴权测试 + 同步日志视图。
- M2（第5周）：收款明细池（API对接2个平台+手动Excel上传+详情）。
- M3（第7周）：匹配引擎V1（规则评分+多候选/未匹配列队）。
- M4（第9周）：财务确认页（指派匹配+确认入账+拒绝）。
- M5（第10周）：联调与试运行（幂等验证、日志审计、导出）。

### 5.2 时间线
- 总工期：10周；关键风险：平台API配额与权限申请周期、历史数据补采耗时。

### 5.3 验收标准
- 用例通过率≥95%，异常回滚覆盖≥90%。
- 去重与“在线充值排除”准确率≥99.9%。
- 高置信自动候选命中率≥85%，人工确认≤2步完成。
- 全链路留痕可审计（账户操作/同步/匹配/确认）。


---

## 附：交互要点（全局）
- 系统不自动入账；财务确认后才写资金流水并标记交易“已入账”。
- 每笔平台交易仅能入账一次；入账时对平台交易ID加幂等锁。
- 任何“排除/合并/指派/确认/拒绝”均记录操作者、时间、原因。
- 明细页展示“原始字段(JSON)”与“标准化字段”双栏对照，便于核验。

